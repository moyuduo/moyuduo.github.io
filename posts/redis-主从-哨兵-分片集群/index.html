<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>redis-主从-哨兵-分片集群 | Moyuduo's Blog</title><meta name=keywords content><meta name=description content="redis主从、哨兵、分片集群 概念：
redis主从及哨兵
redis分片集群
单机 在redis安装目录下执行./src/redis-server redis.conf会在6379端口启动单机版redis 使用 python3:
安装依赖库:pip3 install redis
import redis conn = redis.StrictRedis(connection_pool=redis.ConnectionPool( host=&#34;127.0.0.1&#34;, port=&#34;6381&#34;, password=&#34;&#34; )) # string类型的写入读取 ret = conn.set(&#34;py-k1&#34;, &#34;py-v1&#34;) print(ret) val = conn.get(&#34;py-k1&#34;) print(val) 执行：
python3 single-redis.py True b'py-v1' 主从搭建 参考：
redis主从模式搭建
下载redis 去http://download.redis.io/releases/上下载对应版本的redis(本次使用redis-6.0.0) curl -O http://download.redis.io/releases/redis-6.0.0.tar.gz 解压tar -zxvf redis-6.0.0.tar.gz 进入文件夹cd redis-6.0.0 编译redis文件make 规划 Name Role IP Port master1 master 127.0.0.1 6379 slave1 slave 127.0.0.1 6380 slave2 slave 127.0.0.1 6381 准备配置文件 修改redis安装目录下的redis.conf文件daemonize为yes后台启动 拷贝redis."><meta name=author content="Me"><link rel=canonical href=https://moyuduo.github.io/posts/redis-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="redis-主从-哨兵-分片集群"><meta property="og:description" content="redis主从、哨兵、分片集群 概念：
redis主从及哨兵
redis分片集群
单机 在redis安装目录下执行./src/redis-server redis.conf会在6379端口启动单机版redis 使用 python3:
安装依赖库:pip3 install redis
import redis conn = redis.StrictRedis(connection_pool=redis.ConnectionPool( host=&#34;127.0.0.1&#34;, port=&#34;6381&#34;, password=&#34;&#34; )) # string类型的写入读取 ret = conn.set(&#34;py-k1&#34;, &#34;py-v1&#34;) print(ret) val = conn.get(&#34;py-k1&#34;) print(val) 执行：
python3 single-redis.py True b'py-v1' 主从搭建 参考：
redis主从模式搭建
下载redis 去http://download.redis.io/releases/上下载对应版本的redis(本次使用redis-6.0.0) curl -O http://download.redis.io/releases/redis-6.0.0.tar.gz 解压tar -zxvf redis-6.0.0.tar.gz 进入文件夹cd redis-6.0.0 编译redis文件make 规划 Name Role IP Port master1 master 127.0.0.1 6379 slave1 slave 127.0.0.1 6380 slave2 slave 127.0.0.1 6381 准备配置文件 修改redis安装目录下的redis.conf文件daemonize为yes后台启动 拷贝redis."><meta property="og:type" content="article"><meta property="og:url" content="https://moyuduo.github.io/posts/redis-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4/"><meta property="og:image" content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-27T16:16:14+08:00"><meta property="article:modified_time" content="2022-11-27T16:16:14+08:00"><meta property="og:site_name" content="Moyuduo's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="redis-主从-哨兵-分片集群"><meta name=twitter:description content="redis主从、哨兵、分片集群 概念：
redis主从及哨兵
redis分片集群
单机 在redis安装目录下执行./src/redis-server redis.conf会在6379端口启动单机版redis 使用 python3:
安装依赖库:pip3 install redis
import redis conn = redis.StrictRedis(connection_pool=redis.ConnectionPool( host=&#34;127.0.0.1&#34;, port=&#34;6381&#34;, password=&#34;&#34; )) # string类型的写入读取 ret = conn.set(&#34;py-k1&#34;, &#34;py-v1&#34;) print(ret) val = conn.get(&#34;py-k1&#34;) print(val) 执行：
python3 single-redis.py True b'py-v1' 主从搭建 参考：
redis主从模式搭建
下载redis 去http://download.redis.io/releases/上下载对应版本的redis(本次使用redis-6.0.0) curl -O http://download.redis.io/releases/redis-6.0.0.tar.gz 解压tar -zxvf redis-6.0.0.tar.gz 进入文件夹cd redis-6.0.0 编译redis文件make 规划 Name Role IP Port master1 master 127.0.0.1 6379 slave1 slave 127.0.0.1 6380 slave2 slave 127.0.0.1 6381 准备配置文件 修改redis安装目录下的redis.conf文件daemonize为yes后台启动 拷贝redis."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://moyuduo.github.io/posts/"},{"@type":"ListItem","position":2,"name":"redis-主从-哨兵-分片集群","item":"https://moyuduo.github.io/posts/redis-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"redis-主从-哨兵-分片集群","name":"redis-主从-哨兵-分片集群","description":"redis主从、哨兵、分片集群 概念：\nredis主从及哨兵\nredis分片集群\n单机 在redis安装目录下执行./src/redis-server redis.conf会在6379端口启动单机版redis 使用 python3:\n安装依赖库:pip3 install redis\nimport redis conn = redis.StrictRedis(connection_pool=redis.ConnectionPool( host=\u0026#34;127.0.0.1\u0026#34;, port=\u0026#34;6381\u0026#34;, password=\u0026#34;\u0026#34; )) # string类型的写入读取 ret = conn.set(\u0026#34;py-k1\u0026#34;, \u0026#34;py-v1\u0026#34;) print(ret) val = conn.get(\u0026#34;py-k1\u0026#34;) print(val) 执行：\npython3 single-redis.py True b\u0026#39;py-v1\u0026#39; 主从搭建 参考：\nredis主从模式搭建\n下载redis 去http://download.redis.io/releases/上下载对应版本的redis(本次使用redis-6.0.0) curl -O http://download.redis.io/releases/redis-6.0.0.tar.gz 解压tar -zxvf redis-6.0.0.tar.gz 进入文件夹cd redis-6.0.0 编译redis文件make 规划 Name Role IP Port master1 master 127.0.0.1 6379 slave1 slave 127.0.0.1 6380 slave2 slave 127.0.0.1 6381 准备配置文件 修改redis安装目录下的redis.conf文件daemonize为yes后台启动 拷贝redis.","keywords":[],"articleBody":"redis主从、哨兵、分片集群 概念：\nredis主从及哨兵\nredis分片集群\n单机 在redis安装目录下执行./src/redis-server redis.conf会在6379端口启动单机版redis 使用 python3:\n安装依赖库:pip3 install redis\nimport redis conn = redis.StrictRedis(connection_pool=redis.ConnectionPool( host=\"127.0.0.1\", port=\"6381\", password=\"\" )) # string类型的写入读取 ret = conn.set(\"py-k1\", \"py-v1\") print(ret) val = conn.get(\"py-k1\") print(val) 执行：\npython3 single-redis.py True b'py-v1' 主从搭建 参考：\nredis主从模式搭建\n下载redis 去http://download.redis.io/releases/上下载对应版本的redis(本次使用redis-6.0.0) curl -O http://download.redis.io/releases/redis-6.0.0.tar.gz 解压tar -zxvf redis-6.0.0.tar.gz 进入文件夹cd redis-6.0.0 编译redis文件make 规划 Name Role IP Port master1 master 127.0.0.1 6379 slave1 slave 127.0.0.1 6380 slave2 slave 127.0.0.1 6381 准备配置文件 修改redis安装目录下的redis.conf文件daemonize为yes后台启动 拷贝redis.conf为master.conf 拷贝redis.conf为slave1.conf并修改port为6380,添加replicaof 127.0.0.1 6379 拷贝redis.conf为slave2.conf并修改port为6381,添加replicaof 127.0.0.1 6379 启动主从节点 进入到redis安装目录下的src目录\n启动master节点:./redis-server master.conf 启动slave1节点:./redis-server slave1.conf 启动slave2节点:./redis-server slave2.conf 查看redis启动状态: ps -ef|grep redis root 7219 1 0 09:51 ? 00:00:00 ./redis-server 127.0.0.1:6379 root 7309 1 0 09:53 ? 00:00:00 ./redis-server 127.0.0.1:6380 root 7432 1 0 09:55 ? 00:00:00 ./redis-server 127.0.0.1:6381 root 7442 2409 0 09:55 pts/0 00:00:00 grep --color=auto redis 验证主从 主节点上执行:\n127.0.0.1:6379\u003e info replication # Replication role:master connected_slaves:2 slave0:ip=127.0.0.1,port=6381,state=online,offset=9446,lag=1 slave1:ip=127.0.0.1,port=6380,state=online,offset=9446,lag=1 master_replid:05521584a197dc89d0c9117ab8dae0e2b7c80e6b master_replid2:0000000000000000000000000000000000000000 master_repl_offset:9446 master_repl_meaningful_offset:80 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:9446 验证主从同步 进入到redis安装目录下的src文件夹\n执行./redis-cli -p 6379进入主节点 执行set k1 v1在主节点上设置值 执行./redis-cli -p 6380进入slave1节点 127.0.0.1:6380\u003e keys * 1) \"k1\" #k1已经同步到了slave1节点 127.0.0.1:6380\u003e get k1 \"v1\" 127.0.0.1:6380\u003e 执行./redis-cli -p 6381进入slave2节点 127.0.0.1:6381\u003e keys * 1) \"k1\" 127.0.0.1:6381\u003e get k1 \"v1\" 127.0.0.1:6381\u003e 验证从节点故障下线恢复后能否从主节点同步数据 手动停掉slave2节点kill xxx 验证节点状态 root 7219 1 0 09:51 ? 00:00:11 ./redis-server 127.0.0.1:6379 root 7309 1 0 09:53 ? 00:00:10 ./redis-server 127.0.0.1:6380 在master上设置值 127.0.0.1:6379\u003e set k2 v2 OK 127.0.0.1:6379\u003e set k3 v3 OK 127.0.0.1:6379\u003e 验证slave1有没有同步数据 127.0.0.1:6380\u003e keys * 1) \"k3\" 2) \"k2\" 3) \"k1\" 127.0.0.1:6380\u003e get k2 \"v2\" 127.0.0.1:6380\u003e get k3 \"v3\" 127.0.0.1:6380\u003e slave2上线./redis-server slave2.conf 执行./redis-cli -p 6381登录slave2 127.0.0.1:6381\u003e keys * 1) \"k1\" #上线后成功从master同步数据 2) \"k2\" 3) \"k3\" 127.0.0.1:6381\u003e get k2 \"v2\" 127.0.0.1:6381\u003e get k3 \"v3\" 127.0.0.1:6381\u003e 验证slave节点能否写数据 在slave2上执行set s2 s2 #从节点不可写数据 127.0.0.1:6381\u003e set s2 s2 (error) READONLY You can't write against a read only replica. 验证master节点挂后能否从slave读数据 下线master节点kill xxx 验证在slave1上查数据 127.0.0.1:6380\u003e keys * 1) \"k3\" 2) \"k2\" 3) \"k1\" 127.0.0.1:6380\u003e 127.0.0.1:6380\u003e 127.0.0.1:6380\u003e get k2 \"v2\" 127.0.0.1:6380\u003e 验证在slave2上查数据 127.0.0.1:6381\u003e keys * 1) \"k1\" 2) \"k2\" 3) \"k3\" 127.0.0.1:6381\u003e get k2 \"v2\" 验证master故障下线恢复后写入数据slave能否同步 下线master节点kill xxx 上线master节点./redis-server master.conf 在master节点上执行set k4 v4 在slave1节点上验证数据 127.0.0.1:6380\u003e keys * 1) \"k3\" 2) \"k4\" 3) \"k2\" 4) \"k1\" 127.0.0.1:6380\u003e get k4 \"v4\" 127.0.0.1:6380\u003e 在slave1节点上验证数据 127.0.0.1:6381\u003e keys * 1) \"k1\" 2) \"k2\" 3) \"k4\" 4) \"k3\" 127.0.0.1:6381\u003e get v4 (nil) 127.0.0.1:6381\u003e get k4 \"v4\" 127.0.0.1:6381\u003e 使用 python3:\n哨兵模式 参考：\nredis哨兵模式搭建\n哨兵模式相较于主从模式主要是增加了master下线选举新的slave节点为master\n规划 Name Role IP Port master1 master 127.0.0.1 6379 slave1 slave 127.0.0.1 6380 slave2 slave 127.0.0.1 6381 sentinel1 - 127.0.0.1 26379 sentinel2 - 127.0.0.1 26380 sentinel3 - 127.0.0.1 26381 搭建主从 参考前面主从搭建\n搭建哨兵 一个哨兵节点也是一个redis节点，哨兵节点不负责数据的读写，只负责监控主从节点，当主节点下线后，所有的哨兵节点(一般为基数)会进行投票选出一个新的主节点\n准备配置文件 redis安装目录下有sentinel.conf示例哨兵配置简介\n准备哨兵配置文件，按需修改 port 26379 daemonize yes pidfile /var/run/redis-sentinel.pid logfile \"\" dir /tmp #定义哨兵监视的主节点，并且需要至少2个哨兵节点连接不到主节点才判定为下线 sentinel monitor mymaster 127.0.0.1 6379 2 #主节点3秒内无响应则认为下线 sentinel down-after-milliseconds mymaster 3000 #当从节点当选为主节点后，同时只能有一个从节点从主节点同步数据 sentinel parallel-syncs mymaster 1 sentinel failover-timeout mymaster 180000 sentinel deny-scripts-reconfig yes 复制上述配置文件到sentinel1.conf 复制上述配置文件到sentinel2.conf，并修改port为26380 复制上述配置文件到sentinel3.conf，并修改port为26381 启动哨兵1、2、3 ./redis-server sentinelX.conf 查看状态 ps -ef|grep redis root 7309 1 0 09:53 ? 00:00:30 ./redis-server 127.0.0.1:6380 root 12413 1 0 11:11 ? 00:00:20 ./redis-server 127.0.0.1:6381 root 12968 1 0 11:21 ? 00:00:21 ./redis-server 127.0.0.1:6379 root 17727 1 0 13:25 ? 00:00:00 ./redis-server *:26379 [sentinel] root 17745 1 2 13:25 ? 00:00:00 ./redis-server *:26380 [sentinel] root 17753 1 4 13:25 ? 00:00:00 ./redis-server *:26381 [sentinel] root 17761 2409 0 13:25 pts/0 00:00:00 grep --color=auto redis 验证 验证主节点下线后从节点是否会被选为主节点 下线主节点 kill xxx 查看slave1状态 127.0.0.1:6380\u003e info replication # Replication role:slave master_host:127.0.0.1 master_port:6381 master_link_status:up master_last_io_seconds_ago:1 master_sync_in_progress:0 slave_repl_offset:64986 slave_priority:100 slave_read_only:1 connected_slaves:0 master_replid:2e365fdeb24324c2e16f68e1ec945a4cd1ac9a78 master_replid2:05521584a197dc89d0c9117ab8dae0e2b7c80e6b master_repl_offset:64986 master_repl_meaningful_offset:64986 second_repl_offset:58804 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:64986 查看slave2状态 127.0.0.1:6381\u003e info replication # Replication role:master #slave2已经被选为主节点 connected_slaves:1 slave0:ip=127.0.0.1,port=6380,state=online,offset=66715,lag=0 master_replid:2e365fdeb24324c2e16f68e1ec945a4cd1ac9a78 master_replid2:05521584a197dc89d0c9117ab8dae0e2b7c80e6b master_repl_offset:66715 master_repl_meaningful_offset:66715 second_repl_offset:58804 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:1 repl_backlog_histlen:66715 验证原主节点下线后重新上线后角色类型 下线主节点重新选主(参考上面) 上线原主节点 ./redis-server master.conf 验证原主节点类型 127.0.0.1:6379\u003e info replication # Replication role:slave #重新上线后原master节点类型为从节点 master_host:127.0.0.1 master_port:6381 master_link_status:up master_last_io_seconds_ago:1 master_sync_in_progress:0 slave_repl_offset:115766 slave_priority:100 slave_read_only:1 connected_slaves:0 master_replid:2e365fdeb24324c2e16f68e1ec945a4cd1ac9a78 master_replid2:0000000000000000000000000000000000000000 master_repl_offset:115766 master_repl_meaningful_offset:115766 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:111593 repl_backlog_histlen:4174 使用 python3:\nfrom redis.sentinel import Sentinel if __name__ == \"__main__\": sentinel_list = [ (\"127.0.0.1\", \"26379\"), (\"127.0.0.1\", \"26380\"), (\"127.0.0.1\", \"26381\"), ] sentinel = Sentinel(sentinel_list) master = sentinel.master_for('mymaster', socket_timeout=0.1) ret = master.set('py-sentinel-k1', 'py-sentinel-v1') print(ret) slave = sentinel.slave_for('mymaster', socket_timeout=0.1) ret = slave.get('py-sentinel-k1') print(ret) 执行：\npython3 conn-sentinel-redis.py True b'py-sentinel-v1' 分片集群 参考：\nredis分片集群搭建\nredis分片集群搭建\n分片集群相较于哨兵模式的优点在于哨兵模式虽然保证了高可用，但是不管是master还是slave节点，每个节点都保存了全量的数据，这样对于大数据的场景就不太友好，分片集群的优点在于集群中的每个节点只保存一部分数据，整个集群作为一个整体对外提供服务，并且集群中的每个分片也有备份，分片可以看成是一个哨兵模式的集群，当分片的master节点挂了，那么分片的slave节点会成为master节点继续提供服务\n规划 Name Role IP Port node1 - 127.0.0.1 6379 node2 - 127.0.0.1 6380 node3 - 127.0.0.1 6381 node4 - 127.0.0.1 6382 node5 - 127.0.0.1 6383 node6 - 127.0.0.1 6384 准备配置文件 daemonize yes port 6379 # 本地数据库存储目录，需要修改 dir /storehouse/redis_t/cluster/redis_6379 # 是否以集群模式启动 cluster-enabled yes # 集群节点回应最长时间，超过该时间被认为下线 cluster-node-timeout 15000 # 生成的集群节点配置文件名，文件名需要修改 cluster-config-file nodes_6379.conf 准备redis-cluster-xxx.conf修改port、dir和cluster-config-file\nll total 24 -rw-r--r--. 1 root root 268 Nov 27 15:09 redis-cluster-6379.conf -rw-r--r--. 1 root root 268 Nov 27 15:10 redis-cluster-6380.conf -rw-r--r--. 1 root root 268 Nov 27 15:10 redis-cluster-6381.conf -rw-r--r--. 1 root root 268 Nov 27 15:11 redis-cluster-6382.conf -rw-r--r--. 1 root root 268 Nov 27 15:11 redis-cluster-6383.conf -rw-r--r--. 1 root root 268 Nov 27 15:12 redis-cluster-6384.conf 启动节点： ./redis-server /storehouse/redis_t/cluster/redis-cluster-6379.conf ./redis-server /storehouse/redis_t/cluster/redis-cluster-6380.conf ... 查看状态\nps -ef|grep redis root 22656 1 0 15:15 ? 00:00:00 ./redis-server *:6379 [cluster] root 22669 1 0 15:15 ? 00:00:00 ./redis-server *:6380 [cluster] root 22683 1 0 15:15 ? 00:00:00 ./redis-server *:6381 [cluster] root 22691 1 0 15:15 ? 00:00:00 ./redis-server *:6382 [cluster] root 22697 1 0 15:15 ? 00:00:00 ./redis-server *:6383 [cluster] root 22707 1 1 15:15 ? 00:00:00 ./redis-server *:6384 [cluster] root 22715 2409 0 15:15 pts/0 00:00:00 grep --color=auto redis 创建集群 master节点数量=节点总数/(replicas+1),所以这里总共6个节点，replicas为1，那么master数量为3即由三个分片，每个分片有一个slave节点\n./redis-cli --cluster create 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384 --cluster-replicas 1 \u003e\u003e\u003e Performing hash slots allocation on 6 nodes... Master[0] -\u003e Slots 0 - 5460 Master[1] -\u003e Slots 5461 - 10922 Master[2] -\u003e Slots 10923 - 16383 Adding replica 127.0.0.1:6383 to 127.0.0.1:6379 Adding replica 127.0.0.1:6384 to 127.0.0.1:6380 Adding replica 127.0.0.1:6382 to 127.0.0.1:6381 \u003e\u003e\u003e Trying to optimize slaves allocation for anti-affinity [WARNING] Some slaves are in the same host as their master M: eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379 slots:[0-5460] (5461 slots) master M: 8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380 slots:[5461-10922] (5462 slots) master M: 851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381 slots:[10923-16383] (5461 slots) master S: 7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382 replicates 851d9155d0acc04d278dcbadd0e7c0642c40974a #127.0.0.1:6382这个节点是127.0.0.1:6381这个节点的副本 S: 136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383 replicates eb896ce4ed050f7135d298c7c09b5efc34233539 S: c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384 replicates 8fec6b575bf196aa0648cfee4d1169c33ea88db1 Can I set the above configuration? (type 'yes' to accept): yes \u003e\u003e\u003e Nodes configuration updated \u003e\u003e\u003e Assign a different config epoch to each node \u003e\u003e\u003e Sending CLUSTER MEET messages to join the cluster Waiting for the cluster to join ..... \u003e\u003e\u003e Performing Cluster Check (using node 127.0.0.1:6379) M: eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379 slots:[0-5460] (5461 slots) master 1 additional replica(s) M: 851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381 slots:[10923-16383] (5461 slots) master 1 additional replica(s) S: 136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383 slots: (0 slots) slave replicates eb896ce4ed050f7135d298c7c09b5efc34233539 S: 7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382 slots: (0 slots) slave replicates 851d9155d0acc04d278dcbadd0e7c0642c40974a S: c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384 slots: (0 slots) slave replicates 8fec6b575bf196aa0648cfee4d1169c33ea88db1 M: 8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380 slots:[5461-10922] (5462 slots) master 1 additional replica(s) [OK] All nodes agree about slots configuration. \u003e\u003e\u003e Check for open slots... \u003e\u003e\u003e Check slots coverage... [OK] All 16384 slots covered. 登录节点查看集群信息\n# -c 参数指定以集群模式连接redis ./redis-cli -c -p 6379 127.0.0.1:6379\u003e cluster info cluster_state:ok cluster_slots_assigned:16384 cluster_slots_ok:16384 cluster_slots_pfail:0 cluster_slots_fail:0 cluster_known_nodes:6 cluster_size:3 cluster_current_epoch:6 cluster_my_epoch:1 cluster_stats_messages_ping_sent:349 cluster_stats_messages_pong_sent:343 cluster_stats_messages_sent:692 cluster_stats_messages_ping_received:338 cluster_stats_messages_pong_received:349 cluster_stats_messages_meet_received:5 cluster_stats_messages_received:692 127.0.0.1:6379\u003e cluster node (error) ERR Unknown subcommand or wrong number of arguments for 'node'. Try CLUSTER HELP. 127.0.0.1:6379\u003e cluster nodes 851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381@16381 master - 0 1669534510801 3 connected 10923-16383 eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379@16379 myself,master - 0 1669534511000 1 connected 0-5460 136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383@16383 slave eb896ce4ed050f7135d298c7c09b5efc34233539 0 1669534511830 5 connected 7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382@16382 slave 851d9155d0acc04d278dcbadd0e7c0642c40974a 0 1669534511000 4 connected c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384@16384 slave 8fec6b575bf196aa0648cfee4d1169c33ea88db1 0 1669534511000 6 connected 8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380@16380 master - 0 1669534512855 2 connected 5461-10922 验证 验证设置/获取值 在127.0.0.1:6379节点上执行./redis-cli -c -p 6379\n./redis-cli -c -p 6379 set k1 v1 #在redis分片集群模式下设置值会对key计算hash以确定会被存储到哪个分片上 -\u003e Redirected to slot [12706] located at 127.0.0.1:6381 OK 127.0.0.1:6379\u003e get k1 #获取值时也会对key去hash计算数据存储在那个节点上，如果不在当前节点会redirect到相应的节点 -\u003e Redirected to slot [12706] located at 127.0.0.1:6381 \"v1\" 直连127.0.0.1:6379节点查看keys *\n./redis-cli -p 6379 127.0.0.1:6379\u003e keys * (empty array) #说明k1不是存在该节点上 直连127.0.0.1:6381节点查看keys *(分片master节点)\n./redis-cli -p 6381 127.0.0.1:6381\u003e keys * 1) \"k1\" #说明k1是存在该节点上 直连127.0.0.1:6382节点查看keys *(分片slave节点 验证分片数据是否保存到了分片副本上)\n./redis-cli -p 6382 127.0.0.1:6382\u003e keys * 1) \"k1\" #说明分片上的数据会全部同步到分片副本上 验证分片的master节点下线后集群状态 由于通过cluster nodes命令知道127.0.0.1:6382这个节点是127.0.0.1:6381master的副本，那么kill 127.0.0.1:6381 这个节点即可验证127.0.0.1:6382这个节点会不会成为master\nps -ef|grep redis root 23270 1 0 15:27 ? 00:00:03 ./redis-server *:6379 [cluster] root 23297 1 0 15:28 ? 00:00:03 ./redis-server *:6380 [cluster] root 23305 1 0 15:28 ? 00:00:03 ./redis-server *:6381 [cluster] root 23315 1 0 15:28 ? 00:00:03 ./redis-server *:6382 [cluster] root 23321 1 0 15:28 ? 00:00:03 ./redis-server *:6383 [cluster] root 23329 1 0 15:28 ? 00:00:03 ./redis-server *:6384 [cluster] root 24215 7340 0 15:49 pts/2 00:00:00 ./redis-cli -p 6381 root 24261 2409 0 15:51 pts/0 00:00:00 grep --color=auto redis kill 23305 ./redis-cli -c -p 6379 127.0.0.1:6379\u003e 127.0.0.1:6379\u003e cluster nodes 851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381@16381 master,fail - 1669535502496 1669535497392 3 disconnected #节点下线了 eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379@16379 myself,master - 0 1669535551000 1 connected 0-5460 136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383@16383 slave eb896ce4ed050f7135d298c7c09b5efc34233539 0 1669535551055 5 connected 7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382@16382 master - 0 1669535550035 7 connected 10923-16383 #节点成为分片的master c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384@16384 slave 8fec6b575bf196aa0648cfee4d1169c33ea88db1 0 1669535549014 6 connected 8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380@16380 master - 0 1669535552077 2 connected 5461-10922 127.0.0.1:6379\u003e get k1 -\u003e Redirected to slot [12706] located at 127.0.0.1:6382 \"v1\" 验证分片的master节点下线后重新上线集群状态 ./redis-server /storehouse/redis_t/cluster/redis-cluster-6381.conf 24436:C 27 Nov 2022 15:55:52.538 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo 24436:C 27 Nov 2022 15:55:52.538 # Redis version=6.0.0, bits=64, commit=00000000, modified=0, pid=24436, just started 24436:C 27 Nov 2022 15:55:52.538 # Configuration loaded ./redis-cli -c -p 6379 127.0.0.1:6379\u003e cluster nodes 851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381@16381 slave 7fffe89ccf2247acd1612f1692c6972dc37af78a 0 1669535779000 7 connected #原master节点上线后成为分片slave节点 eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379@16379 myself,master - 0 1669535777000 1 connected 0-5460 136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383@16383 slave eb896ce4ed050f7135d298c7c09b5efc34233539 0 1669535779717 5 connected 7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382@16382 master - 0 1669535778000 7 connected 10923-16383 c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384@16384 slave 8fec6b575bf196aa0648cfee4d1169c33ea88db1 0 1669535778692 6 connected 8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380@16380 master - 0 1669535777671 2 connected 5461-10922 使用 python3 安装依赖：pip3 install rediscluster\nfrom rediscluster import RedisCluster if __name__ == \"__main__\": startup_nodes = [ {\"host\":\"127.0.0.1\", \"port\":6379}, {\"host\":\"127.0.0.1\", \"port\":6380}, {\"host\":\"127.0.0.1\", \"port\":6381}, {\"host\":\"127.0.0.1\", \"port\":6382}, {\"host\":\"127.0.0.1\", \"port\":6383}, {\"host\":\"127.0.0.1\", \"port\":6384}, ] # 连接集群 conn = RedisCluster(startup_nodes=startup_nodes, decode_responses=True) ret = conn.set(\"py-cluster-k1\", \"py-cluster-v1\") print(ret) ret = conn.get(\"py-cluster-k1\") print(ret) 执行：\npython3 conn-cluster-redis.py True py-cluster-v1 ","wordCount":"1538","inLanguage":"en","datePublished":"2022-11-27T16:16:14+08:00","dateModified":"2022-11-27T16:16:14+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moyuduo.github.io/posts/redis-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5-%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4/"},"publisher":{"@type":"Organization","name":"Moyuduo's Blog","logo":{"@type":"ImageObject","url":"https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://moyuduo.github.io/ accesskey=h title="Moyuduo's Blog (Alt + H)"><img src=https://moyuduo.github.io/apple-touch-icon.png alt aria-label=logo height=35>Moyuduo's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://moyuduo.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://moyuduo.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://moyuduo.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://moyuduo.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>redis-主从-哨兵-分片集群</h1></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#单机>单机</a><ul><li><a href=#使用>使用</a></li></ul></li><li><a href=#主从搭建>主从搭建</a><ul><li><a href=#下载redis>下载redis</a></li><li><a href=#规划>规划</a></li><li><a href=#准备配置文件>准备配置文件</a></li><li><a href=#验证主从>验证主从</a></li><li><a href=#使用-1>使用</a></li></ul></li><li><a href=#哨兵模式>哨兵模式</a><ul><li><a href=#规划-1>规划</a></li><li><a href=#搭建主从>搭建主从</a></li><li><a href=#搭建哨兵>搭建哨兵</a></li><li><a href=#验证>验证</a></li><li><a href=#使用-2>使用</a></li></ul></li><li><a href=#分片集群>分片集群</a><ul><li><a href=#规划-2>规划</a></li><li><a href=#准备配置文件-2>准备配置文件</a></li><li><a href=#启动节点>启动节点：</a></li><li><a href=#创建集群>创建集群</a></li><li><a href=#验证-1>验证</a></li><li><a href=#使用-3>使用</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=redis主从哨兵分片集群>redis主从、哨兵、分片集群<a hidden class=anchor aria-hidden=true href=#redis主从哨兵分片集群>#</a></h1><p>概念：</p><p><a href=https://www.bilibili.com/video/BV1MW4y187AH>redis主从及哨兵</a></p><p><a href=https://www.bilibili.com/video/BV1ge411L7Sh>redis分片集群</a></p><h2 id=单机>单机<a hidden class=anchor aria-hidden=true href=#单机>#</a></h2><ol><li>在redis安装目录下执行<code>./src/redis-server redis.conf</code>会在6379端口启动单机版redis</li></ol><h3 id=使用>使用<a hidden class=anchor aria-hidden=true href=#使用>#</a></h3><p>python3:</p><p>安装依赖库:<code>pip3 install redis</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>StrictRedis</span><span class=p>(</span><span class=n>connection_pool</span><span class=o>=</span><span class=n>redis</span><span class=o>.</span><span class=n>ConnectionPool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=n>host</span><span class=o>=</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=s2>&#34;6381&#34;</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>		<span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># string类型的写入读取</span>
</span></span><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=s2>&#34;py-k1&#34;</span><span class=p>,</span> <span class=s2>&#34;py-v1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>val</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;py-k1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
</span></span></code></pre></div><p>执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>python3 single-redis.py 
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>b<span class=s1>&#39;py-v1&#39;</span>
</span></span></code></pre></div><h2 id=主从搭建>主从搭建<a hidden class=anchor aria-hidden=true href=#主从搭建>#</a></h2><p>参考：</p><p><a href=https://blog.csdn.net/panjinxiang4217/article/details/119143698>redis主从模式搭建</a></p><h3 id=下载redis>下载redis<a hidden class=anchor aria-hidden=true href=#下载redis>#</a></h3><ol><li>去<code>http://download.redis.io/releases/</code>上下载对应版本的redis(本次使用redis-6.0.0) <code>curl -O http://download.redis.io/releases/redis-6.0.0.tar.gz</code></li><li>解压<code>tar -zxvf redis-6.0.0.tar.gz</code></li><li>进入文件夹<code>cd redis-6.0.0</code></li><li>编译redis文件<code>make</code></li></ol><h3 id=规划>规划<a hidden class=anchor aria-hidden=true href=#规划>#</a></h3><table><thead><tr><th>Name</th><th>Role</th><th>IP</th><th>Port</th></tr></thead><tbody><tr><td>master1</td><td>master</td><td>127.0.0.1</td><td>6379</td></tr><tr><td>slave1</td><td>slave</td><td>127.0.0.1</td><td>6380</td></tr><tr><td>slave2</td><td>slave</td><td>127.0.0.1</td><td>6381</td></tr></tbody></table><h3 id=准备配置文件>准备配置文件<a hidden class=anchor aria-hidden=true href=#准备配置文件>#</a></h3><ol><li>修改redis安装目录下的<code>redis.conf</code>文件<code>daemonize</code>为<code>yes</code>后台启动</li><li>拷贝<code>redis.conf</code>为<code>master.conf</code></li><li>拷贝<code>redis.conf</code>为<code>slave1.conf</code>并修改<code>port</code>为<code>6380</code>,添加<code>replicaof 127.0.0.1 6379</code></li><li>拷贝<code>redis.conf</code>为<code>slave2.conf</code>并修改<code>port</code>为<code>6381</code>,添加<code>replicaof 127.0.0.1 6379</code></li></ol><h4 id=启动主从节点>启动主从节点<a hidden class=anchor aria-hidden=true href=#启动主从节点>#</a></h4><p>进入到redis安装目录下的src目录</p><ol><li>启动<code>master</code>节点:<code>./redis-server master.conf</code></li><li>启动<code>slave1</code>节点:<code>./redis-server slave1.conf</code></li><li>启动<code>slave2</code>节点:<code>./redis-server slave2.conf</code></li><li>查看redis启动状态:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ps -ef<span class=p>|</span>grep redis
</span></span><span class=line><span class=cl>root       <span class=m>7219</span>      <span class=m>1</span>  <span class=m>0</span> 09:51 ?        00:00:00 ./redis-server 127.0.0.1:6379
</span></span><span class=line><span class=cl>root       <span class=m>7309</span>      <span class=m>1</span>  <span class=m>0</span> 09:53 ?        00:00:00 ./redis-server 127.0.0.1:6380
</span></span><span class=line><span class=cl>root       <span class=m>7432</span>      <span class=m>1</span>  <span class=m>0</span> 09:55 ?        00:00:00 ./redis-server 127.0.0.1:6381
</span></span><span class=line><span class=cl>root       <span class=m>7442</span>   <span class=m>2409</span>  <span class=m>0</span> 09:55 pts/0    00:00:00 grep --color<span class=o>=</span>auto redis
</span></span></code></pre></div><h3 id=验证主从>验证主从<a hidden class=anchor aria-hidden=true href=#验证主从>#</a></h3><p>主节点上执行:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:2
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>127.0.0.1,port<span class=o>=</span>6381,state<span class=o>=</span>online,offset<span class=o>=</span>9446,lag<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>slave1:ip<span class=o>=</span>127.0.0.1,port<span class=o>=</span>6380,state<span class=o>=</span>online,offset<span class=o>=</span>9446,lag<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>master_replid:05521584a197dc89d0c9117ab8dae0e2b7c80e6b
</span></span><span class=line><span class=cl>master_replid2:0000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>master_repl_offset:9446
</span></span><span class=line><span class=cl>master_repl_meaningful_offset:80
</span></span><span class=line><span class=cl>second_repl_offset:-1
</span></span><span class=line><span class=cl>repl_backlog_active:1
</span></span><span class=line><span class=cl>repl_backlog_size:1048576
</span></span><span class=line><span class=cl>repl_backlog_first_byte_offset:1
</span></span><span class=line><span class=cl>repl_backlog_histlen:9446
</span></span></code></pre></div><h4 id=验证主从同步>验证主从同步<a hidden class=anchor aria-hidden=true href=#验证主从同步>#</a></h4><p>进入到redis安装目录下的src文件夹</p><ol><li>执行<code>./redis-cli -p 6379</code>进入主节点</li><li>执行<code>set k1 v1</code>在主节点上设置值</li><li>执行<code>./redis-cli -p 6380</code>进入slave1节点</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6380&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k1&#34;</span> <span class=c1>#k1已经同步到了slave1节点</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; get k1
</span></span><span class=line><span class=cl><span class=s2>&#34;v1&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; 
</span></span></code></pre></div><ol start=4><li>执行<code>./redis-cli -p 6381</code>进入slave2节点</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6381&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k1&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; get k1
</span></span><span class=line><span class=cl><span class=s2>&#34;v1&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt;
</span></span></code></pre></div><h4 id=验证从节点故障下线恢复后能否从主节点同步数据>验证从节点故障下线恢复后能否从主节点同步数据<a hidden class=anchor aria-hidden=true href=#验证从节点故障下线恢复后能否从主节点同步数据>#</a></h4><ol><li>手动停掉slave2节点<code>kill xxx</code></li><li>验证节点状态</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root       <span class=m>7219</span>      <span class=m>1</span>  <span class=m>0</span> 09:51 ?        00:00:11 ./redis-server 127.0.0.1:6379
</span></span><span class=line><span class=cl>root       <span class=m>7309</span>      <span class=m>1</span>  <span class=m>0</span> 09:53 ?        00:00:10 ./redis-server 127.0.0.1:6380
</span></span></code></pre></div><ol start=3><li>在master上设置值</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6379&gt; <span class=nb>set</span> k2 v2
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; <span class=nb>set</span> k3 v3
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt;
</span></span></code></pre></div><ol start=4><li>验证slave1有没有同步数据</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6380&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k3&#34;</span>
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=s2>&#34;k2&#34;</span>
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=s2>&#34;k1&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; get k2
</span></span><span class=line><span class=cl><span class=s2>&#34;v2&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; get k3
</span></span><span class=line><span class=cl><span class=s2>&#34;v3&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; 
</span></span></code></pre></div><ol start=5><li>slave2上线<code>./redis-server slave2.conf</code></li><li>执行<code>./redis-cli -p 6381</code>登录slave2</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6381&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k1&#34;</span> <span class=c1>#上线后成功从master同步数据</span>
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=s2>&#34;k2&#34;</span>
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=s2>&#34;k3&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; get k2
</span></span><span class=line><span class=cl><span class=s2>&#34;v2&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; get k3
</span></span><span class=line><span class=cl><span class=s2>&#34;v3&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; 
</span></span></code></pre></div><h4 id=验证slave节点能否写数据>验证slave节点能否写数据<a hidden class=anchor aria-hidden=true href=#验证slave节点能否写数据>#</a></h4><ol><li>在slave2上执行<code>set s2 s2</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#从节点不可写数据</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; <span class=nb>set</span> s2 s2
</span></span><span class=line><span class=cl><span class=o>(</span>error<span class=o>)</span> READONLY You can<span class=err>&#39;</span>t write against a <span class=nb>read</span> only replica.
</span></span></code></pre></div><h4 id=验证master节点挂后能否从slave读数据>验证master节点挂后能否从slave读数据<a hidden class=anchor aria-hidden=true href=#验证master节点挂后能否从slave读数据>#</a></h4><ol><li>下线master节点<code>kill xxx</code></li><li>验证在slave1上查数据</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6380&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k3&#34;</span>
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=s2>&#34;k2&#34;</span>
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=s2>&#34;k1&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; 
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; 
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; get k2
</span></span><span class=line><span class=cl><span class=s2>&#34;v2&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; 
</span></span></code></pre></div><ol start=3><li>验证在slave2上查数据</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6381&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k1&#34;</span>
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=s2>&#34;k2&#34;</span>
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=s2>&#34;k3&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; get k2
</span></span><span class=line><span class=cl><span class=s2>&#34;v2&#34;</span>
</span></span></code></pre></div><h4 id=验证master故障下线恢复后写入数据slave能否同步>验证master故障下线恢复后写入数据slave能否同步<a hidden class=anchor aria-hidden=true href=#验证master故障下线恢复后写入数据slave能否同步>#</a></h4><ol><li>下线master节点<code>kill xxx</code></li><li>上线master节点<code>./redis-server master.conf</code></li><li>在master节点上执行<code>set k4 v4</code></li><li>在slave1节点上验证数据</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6380&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k3&#34;</span>
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=s2>&#34;k4&#34;</span>
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=s2>&#34;k2&#34;</span>
</span></span><span class=line><span class=cl>4<span class=o>)</span> <span class=s2>&#34;k1&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; get k4
</span></span><span class=line><span class=cl><span class=s2>&#34;v4&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6380&gt; 
</span></span></code></pre></div><ol start=5><li>在slave1节点上验证数据</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6381&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k1&#34;</span>
</span></span><span class=line><span class=cl>2<span class=o>)</span> <span class=s2>&#34;k2&#34;</span>
</span></span><span class=line><span class=cl>3<span class=o>)</span> <span class=s2>&#34;k4&#34;</span>
</span></span><span class=line><span class=cl>4<span class=o>)</span> <span class=s2>&#34;k3&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; get v4
</span></span><span class=line><span class=cl><span class=o>(</span>nil<span class=o>)</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; get k4
</span></span><span class=line><span class=cl><span class=s2>&#34;v4&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; 
</span></span></code></pre></div><h3 id=使用-1>使用<a hidden class=anchor aria-hidden=true href=#使用-1>#</a></h3><p>python3:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python></code></pre></div><h2 id=哨兵模式>哨兵模式<a hidden class=anchor aria-hidden=true href=#哨兵模式>#</a></h2><p>参考：</p><p><a href=https://blog.csdn.net/panjinxiang4217/article/details/119144268>redis哨兵模式搭建</a></p><blockquote><p>哨兵模式相较于主从模式主要是增加了master下线选举新的slave节点为master</p></blockquote><h3 id=规划-1>规划<a hidden class=anchor aria-hidden=true href=#规划-1>#</a></h3><table><thead><tr><th>Name</th><th>Role</th><th>IP</th><th>Port</th></tr></thead><tbody><tr><td>master1</td><td>master</td><td>127.0.0.1</td><td>6379</td></tr><tr><td>slave1</td><td>slave</td><td>127.0.0.1</td><td>6380</td></tr><tr><td>slave2</td><td>slave</td><td>127.0.0.1</td><td>6381</td></tr><tr><td>sentinel1</td><td>-</td><td>127.0.0.1</td><td>26379</td></tr><tr><td>sentinel2</td><td>-</td><td>127.0.0.1</td><td>26380</td></tr><tr><td>sentinel3</td><td>-</td><td>127.0.0.1</td><td>26381</td></tr></tbody></table><h3 id=搭建主从>搭建主从<a hidden class=anchor aria-hidden=true href=#搭建主从>#</a></h3><p>参考前面主从搭建</p><h3 id=搭建哨兵>搭建哨兵<a hidden class=anchor aria-hidden=true href=#搭建哨兵>#</a></h3><blockquote><p>一个哨兵节点也是一个redis节点，哨兵节点不负责数据的读写，只负责监控主从节点，当主节点下线后，所有的哨兵节点(一般为基数)会进行投票选出一个新的主节点</p></blockquote><h4 id=准备配置文件-1>准备配置文件<a hidden class=anchor aria-hidden=true href=#准备配置文件-1>#</a></h4><p>redis安装目录下有<code>sentinel.conf</code>示例哨兵配置简介</p><ol><li>准备哨兵配置文件，按需修改</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>port 26379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>daemonize yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pidfile /var/run/redis-sentinel.pid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>logfile &#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>dir /tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#定义哨兵监视的主节点，并且需要至少2个哨兵节点连接不到主节点才判定为下线</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>sentinel monitor mymaster 127.0.0.1 6379 2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#主节点3秒内无响应则认为下线</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>sentinel down-after-milliseconds mymaster 3000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#当从节点当选为主节点后，同时只能有一个从节点从主节点同步数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>sentinel parallel-syncs mymaster 1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>sentinel failover-timeout mymaster 180000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>sentinel deny-scripts-reconfig yes</span><span class=w>
</span></span></span></code></pre></div><ol start=2><li>复制上述配置文件到<code>sentinel1.conf</code></li><li>复制上述配置文件到<code>sentinel2.conf</code>，并修改<code>port</code>为26380</li><li>复制上述配置文件到<code>sentinel3.conf</code>，并修改<code>port</code>为26381</li><li>启动哨兵1、2、3 <code>./redis-server sentinelX.conf</code></li><li>查看状态</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ps -ef<span class=p>|</span>grep redis
</span></span><span class=line><span class=cl>root       <span class=m>7309</span>      <span class=m>1</span>  <span class=m>0</span> 09:53 ?        00:00:30 ./redis-server 127.0.0.1:6380
</span></span><span class=line><span class=cl>root      <span class=m>12413</span>      <span class=m>1</span>  <span class=m>0</span> 11:11 ?        00:00:20 ./redis-server 127.0.0.1:6381
</span></span><span class=line><span class=cl>root      <span class=m>12968</span>      <span class=m>1</span>  <span class=m>0</span> 11:21 ?        00:00:21 ./redis-server 127.0.0.1:6379
</span></span><span class=line><span class=cl>root      <span class=m>17727</span>      <span class=m>1</span>  <span class=m>0</span> 13:25 ?        00:00:00 ./redis-server *:26379 <span class=o>[</span>sentinel<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>17745</span>      <span class=m>1</span>  <span class=m>2</span> 13:25 ?        00:00:00 ./redis-server *:26380 <span class=o>[</span>sentinel<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>17753</span>      <span class=m>1</span>  <span class=m>4</span> 13:25 ?        00:00:00 ./redis-server *:26381 <span class=o>[</span>sentinel<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>17761</span>   <span class=m>2409</span>  <span class=m>0</span> 13:25 pts/0    00:00:00 grep --color<span class=o>=</span>auto redis
</span></span></code></pre></div><h3 id=验证>验证<a hidden class=anchor aria-hidden=true href=#验证>#</a></h3><h4 id=验证主节点下线后从节点是否会被选为主节点>验证主节点下线后从节点是否会被选为主节点<a hidden class=anchor aria-hidden=true href=#验证主节点下线后从节点是否会被选为主节点>#</a></h4><ol><li>下线主节点 <code>kill xxx</code></li><li>查看slave1状态</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6380&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:slave
</span></span><span class=line><span class=cl>master_host:127.0.0.1
</span></span><span class=line><span class=cl>master_port:6381
</span></span><span class=line><span class=cl>master_link_status:up
</span></span><span class=line><span class=cl>master_last_io_seconds_ago:1
</span></span><span class=line><span class=cl>master_sync_in_progress:0
</span></span><span class=line><span class=cl>slave_repl_offset:64986
</span></span><span class=line><span class=cl>slave_priority:100
</span></span><span class=line><span class=cl>slave_read_only:1
</span></span><span class=line><span class=cl>connected_slaves:0
</span></span><span class=line><span class=cl>master_replid:2e365fdeb24324c2e16f68e1ec945a4cd1ac9a78
</span></span><span class=line><span class=cl>master_replid2:05521584a197dc89d0c9117ab8dae0e2b7c80e6b
</span></span><span class=line><span class=cl>master_repl_offset:64986
</span></span><span class=line><span class=cl>master_repl_meaningful_offset:64986
</span></span><span class=line><span class=cl>second_repl_offset:58804
</span></span><span class=line><span class=cl>repl_backlog_active:1
</span></span><span class=line><span class=cl>repl_backlog_size:1048576
</span></span><span class=line><span class=cl>repl_backlog_first_byte_offset:1
</span></span><span class=line><span class=cl>repl_backlog_histlen:64986
</span></span></code></pre></div><ol start=3><li>查看slave2状态</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6381&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master <span class=c1>#slave2已经被选为主节点</span>
</span></span><span class=line><span class=cl>connected_slaves:1
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>127.0.0.1,port<span class=o>=</span>6380,state<span class=o>=</span>online,offset<span class=o>=</span>66715,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>master_replid:2e365fdeb24324c2e16f68e1ec945a4cd1ac9a78
</span></span><span class=line><span class=cl>master_replid2:05521584a197dc89d0c9117ab8dae0e2b7c80e6b
</span></span><span class=line><span class=cl>master_repl_offset:66715
</span></span><span class=line><span class=cl>master_repl_meaningful_offset:66715
</span></span><span class=line><span class=cl>second_repl_offset:58804
</span></span><span class=line><span class=cl>repl_backlog_active:1
</span></span><span class=line><span class=cl>repl_backlog_size:1048576
</span></span><span class=line><span class=cl>repl_backlog_first_byte_offset:1
</span></span><span class=line><span class=cl>repl_backlog_histlen:66715
</span></span></code></pre></div><h4 id=验证原主节点下线后重新上线后角色类型>验证原主节点下线后重新上线后角色类型<a hidden class=anchor aria-hidden=true href=#验证原主节点下线后重新上线后角色类型>#</a></h4><ol><li>下线主节点重新选主(参考上面)</li><li>上线原主节点 <code>./redis-server master.conf</code></li><li>验证原主节点类型</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:slave  <span class=c1>#重新上线后原master节点类型为从节点</span>
</span></span><span class=line><span class=cl>master_host:127.0.0.1
</span></span><span class=line><span class=cl>master_port:6381
</span></span><span class=line><span class=cl>master_link_status:up
</span></span><span class=line><span class=cl>master_last_io_seconds_ago:1
</span></span><span class=line><span class=cl>master_sync_in_progress:0
</span></span><span class=line><span class=cl>slave_repl_offset:115766
</span></span><span class=line><span class=cl>slave_priority:100
</span></span><span class=line><span class=cl>slave_read_only:1
</span></span><span class=line><span class=cl>connected_slaves:0
</span></span><span class=line><span class=cl>master_replid:2e365fdeb24324c2e16f68e1ec945a4cd1ac9a78
</span></span><span class=line><span class=cl>master_replid2:0000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>master_repl_offset:115766
</span></span><span class=line><span class=cl>master_repl_meaningful_offset:115766
</span></span><span class=line><span class=cl>second_repl_offset:-1
</span></span><span class=line><span class=cl>repl_backlog_active:1
</span></span><span class=line><span class=cl>repl_backlog_size:1048576
</span></span><span class=line><span class=cl>repl_backlog_first_byte_offset:111593
</span></span><span class=line><span class=cl>repl_backlog_histlen:4174
</span></span></code></pre></div><h3 id=使用-2>使用<a hidden class=anchor aria-hidden=true href=#使用-2>#</a></h3><p>python3:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>redis.sentinel</span> <span class=kn>import</span> <span class=n>Sentinel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sentinel_list</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;26379&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;26380&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;26381&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>sentinel</span> <span class=o>=</span> <span class=n>Sentinel</span><span class=p>(</span><span class=n>sentinel_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>master</span> <span class=o>=</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>master_for</span><span class=p>(</span><span class=s1>&#39;mymaster&#39;</span><span class=p>,</span> <span class=n>socket_timeout</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=n>master</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=s1>&#39;py-sentinel-k1&#39;</span><span class=p>,</span> <span class=s1>&#39;py-sentinel-v1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>slave</span> <span class=o>=</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>slave_for</span><span class=p>(</span><span class=s1>&#39;mymaster&#39;</span><span class=p>,</span> <span class=n>socket_timeout</span><span class=o>=</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=n>slave</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;py-sentinel-k1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span></span></code></pre></div><p>执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>python3 conn-sentinel-redis.py 
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>b<span class=s1>&#39;py-sentinel-v1&#39;</span>
</span></span></code></pre></div><h2 id=分片集群>分片集群<a hidden class=anchor aria-hidden=true href=#分片集群>#</a></h2><p>参考：</p><p><a href=https://blog.csdn.net/panjinxiang4217/article/details/119145328>redis分片集群搭建</a></p><p><a href=https://blog.csdn.net/q704013673/article/details/127229113>redis分片集群搭建</a></p><blockquote><p>分片集群相较于哨兵模式的优点在于哨兵模式虽然保证了高可用，但是不管是master还是slave节点，每个节点都保存了全量的数据，这样对于大数据的场景就不太友好，分片集群的优点在于集群中的每个节点只保存一部分数据，整个集群作为一个整体对外提供服务，并且集群中的每个分片也有备份，分片可以看成是一个哨兵模式的集群，当分片的master节点挂了，那么分片的slave节点会成为master节点继续提供服务</p></blockquote><h3 id=规划-2>规划<a hidden class=anchor aria-hidden=true href=#规划-2>#</a></h3><table><thead><tr><th>Name</th><th>Role</th><th>IP</th><th>Port</th></tr></thead><tbody><tr><td>node1</td><td>-</td><td>127.0.0.1</td><td>6379</td></tr><tr><td>node2</td><td>-</td><td>127.0.0.1</td><td>6380</td></tr><tr><td>node3</td><td>-</td><td>127.0.0.1</td><td>6381</td></tr><tr><td>node4</td><td>-</td><td>127.0.0.1</td><td>6382</td></tr><tr><td>node5</td><td>-</td><td>127.0.0.1</td><td>6383</td></tr><tr><td>node6</td><td>-</td><td>127.0.0.1</td><td>6384</td></tr></tbody></table><h3 id=准备配置文件-2>准备配置文件<a hidden class=anchor aria-hidden=true href=#准备配置文件-2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=l>daemonize yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>port 6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 本地数据库存储目录，需要修改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>dir /storehouse/redis_t/cluster/redis_6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 是否以集群模式启动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cluster-enabled yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 集群节点回应最长时间，超过该时间被认为下线</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cluster-node-timeout 15000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 生成的集群节点配置文件名，文件名需要修改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cluster-config-file nodes_6379.conf</span><span class=w>
</span></span></span></code></pre></div><p>准备<code>redis-cluster-xxx.conf</code>修改<code>port</code>、<code>dir</code>和<code>cluster-config-file</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ll
</span></span><span class=line><span class=cl>total <span class=m>24</span>
</span></span><span class=line><span class=cl>-rw-r--r--. <span class=m>1</span> root root <span class=m>268</span> Nov <span class=m>27</span> 15:09 redis-cluster-6379.conf
</span></span><span class=line><span class=cl>-rw-r--r--. <span class=m>1</span> root root <span class=m>268</span> Nov <span class=m>27</span> 15:10 redis-cluster-6380.conf
</span></span><span class=line><span class=cl>-rw-r--r--. <span class=m>1</span> root root <span class=m>268</span> Nov <span class=m>27</span> 15:10 redis-cluster-6381.conf
</span></span><span class=line><span class=cl>-rw-r--r--. <span class=m>1</span> root root <span class=m>268</span> Nov <span class=m>27</span> 15:11 redis-cluster-6382.conf
</span></span><span class=line><span class=cl>-rw-r--r--. <span class=m>1</span> root root <span class=m>268</span> Nov <span class=m>27</span> 15:11 redis-cluster-6383.conf
</span></span><span class=line><span class=cl>-rw-r--r--. <span class=m>1</span> root root <span class=m>268</span> Nov <span class=m>27</span> 15:12 redis-cluster-6384.conf
</span></span></code></pre></div><h3 id=启动节点>启动节点：<a hidden class=anchor aria-hidden=true href=#启动节点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./redis-server /storehouse/redis_t/cluster/redis-cluster-6379.conf
</span></span><span class=line><span class=cl>./redis-server /storehouse/redis_t/cluster/redis-cluster-6380.conf
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>查看状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ps -ef<span class=p>|</span>grep redis
</span></span><span class=line><span class=cl>root      <span class=m>22656</span>      <span class=m>1</span>  <span class=m>0</span> 15:15 ?        00:00:00 ./redis-server *:6379 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>22669</span>      <span class=m>1</span>  <span class=m>0</span> 15:15 ?        00:00:00 ./redis-server *:6380 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>22683</span>      <span class=m>1</span>  <span class=m>0</span> 15:15 ?        00:00:00 ./redis-server *:6381 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>22691</span>      <span class=m>1</span>  <span class=m>0</span> 15:15 ?        00:00:00 ./redis-server *:6382 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>22697</span>      <span class=m>1</span>  <span class=m>0</span> 15:15 ?        00:00:00 ./redis-server *:6383 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>22707</span>      <span class=m>1</span>  <span class=m>1</span> 15:15 ?        00:00:00 ./redis-server *:6384 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>22715</span>   <span class=m>2409</span>  <span class=m>0</span> 15:15 pts/0    00:00:00 grep --color<span class=o>=</span>auto redis
</span></span></code></pre></div><h3 id=创建集群>创建集群<a hidden class=anchor aria-hidden=true href=#创建集群>#</a></h3><p>master节点数量=节点总数/(replicas+1),所以这里总共6个节点，replicas为1，那么master数量为3即由三个分片，每个分片有一个slave节点</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./redis-cli --cluster create 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384 --cluster-replicas <span class=m>1</span>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing <span class=nb>hash</span> slots allocation on <span class=m>6</span> nodes...
</span></span><span class=line><span class=cl>Master<span class=o>[</span>0<span class=o>]</span> -&gt; Slots <span class=m>0</span> - <span class=m>5460</span>
</span></span><span class=line><span class=cl>Master<span class=o>[</span>1<span class=o>]</span> -&gt; Slots <span class=m>5461</span> - <span class=m>10922</span>
</span></span><span class=line><span class=cl>Master<span class=o>[</span>2<span class=o>]</span> -&gt; Slots <span class=m>10923</span> - <span class=m>16383</span>
</span></span><span class=line><span class=cl>Adding replica 127.0.0.1:6383 to 127.0.0.1:6379
</span></span><span class=line><span class=cl>Adding replica 127.0.0.1:6384 to 127.0.0.1:6380
</span></span><span class=line><span class=cl>Adding replica 127.0.0.1:6382 to 127.0.0.1:6381
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Trying to optimize slaves allocation <span class=k>for</span> anti-affinity
</span></span><span class=line><span class=cl><span class=o>[</span>WARNING<span class=o>]</span> Some slaves are in the same host as their master
</span></span><span class=line><span class=cl>M: eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: 8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: 851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>S: 7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382
</span></span><span class=line><span class=cl>   replicates 851d9155d0acc04d278dcbadd0e7c0642c40974a  <span class=c1>#127.0.0.1:6382这个节点是127.0.0.1:6381这个节点的副本</span>
</span></span><span class=line><span class=cl>S: 136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383
</span></span><span class=line><span class=cl>   replicates eb896ce4ed050f7135d298c7c09b5efc34233539
</span></span><span class=line><span class=cl>S: c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384
</span></span><span class=line><span class=cl>   replicates 8fec6b575bf196aa0648cfee4d1169c33ea88db1
</span></span><span class=line><span class=cl>Can I <span class=nb>set</span> the above configuration? <span class=o>(</span><span class=nb>type</span> <span class=s1>&#39;yes&#39;</span> to accept<span class=o>)</span>: yes
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Nodes configuration updated
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Assign a different config epoch to each node
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
</span></span><span class=line><span class=cl>Waiting <span class=k>for</span> the cluster to join
</span></span><span class=line><span class=cl>.....
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 127.0.0.1:6379<span class=o>)</span>
</span></span><span class=line><span class=cl>M: eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>M: 851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates eb896ce4ed050f7135d298c7c09b5efc34233539
</span></span><span class=line><span class=cl>S: 7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 851d9155d0acc04d278dcbadd0e7c0642c40974a
</span></span><span class=line><span class=cl>S: c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 8fec6b575bf196aa0648cfee4d1169c33ea88db1
</span></span><span class=line><span class=cl>M: 8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span></code></pre></div><p>登录节点查看集群信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># -c 参数指定以集群模式连接redis</span>
</span></span><span class=line><span class=cl>./redis-cli -c -p <span class=m>6379</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster info
</span></span><span class=line><span class=cl>cluster_state:ok
</span></span><span class=line><span class=cl>cluster_slots_assigned:16384
</span></span><span class=line><span class=cl>cluster_slots_ok:16384
</span></span><span class=line><span class=cl>cluster_slots_pfail:0
</span></span><span class=line><span class=cl>cluster_slots_fail:0
</span></span><span class=line><span class=cl>cluster_known_nodes:6
</span></span><span class=line><span class=cl>cluster_size:3
</span></span><span class=line><span class=cl>cluster_current_epoch:6
</span></span><span class=line><span class=cl>cluster_my_epoch:1
</span></span><span class=line><span class=cl>cluster_stats_messages_ping_sent:349
</span></span><span class=line><span class=cl>cluster_stats_messages_pong_sent:343
</span></span><span class=line><span class=cl>cluster_stats_messages_sent:692
</span></span><span class=line><span class=cl>cluster_stats_messages_ping_received:338
</span></span><span class=line><span class=cl>cluster_stats_messages_pong_received:349
</span></span><span class=line><span class=cl>cluster_stats_messages_meet_received:5
</span></span><span class=line><span class=cl>cluster_stats_messages_received:692
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster node
</span></span><span class=line><span class=cl><span class=o>(</span>error<span class=o>)</span> ERR Unknown subcommand or wrong number of arguments <span class=k>for</span> <span class=s1>&#39;node&#39;</span>. Try CLUSTER HELP.
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381@16381 master - <span class=m>0</span> <span class=m>1669534510801</span> <span class=m>3</span> connected 10923-16383
</span></span><span class=line><span class=cl>eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379@16379 myself,master - <span class=m>0</span> <span class=m>1669534511000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383@16383 slave eb896ce4ed050f7135d298c7c09b5efc34233539 <span class=m>0</span> <span class=m>1669534511830</span> <span class=m>5</span> connected
</span></span><span class=line><span class=cl>7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382@16382 slave 851d9155d0acc04d278dcbadd0e7c0642c40974a <span class=m>0</span> <span class=m>1669534511000</span> <span class=m>4</span> connected
</span></span><span class=line><span class=cl>c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384@16384 slave 8fec6b575bf196aa0648cfee4d1169c33ea88db1 <span class=m>0</span> <span class=m>1669534511000</span> <span class=m>6</span> connected
</span></span><span class=line><span class=cl>8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380@16380 master - <span class=m>0</span> <span class=m>1669534512855</span> <span class=m>2</span> connected 5461-10922
</span></span></code></pre></div><h3 id=验证-1>验证<a hidden class=anchor aria-hidden=true href=#验证-1>#</a></h3><h4 id=验证设置获取值>验证设置/获取值<a hidden class=anchor aria-hidden=true href=#验证设置获取值>#</a></h4><p>在<code>127.0.0.1:6379</code>节点上执行<code>./redis-cli -c -p 6379</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./redis-cli -c -p <span class=m>6379</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> k1 v1   <span class=c1>#在redis分片集群模式下设置值会对key计算hash以确定会被存储到哪个分片上</span>
</span></span><span class=line><span class=cl>-&gt; Redirected to slot <span class=o>[</span>12706<span class=o>]</span> located at 127.0.0.1:6381
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; get k1  <span class=c1>#获取值时也会对key去hash计算数据存储在那个节点上，如果不在当前节点会redirect到相应的节点</span>
</span></span><span class=line><span class=cl>-&gt; Redirected to slot <span class=o>[</span>12706<span class=o>]</span> located at 127.0.0.1:6381
</span></span><span class=line><span class=cl><span class=s2>&#34;v1&#34;</span>
</span></span></code></pre></div><p>直连<code>127.0.0.1:6379</code>节点查看<code>keys *</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./redis-cli -p <span class=m>6379</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; keys *
</span></span><span class=line><span class=cl><span class=o>(</span>empty array<span class=o>)</span>   <span class=c1>#说明k1不是存在该节点上</span>
</span></span></code></pre></div><p>直连<code>127.0.0.1:6381</code>节点查看<code>keys *</code>(分片master节点)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./redis-cli -p <span class=m>6381</span>
</span></span><span class=line><span class=cl>127.0.0.1:6381&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k1&#34;</span> <span class=c1>#说明k1是存在该节点上</span>
</span></span></code></pre></div><p>直连<code>127.0.0.1:6382</code>节点查看<code>keys *</code>(分片slave节点 验证分片数据是否保存到了分片副本上)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./redis-cli -p <span class=m>6382</span>
</span></span><span class=line><span class=cl>127.0.0.1:6382&gt; keys *
</span></span><span class=line><span class=cl>1<span class=o>)</span> <span class=s2>&#34;k1&#34;</span> <span class=c1>#说明分片上的数据会全部同步到分片副本上</span>
</span></span></code></pre></div><h4 id=验证分片的master节点下线后集群状态>验证分片的master节点下线后集群状态<a hidden class=anchor aria-hidden=true href=#验证分片的master节点下线后集群状态>#</a></h4><p>由于通过<code>cluster nodes</code>命令知道<code>127.0.0.1:6382</code>这个节点是<code>127.0.0.1:6381</code>master的副本，那么kill <code>127.0.0.1:6381</code> 这个节点即可验证<code>127.0.0.1:6382</code>这个节点会不会成为master</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ps -ef<span class=p>|</span>grep redis
</span></span><span class=line><span class=cl>root      <span class=m>23270</span>      <span class=m>1</span>  <span class=m>0</span> 15:27 ?        00:00:03 ./redis-server *:6379 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>23297</span>      <span class=m>1</span>  <span class=m>0</span> 15:28 ?        00:00:03 ./redis-server *:6380 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>23305</span>      <span class=m>1</span>  <span class=m>0</span> 15:28 ?        00:00:03 ./redis-server *:6381 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>23315</span>      <span class=m>1</span>  <span class=m>0</span> 15:28 ?        00:00:03 ./redis-server *:6382 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>23321</span>      <span class=m>1</span>  <span class=m>0</span> 15:28 ?        00:00:03 ./redis-server *:6383 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>23329</span>      <span class=m>1</span>  <span class=m>0</span> 15:28 ?        00:00:03 ./redis-server *:6384 <span class=o>[</span>cluster<span class=o>]</span>
</span></span><span class=line><span class=cl>root      <span class=m>24215</span>   <span class=m>7340</span>  <span class=m>0</span> 15:49 pts/2    00:00:00 ./redis-cli -p <span class=m>6381</span>
</span></span><span class=line><span class=cl>root      <span class=m>24261</span>   <span class=m>2409</span>  <span class=m>0</span> 15:51 pts/0    00:00:00 grep --color<span class=o>=</span>auto redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>kill</span> <span class=m>23305</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./redis-cli -c -p <span class=m>6379</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; 
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381@16381 master,fail - <span class=m>1669535502496</span> <span class=m>1669535497392</span> <span class=m>3</span> disconnected  <span class=c1>#节点下线了</span>
</span></span><span class=line><span class=cl>eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379@16379 myself,master - <span class=m>0</span> <span class=m>1669535551000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383@16383 slave eb896ce4ed050f7135d298c7c09b5efc34233539 <span class=m>0</span> <span class=m>1669535551055</span> <span class=m>5</span> connected
</span></span><span class=line><span class=cl>7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382@16382 master - <span class=m>0</span> <span class=m>1669535550035</span> <span class=m>7</span> connected 10923-16383  <span class=c1>#节点成为分片的master</span>
</span></span><span class=line><span class=cl>c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384@16384 slave 8fec6b575bf196aa0648cfee4d1169c33ea88db1 <span class=m>0</span> <span class=m>1669535549014</span> <span class=m>6</span> connected
</span></span><span class=line><span class=cl>8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380@16380 master - <span class=m>0</span> <span class=m>1669535552077</span> <span class=m>2</span> connected 5461-10922
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; get k1
</span></span><span class=line><span class=cl>-&gt; Redirected to slot <span class=o>[</span>12706<span class=o>]</span> located at 127.0.0.1:6382
</span></span><span class=line><span class=cl><span class=s2>&#34;v1&#34;</span>
</span></span></code></pre></div><h4 id=验证分片的master节点下线后重新上线集群状态>验证分片的master节点下线后重新上线集群状态<a hidden class=anchor aria-hidden=true href=#验证分片的master节点下线后重新上线集群状态>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>./redis-server /storehouse/redis_t/cluster/redis-cluster-6381.conf
</span></span><span class=line><span class=cl>24436:C <span class=m>27</span> Nov <span class=m>2022</span> 15:55:52.538 <span class=c1># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
</span></span><span class=line><span class=cl>24436:C <span class=m>27</span> Nov <span class=m>2022</span> 15:55:52.538 <span class=c1># Redis version=6.0.0, bits=64, commit=00000000, modified=0, pid=24436, just started</span>
</span></span><span class=line><span class=cl>24436:C <span class=m>27</span> Nov <span class=m>2022</span> 15:55:52.538 <span class=c1># Configuration loaded</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./redis-cli -c -p <span class=m>6379</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>851d9155d0acc04d278dcbadd0e7c0642c40974a 127.0.0.1:6381@16381 slave 7fffe89ccf2247acd1612f1692c6972dc37af78a <span class=m>0</span> <span class=m>1669535779000</span> <span class=m>7</span> connected    <span class=c1>#原master节点上线后成为分片slave节点</span>
</span></span><span class=line><span class=cl>eb896ce4ed050f7135d298c7c09b5efc34233539 127.0.0.1:6379@16379 myself,master - <span class=m>0</span> <span class=m>1669535777000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>136fd46e678c22319b1db4d34efe1a7bc44c988c 127.0.0.1:6383@16383 slave eb896ce4ed050f7135d298c7c09b5efc34233539 <span class=m>0</span> <span class=m>1669535779717</span> <span class=m>5</span> connected
</span></span><span class=line><span class=cl>7fffe89ccf2247acd1612f1692c6972dc37af78a 127.0.0.1:6382@16382 master - <span class=m>0</span> <span class=m>1669535778000</span> <span class=m>7</span> connected 10923-16383
</span></span><span class=line><span class=cl>c599010190b588c4f47ecae2b838e7e113e00683 127.0.0.1:6384@16384 slave 8fec6b575bf196aa0648cfee4d1169c33ea88db1 <span class=m>0</span> <span class=m>1669535778692</span> <span class=m>6</span> connected
</span></span><span class=line><span class=cl>8fec6b575bf196aa0648cfee4d1169c33ea88db1 127.0.0.1:6380@16380 master - <span class=m>0</span> <span class=m>1669535777671</span> <span class=m>2</span> connected 5461-10922
</span></span></code></pre></div><h3 id=使用-3>使用<a hidden class=anchor aria-hidden=true href=#使用-3>#</a></h3><h4 id=python3>python3<a hidden class=anchor aria-hidden=true href=#python3>#</a></h4><p>安装依赖：<code>pip3 install rediscluster</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>rediscluster</span> <span class=kn>import</span> <span class=n>RedisCluster</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>startup_nodes</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span><span class=mi>6379</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span><span class=mi>6380</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span><span class=mi>6381</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span><span class=mi>6382</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span><span class=mi>6383</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;host&#34;</span><span class=p>:</span><span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span><span class=mi>6384</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=c1># 连接集群</span>
</span></span><span class=line><span class=cl><span class=n>conn</span> <span class=o>=</span> <span class=n>RedisCluster</span><span class=p>(</span><span class=n>startup_nodes</span><span class=o>=</span><span class=n>startup_nodes</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=s2>&#34;py-cluster-k1&#34;</span><span class=p>,</span> <span class=s2>&#34;py-cluster-v1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ret</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;py-cluster-k1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>ret</span><span class=p>)</span>
</span></span></code></pre></div><p>执行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>python3 conn-cluster-redis.py 
</span></span><span class=line><span class=cl>True
</span></span><span class=line><span class=cl>py-cluster-v1
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://moyuduo.github.io/>Moyuduo's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>