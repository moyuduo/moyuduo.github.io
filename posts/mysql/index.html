<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Mysql | Moyuduo's Blog</title><meta name=keywords content><meta name=description content="Mysql centos7下安装mysql 下载MySQL安装包
wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 把安装包解压
#如果不知道安装包下载的位置可以使用 find / -name mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 查看 tar -zxvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 在/usr/local/下新建/usr/local/mysql
mkdir -p /usr/local/mysql 把解压的安装包移动到/usr/local/mysql/mysql57目录下，并授权
mv mysql-5.7.24-linux-glibc2.12-x86_64 //usr/local/mysql/mysql57 chown -R mysql.mysql /usr/local/mysql/mysql57 在/usr/local/mysql/mysql57下新建data目录用于存放数据库数据
mkdir data 初始化mysql,初始化成功后会显示默认密码
cd /usr/local/mysql/mysql57/bin ./mysqld --initialize --user=mysql --datadir=/usr/local/mysql/mysql57/data --basedir=/usr/local/mysql/mysql57 检查my.cnf文件
vim /etc/my/cnf [mysqld] basedir=/usr/local/mysql/mysql57 #datadir=/usr/local/mysql/mysql57/data datadir=/data/mysql2 port = 3306 sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES symbolic-links=0 max_connections=400 innodb_file_per_table=1 server_id=1 log_bin=mysql-bin binlog_format=row 添加软连接，启动mysql
ln -s /usr/local/mysql//mysql57/support-files/mysql.server /etc/init.d/mysqld ln -s /usr/local/mysql//mysql57/bin/mysql /usr/bin/mysql 启动mysql
service mysql start 登录mysql
mysql -uroot -p 修改默认密码"><meta name=author content="Me"><link rel=canonical href=https://moyuduo.github.io/posts/mysql/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Mysql"><meta property="og:description" content="Mysql centos7下安装mysql 下载MySQL安装包
wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 把安装包解压
#如果不知道安装包下载的位置可以使用 find / -name mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 查看 tar -zxvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 在/usr/local/下新建/usr/local/mysql
mkdir -p /usr/local/mysql 把解压的安装包移动到/usr/local/mysql/mysql57目录下，并授权
mv mysql-5.7.24-linux-glibc2.12-x86_64 //usr/local/mysql/mysql57 chown -R mysql.mysql /usr/local/mysql/mysql57 在/usr/local/mysql/mysql57下新建data目录用于存放数据库数据
mkdir data 初始化mysql,初始化成功后会显示默认密码
cd /usr/local/mysql/mysql57/bin ./mysqld --initialize --user=mysql --datadir=/usr/local/mysql/mysql57/data --basedir=/usr/local/mysql/mysql57 检查my.cnf文件
vim /etc/my/cnf [mysqld] basedir=/usr/local/mysql/mysql57 #datadir=/usr/local/mysql/mysql57/data datadir=/data/mysql2 port = 3306 sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES symbolic-links=0 max_connections=400 innodb_file_per_table=1 server_id=1 log_bin=mysql-bin binlog_format=row 添加软连接，启动mysql
ln -s /usr/local/mysql//mysql57/support-files/mysql.server /etc/init.d/mysqld ln -s /usr/local/mysql//mysql57/bin/mysql /usr/bin/mysql 启动mysql
service mysql start 登录mysql
mysql -uroot -p 修改默认密码"><meta property="og:type" content="article"><meta property="og:url" content="https://moyuduo.github.io/posts/mysql/"><meta property="og:image" content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-27T16:16:14+08:00"><meta property="article:modified_time" content="2022-11-27T16:16:14+08:00"><meta property="og:site_name" content="Moyuduo's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Mysql"><meta name=twitter:description content="Mysql centos7下安装mysql 下载MySQL安装包
wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 把安装包解压
#如果不知道安装包下载的位置可以使用 find / -name mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 查看 tar -zxvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 在/usr/local/下新建/usr/local/mysql
mkdir -p /usr/local/mysql 把解压的安装包移动到/usr/local/mysql/mysql57目录下，并授权
mv mysql-5.7.24-linux-glibc2.12-x86_64 //usr/local/mysql/mysql57 chown -R mysql.mysql /usr/local/mysql/mysql57 在/usr/local/mysql/mysql57下新建data目录用于存放数据库数据
mkdir data 初始化mysql,初始化成功后会显示默认密码
cd /usr/local/mysql/mysql57/bin ./mysqld --initialize --user=mysql --datadir=/usr/local/mysql/mysql57/data --basedir=/usr/local/mysql/mysql57 检查my.cnf文件
vim /etc/my/cnf [mysqld] basedir=/usr/local/mysql/mysql57 #datadir=/usr/local/mysql/mysql57/data datadir=/data/mysql2 port = 3306 sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES symbolic-links=0 max_connections=400 innodb_file_per_table=1 server_id=1 log_bin=mysql-bin binlog_format=row 添加软连接，启动mysql
ln -s /usr/local/mysql//mysql57/support-files/mysql.server /etc/init.d/mysqld ln -s /usr/local/mysql//mysql57/bin/mysql /usr/bin/mysql 启动mysql
service mysql start 登录mysql
mysql -uroot -p 修改默认密码"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://moyuduo.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Mysql","item":"https://moyuduo.github.io/posts/mysql/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Mysql","name":"Mysql","description":"Mysql centos7下安装mysql 下载MySQL安装包\nwget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 把安装包解压\n#如果不知道安装包下载的位置可以使用 find / -name mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 查看 tar -zxvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 在/usr/local/下新建/usr/local/mysql\nmkdir -p /usr/local/mysql 把解压的安装包移动到/usr/local/mysql/mysql57目录下，并授权\nmv mysql-5.7.24-linux-glibc2.12-x86_64 //usr/local/mysql/mysql57 chown -R mysql.mysql /usr/local/mysql/mysql57 在/usr/local/mysql/mysql57下新建data目录用于存放数据库数据\nmkdir data 初始化mysql,初始化成功后会显示默认密码\ncd /usr/local/mysql/mysql57/bin ./mysqld --initialize --user=mysql --datadir=/usr/local/mysql/mysql57/data --basedir=/usr/local/mysql/mysql57 检查my.cnf文件\nvim /etc/my/cnf [mysqld] basedir=/usr/local/mysql/mysql57 #datadir=/usr/local/mysql/mysql57/data datadir=/data/mysql2 port = 3306 sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES symbolic-links=0 max_connections=400 innodb_file_per_table=1 server_id=1 log_bin=mysql-bin binlog_format=row 添加软连接，启动mysql\nln -s /usr/local/mysql//mysql57/support-files/mysql.server /etc/init.d/mysqld ln -s /usr/local/mysql//mysql57/bin/mysql /usr/bin/mysql 启动mysql\nservice mysql start 登录mysql\nmysql -uroot -p 修改默认密码","keywords":[],"articleBody":"Mysql centos7下安装mysql 下载MySQL安装包\nwget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 把安装包解压\n#如果不知道安装包下载的位置可以使用 find / -name mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 查看 tar -zxvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 在/usr/local/下新建/usr/local/mysql\nmkdir -p /usr/local/mysql 把解压的安装包移动到/usr/local/mysql/mysql57目录下，并授权\nmv mysql-5.7.24-linux-glibc2.12-x86_64 //usr/local/mysql/mysql57 chown -R mysql.mysql /usr/local/mysql/mysql57 在/usr/local/mysql/mysql57下新建data目录用于存放数据库数据\nmkdir data 初始化mysql,初始化成功后会显示默认密码\ncd /usr/local/mysql/mysql57/bin ./mysqld --initialize --user=mysql --datadir=/usr/local/mysql/mysql57/data --basedir=/usr/local/mysql/mysql57 检查my.cnf文件\nvim /etc/my/cnf [mysqld] basedir=/usr/local/mysql/mysql57 #datadir=/usr/local/mysql/mysql57/data datadir=/data/mysql2 port = 3306 sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES symbolic-links=0 max_connections=400 innodb_file_per_table=1 server_id=1 log_bin=mysql-bin binlog_format=row 添加软连接，启动mysql\nln -s /usr/local/mysql//mysql57/support-files/mysql.server /etc/init.d/mysqld ln -s /usr/local/mysql//mysql57/bin/mysql /usr/bin/mysql 启动mysql\nservice mysql start 登录mysql\nmysql -uroot -p 修改默认密码\nmysql -uroot -p mysql\u003e alter user 'root'@'localhost' identified by 'lpt316'; Query OK, 0 rows affected (0.00 sec) 添加一个远程连接账号，默认root账号只能本地连接\ngrant all privileges on *.* to 'root'@'%' identified by 'lpt316' with grant option; #刷新权限表 flush privileges; firewalld添加开发端口供远程连接使用\nfirewall-cmd --zone=public --add-port=3306/tcp --permanent firewall-cmd --reload 设置开机自启动\ncp /usr/local/mysql/mysql57/support-files/mysql.server /etc/init.d/mysql chmod +x /etc/init.d/mysql chkconfig --add mysql chkconfig --list DDL 建库 create database stu charset utf8 collate utf8_bin; CREATE DATABASE test3 CHARSET=utf8; #collate指定排序规则\tutf8_bin为区分大小写\tutf8_general_ci不区分大小写 #查看数据库字符集 show charset database stu; 修改数据库 alter database stu charset utf8; 删除库 drop database stu; 建表 CREATE TABLE test3.t1(num INT)ENGINE INNODB CHARSET utf8; create table student( id int not null primary key auto_increment comment '学号', sname varchar(255) not null comment '姓名', sage tinyint unsigned not null default 0 comment '年龄', sgender enum('m','f','n') not null default 'n' comment '性别', id_card char(18) not null unique comment '身份证', enter_time timestamp not null default now() comment '入学时间' ) engine=innodb charset=utf8 comment '学生表'; 建库和建表语句指定字符、引擎等可以使用=也可以隔一个空格\n修改表 #添加qq列 alter table student add qq varchar(20) not null unique comment 'QQ号码'; #在sname后添加微信号列 alter table student add wechat varchar(64) not null unique comment '微信号码' after sname; #在id列前添加phone列(第一列) alter table student add phone varchar(15) not null unique comment '电话号码' first; #修改列 alter table user modify column birth varchar(20); #删除数据列(需要进行数据迁移，效率极差) alter table drop phone; 查看表信息 #查看数据库中所有表 show tables; desc student; #查看建表语句 show create table student; 删表 drop table student; DCL grant #identified by '123'表示创建并授权\tgrant option表示可以把自己有的权限授予其他用户 grant all on *.* to root@'%' identified by '123' with grant option; revoke revoke delete on *.* from root@'%'; 修改密码 #set password for 用户@地址=password(新密码); set password for root@localhost=password('123'); #mysqladmin -P端口号 -u用户 -p原密码 password 新密码\t-P参数如果端口号默认3306也可以不指定 mysqladmin -P3307 -uroot -p123 password 456 DML 插入数据 #在插入数据之前通常使用 desc student；查看表定义 # 录入一条数据 insert into student(sname,id_card,qq,wechat,phone) values ('张三','1234567891012345678','12345678910','12345678910','12345678910'); #插入多行 insert into student(sname,id_card,qq,wechat,phone) values ('张三','1234567891012345678','12345678910','12345678910','12345678910')， ('李四','1234567891012345678','12345678910','12345678910','12345678910')； 更新数据 #在更新数据之前通常使用 desc student；查看表定义 #更新数据一定要带条件，否则会改全表 update student set sname='zhangsan' where id=1; 删除数据 delete from student; truncate table student; #区别 #delete是逻辑性删除，逐行进行删除，速度慢 #truncate是对表段中数据页进行清空,速度快 #数据的伪删除，使用一个字段来标识数据行是否被删除 alter table student add is_deleted tinyint not null default 0; DQL 单独使用 # 使用select @@xxx 查看系统参数 select @@port; select @@basedir; select @@datadir; SELECT @@socket; SELECT @@server_id; #使用函数 select now(); select database(); select user(); select concat(user,'@',host) from mysql.user; 查询所有数据 #查询所有数据，大表谨慎使用 select * from student; 比较操作符 select * from student where id\u003e10; #不等于可以使用\u003c\u003e 或 != select * from student where id\u003c\u003e10; 逻辑运算符 select * from student where id=1 and sname='张三'; select * from student where id=1 or id=13; 模糊查询 #查询姓张的 select * from student where sname like '张%'; #查询姓名是两个子，且结尾为三 select * from student where sname like '_三'; #模糊查询中%和_区别是\t%表示可以是多个字符\t_只表示一个字符 #注意%不能放在模糊查询的最前面，因为不走索引 in #查询张三或李四的信息 select * from student where sname in('张三','李四'); between #查询id在11-12之间的 #between包括前后边界 select * from student where id between 11 and 12; group by + 聚合函数 #在sql中where语句必须放在group by之前 #按年龄统计人数 select sage,count(1) from student group by sage; #统计所有男性女性的年龄总和 select sgender,sum(sage) from student group by sgender; #查询男性和女性的平均年龄 select sgender,avg(sage) from student group by sgender; #查询男性女性年龄的最大值 select sgender,max(sage) from student group by sgender; #查询男性女性年龄的最小值 select sgender,min(sage) from student group by sgender; #按年龄统计名字 select sage,group_concat(sname) from student group by sage; #统计年龄\u003e=20岁男性女性人数 select sgender,count(1) from student where sage\u003e=20 group by sgender; #统计年龄\u003e=20岁男性女性人数 #这两个相同的问题可以使用不同的思路解决，可以选选择在分组\t或者 先分组再选择\thaving语句只能用于分组列的条件比较 # having语句的条件不走索引 select sgender,count(1) from student group sage having sage\u003e=20; order by #按年龄升序排序,默认升序 select * from student order by sage; #按年龄降序排序 select * from student order by sage desc; #把女性按年龄进行分组并按各个年龄人数降序排序 select sage,count(1) from student where sgender='f' group by sage order by count(1) desc; limit #查询年龄最大的三个人 select * from student order by sage desc limit 3; #查询年龄第2-3大的两人 select * from student order by sage desc limit 1,2; --limit 1,2 表示跳过一个，取两个 select * from student order by sage desc limit 2 offset 1;\t--limit 2 offset 1表示去两个跳过一个 distinct select sage from student;--有重复的 select distinct sage from student;--去重 #distinct会验证所有字段，只有当所有字段相同才判定为相同的，去重 union #查询年龄为18或性别为女性的人 select * from student where sage=18 union select * from student where sgender='f'; #union 前后查询语句的字段必须相同 # union和union all的区别是union会进行去重，而union all不进行去重 #一般情况下我们把in或or改写为union all语句提高效率 连接查询 笛卡尔积 把两张表联系起来，列为两表之和，行为两表之积\n表A：\na b 1 2 3 4 表B：\nc d 5 6 7 8 select * from a,b; #等值连接不写条件也是笛卡尔积 select * from a join b; a b c d 1 2 5 6 3 4 5 6 1 2 7 8 3 4 7 8 内连接 等值连接 两表连接的条件是\t=\nselect * from student join sc on student.sno=sc.sno; 自然连接 在等值连接中，相同的两个字段没有必要重复出现,等值连接会自动去比较字段名相同数据类型相同的列，如果有多列字段名相同字段类型相同的列，对应列必须相等才会连接\nselect * from student natural join sc; sno字段只出现一次\n不等值连接 两表连接的条件是 \u003e\t\u003e=\t\u003c\t\u003c=\t\u003c\u003e或！= 表A：\na b 1 1 2 6 表B：\nc d 3 7 4 8 select * from a join b on a.b\u003eb.c; a b c d 2 6 3 7 2 6 4 8 外连接 左外连接 左外连接会从左表返回所有行，即使右表没有匹配，如果有表没有匹配，那么字段值为null\nselect * from student left join sc on student.sno=sc.sno; 右外连接 右外连接会从右表返回所有行，即使左表没有匹配，如果没有匹配，那么做表字段全为null\nselect * from student right join sc on student.sno=sc.sno; 全连接 左外连接和右外连接的并集，即左表没有比配，那么左表字段值全为null，如果右表没有匹配，那么右表字段值全为null\nmysql中没有全连接，但是可以通过左外连接union右外连接实现\nselect * from student left join sc on student.sno=sc.sno union select * from student right join sc on student.sno=sc.sno; show #查看数据库 show databases; #查看数据库下的表 show tables; #查看表的创建语句 show create table student; #查看可用字符集 show charset; #查看排序规则 show collation; #查看数据库存储引擎 show engines; #查看数据库连接情况 show processlist; #查看索引 show index from student; #查看授权 show grant for root@'localhost'; #查看数据库状态 show status; #查看配置信息 show variables; 三范式 第一范式 数据的每一列都需要保持原子性不可拆分 如在某些场景下地址可再拆分为省、市、县，即不满足第一范式\n第二范式 非主属性比如完全依赖主键\n如表：\n学号 姓名 性别 院系 课程 成绩 1 tom 男 计算机系 程序设计 90 1 tom 男 计算机系 数据库 80 该表的主键为\u003c学号,课程\u003e，非主属性为姓名、性别、院系、成绩，其中非主属性姓名、性别、院系部分依赖于主属性\u003c学号\u003e，所以这一张表还应该进行拆分\n第三范式 所有的非主属性不依赖于其他非主属性\n如表：\n学号 姓名 性别 院系 院系主任 1 tom 男 计算机系 张三 在该表中主键为学号，其他列都是非主属性，而非主属性列院系主任依赖于非主属性列院系，所以不符合第三范式，应该进行拆分\n索引 种类 B树索引 Hash索引 R树索引 Fulltext Gis BTree B树属于多路查找树，由根、枝、叶节点组成。\nB+Tree 在范围查询时提供更好的性能（\u003e \u003e= \u003c \u003c= like）\nB+树是在B树的基础上，在叶子节点上加上了访问下一个叶子节点的指针，使得遍历时不需要再从根节点进行遍历。\nB*Tree B*树是在B+树的基础上，在枝节点加上了访问下一个枝节点的指针，使得遍历时不需要再从根节点进行遍历。\n聚集索引 数据表创建了聚集索引，那么数据行就会按照聚集索引顺序存放。\n在建表时，建议创建一个数值类型的主键，这时就会创建聚集索引。\n一个表只能创建一个聚集索引，创建了聚集索引后行的插入是按照聚集索引列值的顺序进行存储的，索引表中的数据行都是按照聚集索引列值的递增顺序存放的。\n由于索引表中的数据行都是按照聚集索引列值的递增顺序存放的，所以聚集索引B+树的叶子节点是直接存放的数据页。\n创建聚集索引过程 创建数据行 根据主键在磁盘页中顺序存储数据行 根据数据页创建B+树的枝节点 根据枝节点创建根节点 辅助索引 创建辅助索引过程 取出索引列值，进行排序 创建B+树叶子节点，并将索引列值和对应数据页存入叶子节点 根据叶子节点创建枝节点 根据枝节点创建根节点 如果创建辅助索引的表已经创建了聚集索引，那么叶子节点存储的就是索引列值和对应的聚集索引列值，当查询时，根据辅助索引拿到聚集索引列值，在去聚集索引中查找，由于聚集索引的叶子节点直接存储数据页，不同于辅助索引存储页码，减少了回表操作\n当列需要作为条件频繁的进行查询时，可以考虑建立索引，但是还需要考虑是否列要频繁进行更新，因为更新操作需要更新所有树，导致锁定索引树，这种情况是否需要建立索引还需要进行一定的权衡\n单列索引 为需要进行查询的一列建立的所有\nALTER TABLE student ADD INDEX idx_sname(sname); ALTER TABLE student DROP INDEX idx_sname; 前缀索引 只去列的前几个字符建立索引，列数据类型必须是字符串\nALTER TABLE student ADD INDEX idx_sname(sname(5)); 联合索引 当需要进行多条件查询时\nALTER TABLE student ADD INDEX idx_n_a_g(name,age,gender); select * from student where name='xxx' and age=20 and gender='m'; 唯一索引 ALTER TABLE student ADD unique INDEX idx_telphone(telphone); 聚集索引和辅助索引的区别 聚集索引一个表只能有一个，辅助索引可以有多个，一般配合聚集索引使用 聚集索引的叶子节点就是磁盘数据行存储的数据页 Mysql是根据聚集索引组织存储数据，数据行存储时就是按照聚集索引列值的顺序进行存储 创建索引时，聚集索引列值本身就是有序的，而辅助索引需要对列值进行排序 执行计划分析 在查询语句前加desc可以查看查询语句的执行相关信息\nDESC SELECT * FROM t_100w WHERE k2='STOP'; 相关查询结果列：\ntable\t查询语句使用的数据库\ntype\t查询的类型\nALL全表扫描\nindex全索引扫描\nrange索引范围扫描 聚集索引：\u003c\u003e not in 辅助索引：\u003e \u003c \u003e= \u003c= like in or\nref非唯一性等值索引\neq_ref在多表连接时，连接条件使用了唯一索引（unique,pk）\nconst唯一索引的等值查询\npossible_keys 可能会用到的索引\nkey\t使用的索引\nextra\t额外信息\n当查询语句使用了条件并且有排序或分组时，可以使用联合索引来优化\n不走索引的情况 查询条件没有建立索引 查询结果集是原表中的大部分数据，25%以上 索引失效，统计数据不真实，索引具有自我维护的功能，对于频繁更新的列建立的所有，频繁的更新可能导致所有失效，这个时候一般是删除索引，频繁更新的列不适合建立索引 在索引类的条件查询，条件使用了函数或者对所有列进行计算 select * from student where id-1=9; 隐式转换 #telphone列数据类型是char(11) select * from student where telphone=12345678910; 对于辅助索引，\u003c\u003e、in、not in不走索引，这种情况可以把in改写成union all like “%xx”like语句%在最前面不走索引 存储引擎 可以通过\nselect @@default_storage_engine; 查看数据库引擎\n功能 数据读写 数据安全和一致性 提高性能 热备份 自动故障恢复 高可用 在Mysql5.5版本以后，数据库默认引擎为InnoDB，提供高可靠性和高性能。\nInnoDB引擎 特点： 支持事务 InnoDB锁粒度为行级锁 聚集索引组织表 支持外键，保证多表数据一致性 支持CSR（故障自动恢复） 支持数据热备份 事务的ACID特性 Atomic（原子性）：所有语句作为一个单元，全部成功或全部失败 Consistent（一致性）：如果数据库事务开始处于一致状态，则在执行事务期间保留一致状态 Isolated（隔离性）：事务之间不相互影响 Durable（持久性）：事务成功后，所有的更改将记录到数据库中。 四种隔离级别 Read Uncommited：在该隔离级别下，所有事务都可以看到其他未提交事务的执行结果，称之为脏读。 Read Commited：该隔离级别为大多数数据库默认的隔离级别(mysql中不是)，该隔离级别下一个事务能够读取到其他事务已经提交了的数据。但是这种隔离级别会造成不可重复读现象， 即：在个事务中先查询了某一部分记录，然后其他的事务修改了这一部分数据，并且提交了，那么这些修改对当前事务都是可见的，当再次查询这部分记录是，和之前的查询不一样了，即在同一个事务内 两次相同的查询得到不一样的数据。 Repeatable Read:该隔离级别是mysql默认的隔离级别，即在同一个事务内读取数据并不会受到其他事务的影响，都会读取到一致的记录。但是该隔离级别会导致幻读：事务A根据条件修改了数据，此时事务B刚好插入了该范围内的数据，当事务A再次查询修改的数据时，发现同样的条件任然有一部分数据没有被修改。 Serializable：通过强制事务排序，使之不可能相互冲突，从而解决幻读问题。简言之，它是在每个读的数据行上加上共享锁。在这个级别，可能导致大量的超时现象和锁竞争。 Mysql默认采用REPEATABLE_READ隔离级别\n事务的开启结束 begin --开启事务，Mysql5.5以后默认自动开启事务，可以不写 commit --提交事务 rollback --回滚事务，把执行了的操作都撤销，恢复到开始事务状态 自动提交策略 Mysql中默认开启了自动提交策略\n#可以通过以下语句查看Mysql是否开启了事务自动提交，0表示关闭自动提交，1表示开启了自动提交 SELECT @@autocommit; #可以通过以下语句设置当前连接不开启事务自动提交 set autocommit=0; #可以通过以下语句设置数据库全局关闭事务自动提交 set global autocommit=0; 事务的实现原理 事务是基于重做日志(redo log)和回滚日志(undo log)来实现的，每提交一个事务前必须将所有的操作记录到重做日志中再进行持久话，当发生故障时可以基于重做日志来进行回复保证事务的原子性和持久性 当修改事务是会产生回滚日志，如果需要回滚则根据回滚日志的反向语句进行逻辑操作，重做日志主要是保证数据的一致性\nredolog regolog不是随事务的提交才写入的，而是在事务的执行过程中，便开始写入redolog，具体的落盘策略可以进行配置，用来防止在发生故障的时候任然有脏页未写入磁盘，在重启mysql的时候会根据redolog进行重做，从而达到恢复未落盘数据的特性，保证数据的持久性\nundolog undolog用来回滚事务到记录的某个版本，在事务未提交之前，undolog保存了未提交之前的版本的数据，undolog中的数据可以作为旧版本数据的快照供其他并发事务进行快照读，undolog是为了实现事务的原子性的产物，在innodb存储引擎中用来实现多版本并发控制。\nbinlog Mysql的binlog是用来记录数据库表结构变更和表数据修改的二进制日志。binlog不会记录show、select这类操作，因为这类操作对表结构和表数据本身没有修改，但是可以通过查询通用日志来查看Mysql执行的所有语句。\nMysql的binlog以事件形式记录，包含语句执行的时间，Mysql的binlog是事务安全型的，binlog的主要目的是为了用于复制和恢复。\nbinlog有三种形式：\nstatement:基于sql语句的模式，某些语句如包含函数UUID的语句在复制和恢复的过程中会导致数据的不一致 row:基于行的模式，记录的是行的变化，很安全。在大表中清除大量数据时会在binlog中产生大量语句，导致在复制时从库的延迟变大 mixed:混合模式，根据语句来选择statement模式还是row模式 可以在事务中混用存储引擎吗？ 尽量不要在事务中使用多种存储引擎，Mysql的服务器层不管理事务，事务是由底层的存储引擎管理的，如果在一个事务中混用了存储引擎，如一个事务中包含堆事务型表的操作(innodb)和非事务型表的操作(myisam)，在正常的提交下没有问题，但是如果事务需要回滚，非事务型的表的变更无法撤销，会导致数据库处于不一致的状态\nMysql中是如何实现事务隔离的 Read Uncommited 和 Serialable 是基本不考虑的隔离级别，前者不加任何锁的限制，后者相当于单线程执行效率差，Mysql在 Read Commited 隔离级别通过行锁和间歇锁的组合(Next-Key)解决了幻读问题，\n间歇锁：使用间隙锁锁住的是一个区间，而不仅仅是这个区间中的每一条数据。 举例来说，假如emp表中只有101条记录，其empid的值分别是1,2,…,100,101，下面的SQL\nSELECT * FROM emp WHERE empid \u003e 100 FOR UPDATE 当我们用条件检索数据，并请求共享或排他锁时，InnoDB不仅会对符合条件的empid值为101的记录加锁，也会对empid大于101（这些记录并不存在）的“间隙”加锁。\n这个时候如果你插入empid等于102的数据的，如果那边事物还没有提交，那你就会处于等待状态，无法插入数据。\nMVCC MVCC即多版本并发控制，MVCC的实现是通过保存数据在某一个时间点的快照来实现的，根据事务开始的时间点不同，每个事务对同一表看到的数据可能是不相同的\n对于Innodb存储引擎聚簇索引记录包含三个隐藏的列：\nROW ID:隐藏的自增ID，如果表没有主键，Innodb会按照ROW ID产生一个聚集索引树。 事务ID，记录最后一次修改该记录的事务ID 回滚指针：指向这条记录的上一个版本 如图：首先 insert 语句向表 t1 中插入了一条数据，a 字段为 1，b 字段为 1， ROW ID 也为 1 ，事务 ID 假设为 1，回滚指针假设为 null。当执行 update t1 set b=666 where a=1 时，大致步骤如下：\n数据库会先对满足a=1的行加排他锁 复制原记录到undolog中 修改匹配到的行记录b的值为666，修改事务ID为当前事务的ID 修改隐藏回滚指针使其指向undolog中的上一条记录 提交事务，释放之前对满足a=1的行加的排他锁 Innodb的每一行都有一个隐藏的列回滚指针用于指向该行修改前的一个版本的数据，这个数据存储在undolog中，如果要执行更新操作哪个会把该行的记录复制到undolog中，修改完该行的数据之后会把回滚指针指向undolog中保存的该行的上一个版本记录，当其他事务需要查询时，通过回滚指针查询undolog中保存的上个版本的数据\nMVCC的最大好处是读不加锁，读写不冲突，极大地增加了Mysql的并发性，通过MVCC保证了事务ACID中的I隔离性\nMyISAM引擎 特点： 不支持事务 只能支持表锁 不支持外键 每个表用三个文件存储，.frm文件存储表定义，.MYD文件存储数据，.MYI文件存储索引 查询数据库的表的引擎 SELECT table_schema,table_name,ENGINE FROM information_schema.TABLES WHERE table_schema='xxx'; 修改表的存储引擎 alter table xxx engine innodb; 缓冲区池 #查看缓冲区池大小 select @@innodb_buffer_pool_size; 日志 错误日志 记录一些error和warn信息\n默认是开启的\n#查看错误日志目录 SELECT @@log_error; #这个参数不可以使用 set global log_error=xxx这样的方式修改，只能修改配置文件然后重启mysql #配置文件在basedir对应的路径下，可以使用select @@basedir查看 #windows下的配置文件是my.ini文件，linux下配置文件是my.cnf #添加 log_error=xxx\\mysql.log 二进制日志 备份恢复需要依赖二进制日志 主从环境依赖二进制日志 默认没有开启\n#标志,0表示没开启，1表示开启 select @@log_bin; #日志路径及名字 select @@log_bin_basename; #服务id号 select @@server_id; #二进制格式 select @@binlog_format; #这几个参数也是必须要在配置文件中配置，不能再命令行修改 binlog记录的是什么？记录的是变更的sql语句，不记录查询日志。会记录DDL、DCL、DML，对于DDL和DCL是全部记录，但是对于DML只记录提交了的事务。\nbinlog_format指定二进制日志的格式，有row、statement、mixed三种，row是记录数据行的变化、statement原封不动的记录所有DML，这种模式不够严谨，可能出现数据不一致，因为他是记录sql，在恢复时相当于重新执行一遍sql，如果sql中有与时间相关的就可能出现数据不一致、mixed是row和statement的混合\n#查看所有二进制日志 show binary logs; show master logs; #刷新日志 flush logs; #查看正在使用的日志 show master status; #查看日志事件 show binlog events in 'mysql-bin.000003'; 从日志中恢复数据 在测试之前，应该确认二进制日志文件是否开启\n#0为关闭，1为开启 select @@log_bin; 如果没有开启要在mysql的配置文件中配置，windows下为my.ini，linux下为/etc/my.cnf，\n需要添加\tlog_bin=/xxxx\t配置二进制文件放置的位置,这个目录必须是datadir下的，不然会报错\nmysqlbinlog参数 --start-position\t截取的起始position --stop-position\t截取的终止position -d\t指定数据库的日志 mysqlbinlog --start-position=316 --stop-position=1018 /mysql-bin.0000xx \u003e /backup/ttt.sql 恢复 #创建表 CREATE TABLE `ttt` ( `sno` int(11) NOT NULL AUTO_INCREMENT, `sname` varchar(20) DEFAULT NULL, PRIMARY KEY (`sno`) )； #在新建的表中插入数据 insert into ttt values('aaa'),('bbb'),('ccc'); #删除数据库 drop table ttt; #查看正在使用的二进制日志 show master status; #查看日志判断误操作的位置 show binlog events in 'mysql-bin.0000xx'; #使用mysqlbinlog来生成sql mysqlbinlog --start-position=316 --stop-position=1018 /mysql-bin.0000xx \u003e /backup/ttt.sql #登录mysql使用source命令执行sql use xxx; set sql_log_bin=0;--关闭记录日志，恢复操作不需要记录日志 source /backup/ttt.sql; set sql_log_bin=1; #这样就把数据恢复了，从二进制日志中导出的sql是某一状态下操作的sql，所以要恢复必须要把数据恢复到某一时刻，然后执行二进制日志导出的sql，相当于在某一状态下，又把这些语句执行了一遍 #所以二进制文件通常配合备份一起使用 GTID gtid是在5.6添加的，主要是解决二进制日志文件中截取片段查找起点和终点position不方便的问题。\n在mysql5.7版本中gtid即使不开启也会自动生成\n#查看gtid SELECT @@gtid_next; ANONYMOUS gtid由两部分组成source_id ：transaction_id\tsource_id 为一个机器的唯一id，transaction_id是一个自增事务id 7E11FA47-31CA-19E1-9E56-C43AA21293967:29\n可以在mysql的配置文件,windows下为my.ini，linux下为my.cnf中显式添加配置\ngtid-mode=on\t开启gtid enforce-gtid-consistency=true\t强制gtid的一致性\nMaster [(none)]\u003ecreate database gtid charset utf8; Query OK, 1 row affected (0.01 sec) Master [(none)]\u003eshow master status ; +------------------+----------+--------------+------------------+----------------------------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+----------------------------------------+ | mysql-bin.000004 | 326 | | | dff98809-55c3-11e9-a58b-000c2928f5dd:1 | +------------------+----------+--------------+------------------+----------------------------------------+ 1 row in set (0.00 sec) Master [(none)]\u003euse gtid Database changed Master [gtid]\u003ecreate table t1 (id int); Query OK, 0 rows affected (0.01 sec) Master [gtid]\u003eshow master status ; +------------------+----------+--------------+------------------+------------------------------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+------------------------------------------+ | mysql-bin.000004 | 489 | | | dff98809-55c3-11e9-a58b-000c2928f5dd:1-2 | +------------------+----------+--------------+------------------+------------------------------------------+ 1 row in set (0.00 sec) Master [gtid]\u003ebegin; Query OK, 0 rows affected (0.00 sec) Master [gtid]\u003einsert into t1 values(1); Query OK, 1 row affected (0.00 sec) Master [gtid]\u003ecommit; Query OK, 0 rows affected (0.00 sec) Master [gtid]\u003eshow master status ; +------------------+----------+--------------+------------------+------------------------------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set | +------------------+----------+--------------+------------------+------------------------------------------+ | mysql-bin.000004 | 1068 | | | dff98809-55c3-11e9-a58b-000c2928f5dd:1-3 | +------------------+----------+--------------+------------------+------------------------------------------+ 1 row in set (0.00 sec) 可以看到每执行一条DDL、DCL就是一个事务，而执行DML时，只有事务提交了，那么事务号才增加\ngtid模式下是由mysqlbinlog来截取日志\n#--include-gtids是指定要截取的事务号范围，包括前界和后界，这里是截取1-6号事务日志 #--exclude-gtids是指定截取的事务号返回内需要跳过的事务号，多个需要跳过的使用，分割 #--skip-gtids是指定截取日志是跳过gtid，因为开启gtid后，如果是相同的gtid那么就不会再执行，如果不跳过，那么在恢复的时候会跳过这些事务 mysqlbinlog --skip-gtids --include-gtids='dff98809-55c3-11e9-a58b-000c2928f5dd:1-6' --exclude-gtids='dff98809-55c3-11e9-a58b-000c2928f5dd:4' /data/binlog/mysql-bin.000004 使用截取的日志sql来恢复\nset sql_log_bin=0; source /tmp/binlog.sql set sql_log_bin=1; slowlog 作用：记录慢SQL，定位低效SQL语句\n#查询slowlog是否开启，默认没开启 select @@slow_query_log; #查询慢语句日志目录 select @@slow_query_log_file; #查看慢查询语句时间阈值，超过这个阈值就是慢sql,默认为10秒 select @@long_query_time; #查询是否开启不走索引语句记录慢日志，0为关闭，1为开启 select @@log_queries_not_using_indexes; 需要在配置文件中添加相关配置\nslow_query_log=1 slow_query_log_file=C:\\Program Files (x86)\\MySQL\\MySQL Server 5.5\\slow.log long_query_time=0.2 log_queries_not_using_indexes=1 重启数据库\n执行一些耗时的sql后查看慢日志\nC:\\Program Files (x86)\\MySQL\\MySQL Server 5.5\\bin\\mysqld, Version: 5.5.28-log (MySQL Community Server (GPL)). started with: TCP Port: 3306, Named Pipe: (null) Time Id Command Argument C:\\Program Files (x86)\\MySQL\\MySQL Server 5.5\\bin\\mysqld, Version: 5.5.28-log (MySQL Community Server (GPL)). started with: TCP Port: 3306, Named Pipe: (null) Time Id Command Argument # Time: 200529 21:37:48 # User@Host: root[root] @ localhost [127.0.0.1] # Query_time: 1.233220 Lock_time: 0.013930 Rows_sent: 636438 Rows_examined: 636438 use oldboy; SET timestamp=1590759468; select * from t_100w; # Time: 200529 21:39:39 # User@Host: root[root] @ localhost [127.0.0.1] # Query_time: 0.338753 Lock_time: 0.000000 Rows_sent: 1 Rows_examined: 636438 SET timestamp=1590759579; select count(*) from t_100w; # Time: 200529 21:40:18 # User@Host: root[root] @ localhost [127.0.0.1] # Query_time: 0.449270 Lock_time: 0.000000 Rows_sent: 1 Rows_examined: 636438 SET timestamp=1590759618; select * from t_100w where id=10000; # Time: 200529 21:41:34 # User@Host: root[root] @ localhost [127.0.0.1] # Query_time: 0.503289 Lock_time: 0.000000 Rows_sent: 10 Rows_examined: 636448 SET timestamp=1590759694; select * from t_100w where id\u003c10000 order by k1 limit 10; 使用mysqldumpslow工具来分析慢日志\n#-s是指定排序规则\tc：按访问次数降序排序\tl：按锁定时间降序排序\tr：按返回记录降序排序\tal：平均锁定时间降序排序\tar：平均访问次数降序排序\tat：平均查询时间降序排序 #-t是指定显示条数 mysqldumpslow -s c -t 3 slow.log 备份 备份类型 热备份\n在数据库正常业务时，进行备份，并且能够保证数据一致性\n温备份\n锁表备份，只能查询不能增删改\n冷备份\n关闭数据库业务，在数据库没有任何变更的情况下进行备份\n备份方式 逻辑备份 基于sql进行备份\nmysqldump mysqlbinlog 物理备份 基于磁盘数据进行备份\nxtrabackup：percona第三方 逻辑备份和物理备份比较 mysqldump\n优点：\n​\t1不需要下载安装\n​\t2备份出来的是sql，可读性高\n​\t3压缩比高，节省磁盘空间\n缺点：\n​\t1依赖于数据库引擎，需要从磁盘把数据读出，然后转换成sql，耗费资源\n​\t2对于大量数据（100G以上）效率很差\nxtrabackup\n优点：\n​\t1类似于直接拷贝物理文件，不需要管逻辑结构，效率高\n​\t2由于是直接拷贝的物理文件，可读性差\n​\t3压缩比低，耗费更多的磁盘空间\nmysqldump 备份方式 -u -p -S -h -p #本地备份 mysqlsump -uroot -pxxx -S /temp/mysql.sock #远程备份\t在进行远程备份时，远程数据库版本必须和本地mysqldump命令数据库版本一致 mysqldump -uroot -pxxx -h 10.0.0.51 -P3306 全备份（全库） #\t-A参数全部数据库备份 mysqldump -uroot -pxxx -A \u003e dir/full.sql 单（多）库备份 #\t-B参数备份多个数据库 mysqldump -uroot -pxxx -B hello world \u003e dir/hellowordld.sql 单（多）表备份 #\t备份数据库下的单个或多个表 #\t备份stumanage下的student，course，sc三张表 #这种方式进行恢复的时候，数据库必须存在，且必须use才能source mysqldump -uroot -pxxx stumanage student course sc \u003e dir/tb.sql 按各个库的每张表生产一个备份语句 SELECT CONCAT('mysqldump -uroot -pxxx ',table_schema,' ',table_name,'\u003e/backup/',table_schema,'_',table_name,'.sql') FROM information_schema.tables WHERE table_schema NOT IN ('sys','information_schema','performance_schema') INTO OUTFILE '/backup/tb_back.sh'; mysqldump高级参数 -R\t备份存储过程及函数 --triggers\t备份触发器 -E\t备份事件 -F\t在备份的时候，刷新一个新的binlog日志 --master-date=2\t以注释的形式保存备份开启事件的binlog的position，方便恢复 --single-transaction\tinnodb存储引擎开启热备 mysqldump+binlog恢复数据库 先全备数据库stumanage\nmysqldump -uroot -pxxx -B stumanage --trigger -R -E --master-data=2 --single-transaction \u003e D:/backup/bak.sql 然后向表中插入一些数据\ninsert into stumanage.student values(11,'test11','男',11,'挖掘机工程')， (22,'test22','男',22,'水利工程')； #向另一些数据库的表中插入数据 insert into test.t1 values(1),(2),(3); #删除另一个数据库的表 drop table test.t2; 模拟误操作删除数据库stumanage\ndrop database stumanage; 分析日志\nmysql -uroot -pxxx -e \"show binlog events in 'mysql-bin.000010'\" |tail -100 |grep -i 'drop' 找到drop语句的开始position #在全备中找到备份时开始的position -- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000010', MASTER_LOG_POS=18166; 截取日志\n#\t-d stumanage指定只截取stumanage数据库的日志 mysqlbinlog -d stumanage --start-position=13732 --stop-position=19215 ../mysql-bin.000010 \u003e D:/backup/logbin.sql 恢复日志\n#登录mysql mysql -uroot -pxxx #关闭记录日志，恢复操作不需要记录日志 set sql_log_bin=0; #恢复全备 source D:/backup/bak.sql; #恢复日志备份 source D:/backup/logbin.sql; #开启日志记录 set sql_log_bin=1; XBK备份 安装 安装依赖包\nwget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL libev 下载rpm包\nwget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm 安装xbk\nyum -y install percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm 检查是否安装好\ninnobackupex --version 全备 #默认在备份目录下生成一个按时间戳命名的文件夹 innobackupex --user=root --password=xxx /data/backup [root@localhost etc]# cd /data/backup/ [root@localhost backup]# ll 总用量 0 drwxr-x---. 6 root root 210 6月 4 17:16 2020-06-04_17-16-31 #不使用时间戳命名备份文件夹，自定义备份文件 innobackupex --user=root --password=lpt316 --no-timestamp /data/backup/full [root@localhost backup]# cd /data/backup/ [root@localhost backup]# ll 总用量 0 drwxr-x---. 6 root root 210 6月 4 17:16 2020-06-04_17-16-31 drwxr-x---. 6 root root 210 6月 4 17:20 full 使用全备恢复 模拟误操作删除数据库\nrm -rf /usr/local/mysql/mysql57/data/stumanage 将redo进行重做，已提交的写到数据文件，未提交的使用undo回滚掉\ninnobackupex --apply-log /data/backup/full/ 准备一个目录，因为进行恢复的时候要求目录必须是空的\nmkdir /data/mysql 把恢复的数据拷贝到该目录下\ncp -a /data/backup/full/ /data/mysql1/ 授权(必须在拷贝之后授权)\nchown -R mysql.mysql /data/mysql1 修改mysql的配置文件数据目录\nvim /etc/my.cnf 修改 datadir=/data/mysql 重启mysql\nservice mysqld start 增量备份 首先进行全备\ninnobackupex --user=root --password=lpt316 --socket=/tmp/mysql.sock --no-timestamp /data/backup/full 模拟第一天数据改变\nCREATE TABLE test.t1(num INT)ENGINE=INNODB CHARSET=utf8; INSERT INTO test.t1 VALUES(1),(2),(3); 进行第一天的增量备份\ninnobackupex --user=root --password=lpt316 --socket=/tmp/mysql.sock --no-timestamp --incremental --incremental-basedir=/data/backup/full/ /data/backup/inc1 模拟第二天数据变化\nCREATE TABLE test.t2(num INT)ENGINE=INNODB CHARSET=utf8; INSERT INTO test.t2 VALUES(1),(2),(3); 进行第二天的全备\ninnobackupex --user=root --password=lpt316 --socket=/tmp/mysql.sock --no-timestamp --incremental --incremental-basedir=/data/backup/inc1/ /data/backup/inc2 模拟第三天数据变化\nCREATE TABLE test.t3(num INT)ENGINE=INNODB CHARSET=utf8; INSERT INTO test.t3 VALUES(1),(2),(3); 进行第三天的增量备份\ninnobackupex --user=root --password=lpt316 --socket=/tmp/mysql.sock --no-timestamp --incremental --incremental-basedir=/data/backup/inc2/ /data/backup/inc3 模拟故障之前一些操作\nINSERT INTO test.t3 VALUES(5),(6),(7); 模拟误错误删除了库\nrm -rf /data/mysql/test/ 恢复\n#整理全备 innobackupex --apply-log --redo-only /data/backup/full/ #把inc1合并到full innobackupex --apply-log --redo-only --incremental-dir=/data/backup/inc1 /data/backup/full/ #把inc2合并到full innobackupex --apply-log --redo-only --incremental-dir=/data/backup/inc2 /data/backup/full/ #把inc3合并到full innobackupex --apply-log --incremental-dir=/data/backup/inc3 /data/backup/full/ #最后进行一次全备整理 innobackupex --apply-log /data/backup/full 新建目录，把恢复的文件拷贝过去，并授权\n[root@localhost backup]# mkdir /data/mysql2 [root@localhost backup]# cp -a full/* /data/mysql2/ [root@localhost backup]# chown -R mysql.mysql /data/mysql2 截取故障当天的二进制日志\n#判断起点 cat /data/backup/inc3/xtrabackup_binlog_info #找到终点 mysql -uroot -plpt316 -e \"show binlog events in 'mysql-bin.000002'\" |grep drop #导出二进制日志 ./mysqlbinlog --start-position=2681 --stop-position=3006 /data/mysql/mysql-bin.000002 \u003e /data/backup/binlog.sql 关闭数据库\nservice mysqld stop 修改mysql的配置文件\nvim /etc/my.cnf datadir=/data/mysql2 启动mysql\nservice mysqld start 此时已恢复到故障前一天的状态\n恢复二进制日志\nsource /data/backup/binlog.sql; 成功恢复到误删除前\n单表恢复 进行全备\ninnobackupex --user=root --password=lpt316 --socket=/tmp/mysql.sock --no-timestamp /data/backup/all 只删除一个表\nDROP TABLE test2.ttt; 恢复\ninnobackupex --apply-log /data/backup/all 创建一个和删除表相同结构的表\nCREATE TABLE test2.ttt(num INT)ENGINE=INNODB CHARSET=utf8; 卸载表空间\n#卸载表空间 ALTER TABLE test2.ttt DISCARD TABLESPACE; 把恢复的全备里的相关表文件拷贝到数据库数据文件下，并授权\ncp /data/backup/all/test2/ttt.ibd /data/mysql2/test2/ chown -R mysql.mysql /data/mysql2/test2/ttt.ibd 添加表空间\nALTER TABLE test2.ttt IMPORT TABLESPACE; 至此，数据就恢复回来了\n主从复制 主从复制前提：\n两个数据库实例，并配置server_id 主库需要开启二进制日志 主库需要建立专用的赋值用户（replication slave） 主库全备，从库使用备份恢复，保证主库从库一致 change master to 主库ip 端口 用户名 密码 二进制文件 日志position start slave 主从备份实施 确保两数据库配置了server_id，并开启了二进制日志 主库： server_id=1 log_bin=mysql-bin binlog_format=row 从库： server_id=2 log_bin=mysql-bin binlog_format=row 主机全备发送到从机执行，确保主从复制前主从库数据一致 主库： ./mysqldump -uroot -plpt316 -A --triggers -R -E -F --master-data=2 --single-transaction \u003e /data/backup/20200609full.sql 发送全备到从库： scp /data/backup/20200609full.sql root@192.168.37.131:/data/backup 从库： #登录 mysql -uroot -p #设置恢复全备不记录日志 set sql_log_bin=0; #同步主库数据 source /data/backup/20200609full.sql; #恢复记录sql二进制日志 set sql_log_bin=1; 主库建立一个主从复制专用用户 grant replication slave on *.* to rep@'192.168.37.*' identified by 'lpt316'; flush privileges; change master to #首先查看全备里的position位置 CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000007', MASTER_LOG_POS=154; CHANGE MASTER TO MASTER_HOST='192.168.37.130', MASTER_USER='rep', MASTER_PASSWORD='lpt316', MASTER_PORT=3306, MASTER_LOG_FILE='mysql-bin.000008', MASTER_LOG_POS=154, MASTER_CONNECT_RETRY=10, MASTER_RETRY_COUNT=0; start slave; 在主库中添加数据看看从库同步了没有 从库： mysql\u003e select * from test3.t1; Empty set (0.01 sec) 主库： mysql\u003e insert into test3.t1 values(1),(2),(3); Query OK, 3 rows affected (0.00 sec) Records: 3 Duplicates: 0 Warnings: 0 从库查看是否同步： mysql\u003e select * from test3.t1; 主从复制原理 涉及的文件 主库：\nmysql-bin.00000x：二进制文件 从库：\nlocalhost-relay-bin.00000x：中继日志文件 master.info：主库信息 relay-log.info：中继日志信息 涉及的线程 主库：\nBinlog_Dump_Thread:监控主库，如果有新操作，和Slave_IO_Thread交互，通知从库 从库：\nSlave_IO_Thread：负责和主库建立TCP/IP连接，和Binlog_Thread交互，当主库通知该线程时，拷贝二进制文件回来 Slave_SQL_Thread：负责把拷贝回来的二进制文件转换成SQL语句，并在从库中执行，保证主从一致 主从异常 主从故障 连接问题：\nSlave_IO_Running: Connecting 可能的错误有： ip错误 端口错误 user，password错误或不允许在该ip登录 主库未启动 防火墙未开放端口 连接已达到上限 解决：\n首先ping从库ip看是否网络有问题 ping xxx.xxx.xxx.xxx 如何能ping通，可能是端口，用户名，密码等其他问题,在从库使用主从账号远程连接 mysql -u repl -p xxx -h 192.168.37.111 二进制文件问题：\n如：\n二进制文件删除 二进制文件不全 主库reset master 解决：\n停止主从 stop slave; 重置从库信息 reset slave all; 主库重启导出一个全备，在从库中恢复，重启搭建主从 SQL线程故障：\nrelay-log.info文件不存在，或不全 SQL无法执行 原因：\n版本差异，参数设定不一样 主从环境不一致，要创建的数据库已经存在，要删除的对象不存在 解决：\n可以在配置文件中设置 read_only=1 但是这种方式只能针对普通账户，管理员任然能够修改数据 主从延迟 主库做的操作，从库很久才能追加上\n外在原因 网络 主从硬件差异 版本差异 参数差异 主库原因 二进制日志写入不及时：sync_binlog；在mysql5.7默认为1，即立即写入二进制日志 主库发生了大事务，由于是串行传递，会阻塞后续事务 解决：\n5.6开始，开启GTID实现Group Commit，可以并行传输日志给从库IO线程\n5.7开始，不开启GTID，会自动维护匿名GTID，也能实现Group Commit\n从库原因 主库并发了大量事务，从库只能串行回放 主库发生了大事务，会阻塞后续的所有事务 解决：\n5.6版本开启GTID之后，加入了SQL多线程特性，但是只能针对不同的数据库下的事务进行并行回放\n5.7版本开启GTID之后，在SQL方面，提供了基于逻辑时钟seq_no机制，真正实现了事务级别的并发回放MTS技术\n延时从库 使用原因：预防人为原因导致数据库误删除\n思想：延时从库和普通从库一样，只是延时从库拿到数据写入relaylog中，SQL线程必须延时指定的时间才去运行\n配置 stop slave; CHANGE MASTER TO MASTER_DELAY = 300; start slave; show slave status \\G #从库延时时间 SQL_Delay: 300\t#从库将要执行语句的最近时间 SQL_Remaining_Delay: NULL 恢复 发现错误，及时停止延时从库的SQL线程 截取relaylog日志，起点为stop sql线程时的relaylog位置，终点为drop之间的位置 把截取的日志恢复到从库 从库代替主库工作 恢复案例 #配置延时从库 stop slave; CHANGE MASTER TO MASTER_DELAY = 300; start slave; #在主库中创建一个delay库，并创建一个测试表，插入几条测试数据 create database delay charset=utf8; create table delay.test(num int)engine=innodb charset=utf8; insert into delay.test values(1),(2),(3); #删除主库delay数据库 drop database delay; #发现错误，立即停止从库SQL线程 stop slave sql_thread; #查看relaylog日志的起点 Relay_Log_File: localhost-relay-bin.000002 Relay_Log_Pos: 320 #查看relaylog找到drop误操作前的位置 show relaylog events in \"localhost-relay-bin.000002\"; localhost-relay-bin.000002 | 1016 | Query | 1 | 945 | drop database delay #截取日志 [root@localhost bin]# ./mysqlbinlog --start-position=320 --stop-position=1016 /usr/local/mysql/mysql57/data/localhost-relay-bin.000002 \u003e /tmp/relay.sql #恢复日志数据 source /tmp/relay.sql; #把主库设置为从库或延时从库恢复好的数据导出在主库中恢复 过滤复制 相关参数 主库：\nBinlog_Do_DB：\nBinlog_Ignore_DB：\n这两个是主库空配置要进行复制的白名单和黑名单，不过一般不在主库配置，因为主库配置这两个参数，涉及的库并不会记录二进制日志，不利于使用二进制进行备份\n从库： Replicate_Do_DB: 复制库白名单 Replicate_Ignore_DB: 复制库黑名单\nReplicate_Do_Table: 复制表白名单 Replicate_Ignore_Table: 复制表黑名单\nReplicate_Wild_Do_Table: 复制表模糊白名单 Replicate_Wild_Ignore_Table:复制表模糊黑名单\n案例 #修改从库配置文件，设置从库只不复制filter1和filter2数据库数据 vim /etc/my.cnf 添加 replicate_ignore_db=filter1 replicate_ignore_db=filter2 注意配置文件里不能大写 #重启mysql service mysqld start #在主库中创建一个filter1数据库 create database filter1 charset=utf8; #在从库中查询 mysql\u003e show databases; +--------------------+ | Database | +--------------------+ | information_schema | | mysql | | performance_schema | | sys | | test2 | | test3 | +--------------------+ 6 rows in set (0.00 sec) 并没有filter1数据库 GTID主从复制 GTID(Global Transaction ID)是对于一个已提交事务的唯一编号，并且是一个全局(主从复制)唯一的编号。 它的官方定义如下： GTID = source_id ：transaction_id 7E11FA47-31CA-19E1-9E56-C43AA21293967:29\n配置文件核心参数 gtid-mode=on --启用gtid类型，否则就是普通的复制架构 enforce-gtid-consistency=true --强制GTID的一致性 log-slave-updates=1 --slave更新是否记入日志 从库操作 change master to master_host='10.0.0.51', master_user='repl', master_password='123' , MASTER_AUTO_POSITION=1; 和传统主从的复制的区别：在启动复制时，不需要指定binlog文件名和position号，直接auto即可自动读取最后一个relay，获取到上次已经复制GTID号，从此号码开始向后复制即可，在MHA高可用环境下，主库无法SSH时，从库进行数据补偿，更加便捷。\n","wordCount":"2700","inLanguage":"en","datePublished":"2022-11-27T16:16:14+08:00","dateModified":"2022-11-27T16:16:14+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moyuduo.github.io/posts/mysql/"},"publisher":{"@type":"Organization","name":"Moyuduo's Blog","logo":{"@type":"ImageObject","url":"https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://moyuduo.github.io/ accesskey=h title="Moyuduo's Blog (Alt + H)"><img src=https://moyuduo.github.io/apple-touch-icon.png alt aria-label=logo height=35>Moyuduo's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://moyuduo.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://moyuduo.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://moyuduo.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://moyuduo.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Mysql</h1></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#centos7下安装mysql>centos7下安装mysql</a></li></ul><ul><li><ul><li><a href=#建库>建库</a></li><li><a href=#修改数据库>修改数据库</a></li><li><a href=#删除库>删除库</a></li><li><a href=#建表>建表</a></li><li><a href=#修改表>修改表</a></li><li><a href=#查看表信息>查看表信息</a></li><li><a href=#删表>删表</a></li></ul></li><li><a href=#dcl>DCL</a><ul><li><a href=#grant>grant</a></li><li><a href=#revoke>revoke</a></li><li><a href=#修改密码>修改密码</a></li></ul></li><li><a href=#dml>DML</a><ul><li><a href=#插入数据>插入数据</a></li><li><a href=#更新数据>更新数据</a></li><li><a href=#删除数据>删除数据</a></li></ul></li><li><a href=#dql>DQL</a><ul><li><a href=#单独使用>单独使用</a></li><li><a href=#查询所有数据>查询所有数据</a></li><li><a href=#比较操作符>比较操作符</a></li><li><a href=#逻辑运算符>逻辑运算符</a></li><li><a href=#模糊查询>模糊查询</a></li><li><a href=#in>in</a></li><li><a href=#between>between</a></li><li><a href=#group-by--聚合函数>group by + 聚合函数</a></li><li><a href=#order-by>order by</a></li><li><a href=#limit>limit</a></li><li><a href=#distinct>distinct</a></li><li><a href=#union>union</a></li><li><a href=#连接查询>连接查询</a></li><li><a href=#笛卡尔积>笛卡尔积</a></li><li><a href=#show>show</a></li></ul></li><li><a href=#三范式>三范式</a><ul><li><a href=#第一范式>第一范式</a></li><li><a href=#第二范式>第二范式</a></li><li><a href=#第三范式>第三范式</a></li></ul></li><li><a href=#索引>索引</a><ul><li><a href=#种类>种类</a></li><li><a href=#btree>BTree</a></li><li><a href=#btree-1>B+Tree</a></li><li><a href=#btree-2>B*Tree</a></li><li><a href=#聚集索引>聚集索引</a></li><li><a href=#辅助索引>辅助索引</a></li><li><a href=#聚集索引和辅助索引的区别>聚集索引和辅助索引的区别</a></li><li><a href=#执行计划分析>执行计划分析</a></li><li><a href=#不走索引的情况>不走索引的情况</a></li></ul></li><li><a href=#存储引擎>存储引擎</a><ul><li><a href=#功能>功能</a></li><li><a href=#innodb引擎>InnoDB引擎</a></li><li><a href=#myisam引擎>MyISAM引擎</a></li><li><a href=#查询数据库的表的引擎>查询数据库的表的引擎</a></li><li><a href=#修改表的存储引擎>修改表的存储引擎</a></li><li><a href=#缓冲区池>缓冲区池</a></li></ul></li><li><a href=#日志>日志</a><ul><li><a href=#错误日志>错误日志</a></li><li><a href=#二进制日志>二进制日志</a></li><li><a href=#slowlog>slowlog</a></li></ul></li><li><a href=#备份>备份</a><ul><li><a href=#备份类型>备份类型</a></li><li><a href=#备份方式>备份方式</a></li><li><a href=#mysqldumpbinlog恢复数据库>mysqldump+binlog恢复数据库</a></li></ul></li><li><a href=#主从复制>主从复制</a><ul><li><a href=#主从备份实施>主从备份实施</a></li><li><a href=#主从复制原理>主从复制原理</a></li><li><a href=#主从异常>主从异常</a></li></ul></li><li><a href=#延时从库>延时从库</a><ul><li><a href=#配置>配置</a></li><li><a href=#恢复-1>恢复</a></li><li><a href=#恢复案例>恢复案例</a></li></ul></li><li><a href=#过滤复制>过滤复制</a><ul><li><a href=#相关参数>相关参数</a></li><li><a href=#案例>案例</a></li></ul></li><li><a href=#gtid主从复制>GTID主从复制</a><ul><li><a href=#配置文件核心参数>配置文件核心参数</a></li><li><a href=#从库操作>从库操作</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=mysql>Mysql<a hidden class=anchor aria-hidden=true href=#mysql>#</a></h1><h2 id=centos7下安装mysql>centos7下安装mysql<a hidden class=anchor aria-hidden=true href=#centos7下安装mysql>#</a></h2><p>下载MySQL安装包</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz
</span></span></code></pre></div><p>把安装包解压</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#如果不知道安装包下载的位置可以使用 find / -name mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz 查看</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>tar -zxvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz
</span></span></code></pre></div><p>在/usr/local/下新建/usr/local/mysql</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p /usr/local/mysql
</span></span></code></pre></div><p>把解压的安装包移动到/usr/local/mysql/mysql57目录下，并授权</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mv  mysql-5.7.24-linux-glibc2.12-x86_64 //usr/local/mysql/mysql57
</span></span><span class=line><span class=cl>chown -R mysql.mysql /usr/local/mysql/mysql57
</span></span></code></pre></div><p>在/usr/local/mysql/mysql57下新建data目录用于存放数据库数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir data
</span></span></code></pre></div><p>初始化mysql,初始化成功后会显示默认密码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> /usr/local/mysql/mysql57/bin
</span></span><span class=line><span class=cl>./mysqld --initialize --user<span class=o>=</span>mysql --datadir<span class=o>=</span>/usr/local/mysql/mysql57/data --basedir<span class=o>=</span>/usr/local/mysql/mysql57
</span></span></code></pre></div><p>检查my.cnf文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /etc/my/cnf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>mysqld<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>basedir</span><span class=o>=</span>/usr/local/mysql/mysql57
</span></span><span class=line><span class=cl><span class=c1>#datadir=/usr/local/mysql/mysql57/data</span>
</span></span><span class=line><span class=cl><span class=nv>datadir</span><span class=o>=</span>/data/mysql2
</span></span><span class=line><span class=cl><span class=nv>port</span> <span class=o>=</span> <span class=m>3306</span>
</span></span><span class=line><span class=cl><span class=nv>sql_mode</span><span class=o>=</span>NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES
</span></span><span class=line><span class=cl>symbolic-links<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>max_connections</span><span class=o>=</span><span class=m>400</span>
</span></span><span class=line><span class=cl><span class=nv>innodb_file_per_table</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>server_id</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>log_bin</span><span class=o>=</span>mysql-bin
</span></span><span class=line><span class=cl><span class=nv>binlog_format</span><span class=o>=</span>row
</span></span></code></pre></div><p>添加软连接，启动mysql</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ln -s /usr/local/mysql//mysql57/support-files/mysql.server /etc/init.d/mysqld
</span></span><span class=line><span class=cl>ln -s /usr/local/mysql//mysql57/bin/mysql /usr/bin/mysql
</span></span></code></pre></div><p>启动mysql</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>service mysql start
</span></span></code></pre></div><p>登录mysql</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mysql -uroot -p
</span></span></code></pre></div><p>修改默认密码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>mysql</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>alter</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=s1>&#39;root&#39;</span><span class=o>@</span><span class=s1>&#39;localhost&#39;</span><span class=w> </span><span class=k>identified</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=s1>&#39;lpt316&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=nf>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>添加一个远程连接账号，默认root账号只能本地连接</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>grant</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=k>privileges</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=s1>&#39;root&#39;</span><span class=o>@</span><span class=s1>&#39;%&#39;</span><span class=w> </span><span class=k>identified</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=s1>&#39;lpt316&#39;</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=k>grant</span><span class=w> </span><span class=k>option</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#刷新权限表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>flush</span><span class=w> </span><span class=k>privileges</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>firewalld添加开发端口供远程连接使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>firewall-cmd --zone<span class=o>=</span>public --add-port<span class=o>=</span>3306/tcp --permanent
</span></span><span class=line><span class=cl>firewall-cmd --reload
</span></span></code></pre></div><p>设置开机自启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cp /usr/local/mysql/mysql57/support-files/mysql.server /etc/init.d/mysql
</span></span><span class=line><span class=cl>chmod +x /etc/init.d/mysql
</span></span><span class=line><span class=cl>chkconfig --add mysql
</span></span><span class=line><span class=cl>chkconfig --list
</span></span></code></pre></div><h1 id=ddl>DDL<a hidden class=anchor aria-hidden=true href=#ddl>#</a></h1><h3 id=建库>建库<a hidden class=anchor aria-hidden=true href=#建库>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>stu</span><span class=w> </span><span class=kp>charset</span><span class=w> </span><span class=n>utf8</span><span class=w> </span><span class=k>collate</span><span class=w> </span><span class=n>utf8_bin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>DATABASE</span><span class=w> </span><span class=n>test3</span><span class=w> </span><span class=kp>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#collate指定排序规则	utf8_bin为区分大小写	utf8_general_ci不区分大小写
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看数据库字符集
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=kp>charset</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>stu</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=修改数据库>修改数据库<a hidden class=anchor aria-hidden=true href=#修改数据库>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>alter</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>stu</span><span class=w> </span><span class=kp>charset</span><span class=w> </span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=删除库>删除库<a hidden class=anchor aria-hidden=true href=#删除库>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>drop</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>stu</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=建表>建表<a hidden class=anchor aria-hidden=true href=#建表>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test3</span><span class=p>.</span><span class=nf>t1</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=kt>INT</span><span class=p>)</span><span class=kp>ENGINE</span><span class=w> </span><span class=n>INNODB</span><span class=w> </span><span class=kp>CHARSET</span><span class=w> </span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=nf>student</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>id</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=w> </span><span class=kp>auto_increment</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;学号&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=n>sname</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;姓名&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=n>sage</span><span class=w> </span><span class=kt>tinyint</span><span class=w> </span><span class=k>unsigned</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;年龄&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=n>sgender</span><span class=w> </span><span class=kt>enum</span><span class=p>(</span><span class=s1>&#39;m&#39;</span><span class=p>,</span><span class=s1>&#39;f&#39;</span><span class=p>,</span><span class=s1>&#39;n&#39;</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=s1>&#39;n&#39;</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;性别&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=n>id_card</span><span class=w> </span><span class=kt>char</span><span class=p>(</span><span class=mi>18</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;身份证&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  	</span><span class=n>enter_time</span><span class=w> </span><span class=kt>timestamp</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=nf>now</span><span class=p>()</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;入学时间&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=kp>engine</span><span class=o>=</span><span class=n>innodb</span><span class=w> </span><span class=kp>charset</span><span class=o>=</span><span class=n>utf8</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;学生表&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><strong>建库和建表语句指定字符、引擎等可以使用=也可以隔一个空格</strong></p><h3 id=修改表>修改表<a hidden class=anchor aria-hidden=true href=#修改表>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#添加qq列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=n>qq</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;QQ号码&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#在sname后添加微信号列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=n>wechat</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;微信号码&#39;</span><span class=w> </span><span class=n>after</span><span class=w> </span><span class=n>sname</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#在id列前添加phone列(第一列)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=n>phone</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>15</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=s1>&#39;电话号码&#39;</span><span class=w> </span><span class=n>first</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#修改列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>user</span><span class=w> </span><span class=n>modify</span><span class=w> </span><span class=k>column</span><span class=w> </span><span class=n>birth</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#删除数据列(需要进行数据迁移，效率极差)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=k>drop</span><span class=w> </span><span class=n>phone</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=查看表信息>查看表信息<a hidden class=anchor aria-hidden=true href=#查看表信息>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查看数据库中所有表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=kp>tables</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>desc</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看建表语句
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=删表>删表<a hidden class=anchor aria-hidden=true href=#删表>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>drop</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=dcl>DCL<a hidden class=anchor aria-hidden=true href=#dcl>#</a></h2><h3 id=grant>grant<a hidden class=anchor aria-hidden=true href=#grant>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#identified by &#39;123&#39;表示创建并授权	grant option表示可以把自己有的权限授予其他用户
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>grant</span><span class=w> </span><span class=k>all</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>root</span><span class=o>@</span><span class=s1>&#39;%&#39;</span><span class=w> </span><span class=k>identified</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=s1>&#39;123&#39;</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=k>grant</span><span class=w> </span><span class=k>option</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=revoke>revoke<a hidden class=anchor aria-hidden=true href=#revoke>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>revoke</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>root</span><span class=o>@</span><span class=s1>&#39;%&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=修改密码>修改密码<a hidden class=anchor aria-hidden=true href=#修改密码>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#set password for 用户@地址=password(新密码);
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>set</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>root</span><span class=o>@</span><span class=n>localhost</span><span class=o>=</span><span class=nf>password</span><span class=p>(</span><span class=s1>&#39;123&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#mysqladmin -P端口号 -u用户 -p原密码 password 新密码	-P参数如果端口号默认3306也可以不指定
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqladmin</span><span class=w> </span><span class=o>-</span><span class=n>P3307</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>p123</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=mi>456</span><span class=w>
</span></span></span></code></pre></div><h2 id=dml>DML<a hidden class=anchor aria-hidden=true href=#dml>#</a></h2><h3 id=插入数据>插入数据<a hidden class=anchor aria-hidden=true href=#插入数据>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#在插入数据之前通常使用 desc student；查看表定义
</span></span></span><span class=line><span class=cl><span class=c1># 录入一条数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=nf>student</span><span class=p>(</span><span class=n>sname</span><span class=p>,</span><span class=n>id_card</span><span class=p>,</span><span class=n>qq</span><span class=p>,</span><span class=n>wechat</span><span class=p>,</span><span class=n>phone</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;张三&#39;</span><span class=p>,</span><span class=s1>&#39;1234567891012345678&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#插入多行
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=nf>student</span><span class=p>(</span><span class=n>sname</span><span class=p>,</span><span class=n>id_card</span><span class=p>,</span><span class=n>qq</span><span class=p>,</span><span class=n>wechat</span><span class=p>,</span><span class=n>phone</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;张三&#39;</span><span class=p>,</span><span class=s1>&#39;1234567891012345678&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>)</span><span class=err>，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=s1>&#39;李四&#39;</span><span class=p>,</span><span class=s1>&#39;1234567891012345678&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>,</span><span class=s1>&#39;12345678910&#39;</span><span class=p>)</span><span class=err>；</span><span class=w>
</span></span></span></code></pre></div><h3 id=更新数据>更新数据<a hidden class=anchor aria-hidden=true href=#更新数据>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#在更新数据之前通常使用 desc student；查看表定义
</span></span></span><span class=line><span class=cl><span class=c1>#更新数据一定要带条件，否则会改全表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>update</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=kt>set</span><span class=w> </span><span class=n>sname</span><span class=o>=</span><span class=s1>&#39;zhangsan&#39;</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=删除数据>删除数据<a hidden class=anchor aria-hidden=true href=#删除数据>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>truncate</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#区别
</span></span></span><span class=line><span class=cl><span class=c1>#delete是逻辑性删除，逐行进行删除，速度慢
</span></span></span><span class=line><span class=cl><span class=c1>#truncate是对表段中数据页进行清空,速度快
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#数据的伪删除，使用一个字段来标识数据行是否被删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=n>is_deleted</span><span class=w> </span><span class=kt>tinyint</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=no>null</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=dql>DQL<a hidden class=anchor aria-hidden=true href=#dql>#</a></h2><h3 id=单独使用>单独使用<a hidden class=anchor aria-hidden=true href=#单独使用>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1># 使用select @@xxx 查看系统参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>port</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>basedir</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>datadir</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>@@</span><span class=n>socket</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>@@</span><span class=n>server_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#使用函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=nf>now</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=k>database</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=k>user</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=nf>concat</span><span class=p>(</span><span class=k>user</span><span class=p>,</span><span class=s1>&#39;@&#39;</span><span class=p>,</span><span class=n>host</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>mysql</span><span class=p>.</span><span class=k>user</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=查询所有数据>查询所有数据<a hidden class=anchor aria-hidden=true href=#查询所有数据>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查询所有数据，大表谨慎使用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=比较操作符>比较操作符<a hidden class=anchor aria-hidden=true href=#比较操作符>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>&gt;</span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#不等于可以使用&lt;&gt; 或 !=
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>&lt;&gt;</span><span class=mi>10</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=逻辑运算符>逻辑运算符<a hidden class=anchor aria-hidden=true href=#逻辑运算符>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>sname</span><span class=o>=</span><span class=s1>&#39;张三&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>13</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=模糊查询>模糊查询<a hidden class=anchor aria-hidden=true href=#模糊查询>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查询姓张的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sname</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;张%&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查询姓名是两个子，且结尾为三
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sname</span><span class=w> </span><span class=k>like</span><span class=w> </span><span class=s1>&#39;_三&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#模糊查询中%和_区别是	%表示可以是多个字符	_只表示一个字符
</span></span></span><span class=line><span class=cl><span class=c1>#注意%不能放在模糊查询的最前面，因为不走索引
</span></span></span></code></pre></div><h3 id=in>in<a hidden class=anchor aria-hidden=true href=#in>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查询张三或李四的信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sname</span><span class=w> </span><span class=k>in</span><span class=p>(</span><span class=s1>&#39;张三&#39;</span><span class=p>,</span><span class=s1>&#39;李四&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h3 id=between>between<a hidden class=anchor aria-hidden=true href=#between>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查询id在11-12之间的
</span></span></span><span class=line><span class=cl><span class=c1>#between包括前后边界
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>between</span><span class=w> </span><span class=mi>11</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=mi>12</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=group-by--聚合函数>group by + 聚合函数<a hidden class=anchor aria-hidden=true href=#group-by--聚合函数>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#在sql中where语句必须放在group by之前
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#按年龄统计人数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sage</span><span class=p>,</span><span class=nf>count</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#统计所有男性女性的年龄总和
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sgender</span><span class=p>,</span><span class=nf>sum</span><span class=p>(</span><span class=n>sage</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sgender</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查询男性和女性的平均年龄
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sgender</span><span class=p>,</span><span class=nf>avg</span><span class=p>(</span><span class=n>sage</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sgender</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查询男性女性年龄的最大值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sgender</span><span class=p>,</span><span class=nf>max</span><span class=p>(</span><span class=n>sage</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sgender</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查询男性女性年龄的最小值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sgender</span><span class=p>,</span><span class=nf>min</span><span class=p>(</span><span class=n>sage</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sgender</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#按年龄统计名字
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sage</span><span class=p>,</span><span class=nf>group_concat</span><span class=p>(</span><span class=n>sname</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#统计年龄&gt;=20岁男性女性人数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sgender</span><span class=p>,</span><span class=nf>count</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sage</span><span class=o>&gt;=</span><span class=mi>20</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sgender</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#统计年龄&gt;=20岁男性女性人数
</span></span></span><span class=line><span class=cl><span class=c1>#这两个相同的问题可以使用不同的思路解决，可以选选择在分组	或者 先分组再选择	having语句只能用于分组列的条件比较
</span></span></span><span class=line><span class=cl><span class=c1># having语句的条件不走索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sgender</span><span class=p>,</span><span class=nf>count</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>having</span><span class=w> </span><span class=n>sage</span><span class=o>&gt;=</span><span class=mi>20</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=order-by>order by<a hidden class=anchor aria-hidden=true href=#order-by>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#按年龄升序排序,默认升序
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#按年龄降序排序
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>desc</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#把女性按年龄进行分组并按各个年龄人数降序排序
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=n>sage</span><span class=p>,</span><span class=nf>count</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sgender</span><span class=o>=</span><span class=s1>&#39;f&#39;</span><span class=w> </span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=nf>count</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>desc</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=limit>limit<a hidden class=anchor aria-hidden=true href=#limit>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查询年龄最大的三个人
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查询年龄第2-3大的两人
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=o>--</span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=w> </span><span class=err>表示跳过一个，取两个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>desc</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>	</span><span class=o>--</span><span class=k>limit</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>offset</span><span class=w> </span><span class=mi>1</span><span class=err>表示去两个跳过一个</span><span class=w>
</span></span></span></code></pre></div><h3 id=distinct>distinct<a hidden class=anchor aria-hidden=true href=#distinct>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=o>--</span><span class=err>有重复的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=k>distinct</span><span class=w> </span><span class=n>sage</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=o>--</span><span class=err>去重</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#distinct会验证所有字段，只有当所有字段相同才判定为相同的，去重
</span></span></span></code></pre></div><h3 id=union>union<a hidden class=anchor aria-hidden=true href=#union>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查询年龄为18或性别为女性的人
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sage</span><span class=o>=</span><span class=mi>18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>union</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>sgender</span><span class=o>=</span><span class=s1>&#39;f&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#union 前后查询语句的字段必须相同
</span></span></span><span class=line><span class=cl><span class=c1># union和union all的区别是union会进行去重，而union all不进行去重
</span></span></span><span class=line><span class=cl><span class=c1>#一般情况下我们把in或or改写为union all语句提高效率
</span></span></span></code></pre></div><h3 id=连接查询>连接查询<a hidden class=anchor aria-hidden=true href=#连接查询>#</a></h3><h3 id=笛卡尔积>笛卡尔积<a hidden class=anchor aria-hidden=true href=#笛卡尔积>#</a></h3><blockquote><p>把两张表联系起来，列为两表之和，行为两表之积</p></blockquote><p>表A：</p><table><thead><tr><th>a</th><th>b</th></tr></thead><tbody><tr><td>1</td><td>2</td></tr><tr><td>3</td><td>4</td></tr></tbody></table><p>表B：</p><table><thead><tr><th>c</th><th>d</th></tr></thead><tbody><tr><td>5</td><td>6</td></tr><tr><td>7</td><td>8</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#等值连接不写条件也是笛卡尔积
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w> 
</span></span></span></code></pre></div><table><thead><tr><th>a</th><th>b</th><th>c</th><th>d</th></tr></thead><tbody><tr><td>1</td><td>2</td><td>5</td><td>6</td></tr><tr><td>3</td><td>4</td><td>5</td><td>6</td></tr><tr><td>1</td><td>2</td><td>7</td><td>8</td></tr><tr><td>3</td><td>4</td><td>7</td><td>8</td></tr></tbody></table><h4 id=内连接>内连接<a hidden class=anchor aria-hidden=true href=#内连接>#</a></h4><h5 id=等值连接>等值连接<a hidden class=anchor aria-hidden=true href=#等值连接>#</a></h5><p>两表连接的条件是 =</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>sno</span><span class=o>=</span><span class=n>sc</span><span class=p>.</span><span class=n>sno</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h5 id=自然连接>自然连接<a hidden class=anchor aria-hidden=true href=#自然连接>#</a></h5><p>在等值连接中，相同的两个字段没有必要重复出现,等值连接会自动去比较字段名相同数据类型相同的列，如果有多列字段名相同字段类型相同的列，对应列必须相等才会连接</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>natural</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>sc</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>sno字段只出现一次</p><h5 id=不等值连接>不等值连接<a hidden class=anchor aria-hidden=true href=#不等值连接>#</a></h5><p>两表连接的条件是 > >= &lt; &lt;= &lt;>或！=
表A：</p><table><thead><tr><th>a</th><th>b</th></tr></thead><tbody><tr><td>1</td><td>1</td></tr><tr><td>2</td><td>6</td></tr></tbody></table><p>表B：</p><table><thead><tr><th>c</th><th>d</th></tr></thead><tbody><tr><td>3</td><td>7</td></tr><tr><td>4</td><td>8</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>b</span><span class=o>&gt;</span><span class=n>b</span><span class=p>.</span><span class=n>c</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><table><thead><tr><th>a</th><th>b</th><th>c</th><th>d</th></tr></thead><tbody><tr><td>2</td><td>6</td><td>3</td><td>7</td></tr><tr><td>2</td><td>6</td><td>4</td><td>8</td></tr></tbody></table><h4 id=外连接>外连接<a hidden class=anchor aria-hidden=true href=#外连接>#</a></h4><h5 id=左外连接>左外连接<a hidden class=anchor aria-hidden=true href=#左外连接>#</a></h5><p>左外连接会从左表返回所有行，即使右表没有匹配，如果有表没有匹配，那么字段值为null</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>left</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>sno</span><span class=o>=</span><span class=n>sc</span><span class=p>.</span><span class=n>sno</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h5 id=右外连接>右外连接<a hidden class=anchor aria-hidden=true href=#右外连接>#</a></h5><p>右外连接会从右表返回所有行，即使左表没有匹配，如果没有匹配，那么做表字段全为null</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>right</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>sno</span><span class=o>=</span><span class=n>sc</span><span class=p>.</span><span class=n>sno</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h5 id=全连接>全连接<a hidden class=anchor aria-hidden=true href=#全连接>#</a></h5><p>左外连接和右外连接的并集，即左表没有比配，那么左表字段值全为null，如果右表没有匹配，那么右表字段值全为null</p><p><strong>mysql中没有全连接</strong>，但是可以通过左外连接union右外连接实现</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>left</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>sno</span><span class=o>=</span><span class=n>sc</span><span class=p>.</span><span class=n>sno</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>union</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>right</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>student</span><span class=p>.</span><span class=n>sno</span><span class=o>=</span><span class=n>sc</span><span class=p>.</span><span class=n>sno</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=show>show<a hidden class=anchor aria-hidden=true href=#show>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查看数据库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=k>databases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看数据库下的表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=kp>tables</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看表的创建语句
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看可用字符集
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=kp>charset</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看排序规则
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>collation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看数据库存储引擎
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>engines</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看数据库连接情况
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>processlist</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看授权
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=k>grant</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>root</span><span class=o>@</span><span class=s1>&#39;localhost&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看数据库状态
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看配置信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>variables</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=三范式>三范式<a hidden class=anchor aria-hidden=true href=#三范式>#</a></h2><h3 id=第一范式>第一范式<a hidden class=anchor aria-hidden=true href=#第一范式>#</a></h3><blockquote><p>数据的每一列都需要保持原子性不可拆分
如在某些场景下地址可再拆分为省、市、县，即不满足第一范式</p></blockquote><h3 id=第二范式>第二范式<a hidden class=anchor aria-hidden=true href=#第二范式>#</a></h3><blockquote><p>非主属性比如完全依赖主键</p></blockquote><p>如表：</p><table><thead><tr><th>学号</th><th>姓名</th><th>性别</th><th>院系</th><th>课程</th><th>成绩</th></tr></thead><tbody><tr><td>1</td><td>tom</td><td>男</td><td>计算机系</td><td>程序设计</td><td>90</td></tr><tr><td>1</td><td>tom</td><td>男</td><td>计算机系</td><td>数据库</td><td>80</td></tr></tbody></table><p>该表的主键为&lt;学号,课程>，非主属性为姓名、性别、院系、成绩，其中非主属性姓名、性别、院系部分依赖于主属性&lt;学号>，所以这一张表还应该进行拆分</p><h3 id=第三范式>第三范式<a hidden class=anchor aria-hidden=true href=#第三范式>#</a></h3><blockquote><p>所有的非主属性不依赖于其他非主属性</p></blockquote><p>如表：</p><table><thead><tr><th>学号</th><th>姓名</th><th>性别</th><th>院系</th><th>院系主任</th></tr></thead><tbody><tr><td>1</td><td>tom</td><td>男</td><td>计算机系</td><td>张三</td></tr></tbody></table><p>在该表中主键为学号，其他列都是非主属性，而非主属性列院系主任依赖于非主属性列院系，所以不符合第三范式，应该进行拆分</p><h2 id=索引>索引<a hidden class=anchor aria-hidden=true href=#索引>#</a></h2><h3 id=种类>种类<a hidden class=anchor aria-hidden=true href=#种类>#</a></h3><ul><li>B树索引</li><li>Hash索引</li><li>R树索引</li><li>Fulltext</li><li>Gis</li></ul><h3 id=btree>BTree<a hidden class=anchor aria-hidden=true href=#btree>#</a></h3><p><img loading=lazy src=images/btree.jpg alt></p><p>B树属于多路查找树，由根、枝、叶节点组成。</p><h3 id=btree-1>B+Tree<a hidden class=anchor aria-hidden=true href=#btree-1>#</a></h3><p>在范围查询时提供更好的性能（> >= &lt; &lt;= like）</p><p><img loading=lazy src=images/bplustree.jpg alt></p><p>B+树是在B树的基础上，在叶子节点上加上了访问下一个叶子节点的指针，使得遍历时不需要再从根节点进行遍历。</p><h3 id=btree-2>B*Tree<a hidden class=anchor aria-hidden=true href=#btree-2>#</a></h3><p><img loading=lazy src=images/tree1.jpg alt></p><p>B*树是在B+树的基础上，在枝节点加上了访问下一个枝节点的指针，使得遍历时不需要再从根节点进行遍历。</p><h3 id=聚集索引>聚集索引<a hidden class=anchor aria-hidden=true href=#聚集索引>#</a></h3><p>数据表创建了聚集索引，那么数据行就会按照聚集索引顺序存放。</p><p>在建表时，建议创建一个数值类型的主键，这时就会创建聚集索引。</p><p>一个表只能创建一个聚集索引，创建了聚集索引后行的插入是按照聚集索引列值的顺序进行存储的，索引表中的数据行都是按照聚集索引列值的递增顺序存放的。</p><p>由于索引表中的数据行都是按照聚集索引列值的递增顺序存放的，所以聚集索引B+树的叶子节点是直接存放的数据页。</p><h4 id=创建聚集索引过程>创建聚集索引过程<a hidden class=anchor aria-hidden=true href=#创建聚集索引过程>#</a></h4><ol><li>创建数据行</li><li>根据主键在磁盘页中顺序存储数据行</li><li>根据数据页创建B+树的枝节点</li><li>根据枝节点创建根节点</li></ol><h3 id=辅助索引>辅助索引<a hidden class=anchor aria-hidden=true href=#辅助索引>#</a></h3><h4 id=创建辅助索引过程>创建辅助索引过程<a hidden class=anchor aria-hidden=true href=#创建辅助索引过程>#</a></h4><ol><li>取出索引列值，进行排序</li><li>创建B+树叶子节点，并将索引列值和对应数据页存入叶子节点</li><li>根据叶子节点创建枝节点</li><li>根据枝节点创建根节点</li></ol><p><strong>如果创建辅助索引的表已经创建了聚集索引，那么叶子节点存储的就是索引列值和对应的聚集索引列值，当查询时，根据辅助索引拿到聚集索引列值，在去聚集索引中查找，由于聚集索引的叶子节点直接存储数据页，不同于辅助索引存储页码，减少了回表操作</strong></p><p>当列需要作为条件频繁的进行查询时，可以考虑建立索引，但是还需要考虑是否列要频繁进行更新，因为更新操作需要更新所有树，导致锁定索引树，这种情况是否需要建立索引还需要进行一定的权衡</p><h4 id=单列索引>单列索引<a hidden class=anchor aria-hidden=true href=#单列索引>#</a></h4><p>为需要进行查询的一列建立的所有</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=nf>idx_sname</span><span class=p>(</span><span class=n>sname</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_sname</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h5 id=前缀索引>前缀索引<a hidden class=anchor aria-hidden=true href=#前缀索引>#</a></h5><p>只去列的前几个字符建立索引，列数据类型必须是字符串</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=nf>idx_sname</span><span class=p>(</span><span class=nf>sname</span><span class=p>(</span><span class=mi>5</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><h4 id=联合索引>联合索引<a hidden class=anchor aria-hidden=true href=#联合索引>#</a></h4><p>当需要进行多条件查询时</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=nf>idx_n_a_g</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=n>age</span><span class=p>,</span><span class=n>gender</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;xxx&#39;</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>age</span><span class=o>=</span><span class=mi>20</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>gender</span><span class=o>=</span><span class=s1>&#39;m&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=唯一索引>唯一索引<a hidden class=anchor aria-hidden=true href=#唯一索引>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=nf>idx_telphone</span><span class=p>(</span><span class=n>telphone</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h3 id=聚集索引和辅助索引的区别>聚集索引和辅助索引的区别<a hidden class=anchor aria-hidden=true href=#聚集索引和辅助索引的区别>#</a></h3><ol><li>聚集索引一个表只能有一个，辅助索引可以有多个，一般配合聚集索引使用</li><li><strong>聚集索引的叶子节点就是磁盘数据行存储的数据页</strong></li><li>Mysql是根据聚集索引组织存储数据，数据行存储时就是按照聚集索引列值的顺序进行存储</li><li>创建索引时，聚集索引列值本身就是有序的，而辅助索引需要对列值进行排序</li></ol><h3 id=执行计划分析>执行计划分析<a hidden class=anchor aria-hidden=true href=#执行计划分析>#</a></h3><p>在查询语句前加desc可以查看查询语句的执行相关信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>DESC</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>t_100w</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>k2</span><span class=o>=</span><span class=s1>&#39;STOP&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>相关查询结果列：</p><p>table 查询语句使用的数据库</p><p>type 查询的类型</p><ul><li><p>ALL全表扫描</p></li><li><p>index全索引扫描</p></li><li><p>range索引范围扫描 聚集索引：&lt;> not in 辅助索引：> &lt; >= &lt;= like in or</p></li><li><p>ref非唯一性等值索引</p></li><li><p>eq_ref在多表连接时，连接条件使用了唯一索引（unique,pk）</p></li><li><p>const唯一索引的等值查询</p></li></ul><p>possible_keys 可能会用到的索引</p><p>key 使用的索引</p><p>extra 额外信息</p><p>当查询语句使用了条件并且有排序或分组时，可以使用联合索引来优化</p><h3 id=不走索引的情况>不走索引的情况<a hidden class=anchor aria-hidden=true href=#不走索引的情况>#</a></h3><ol><li>查询条件没有建立索引</li><li>查询结果集是原表中的大部分数据，25%以上</li><li>索引失效，统计数据不真实，索引具有自我维护的功能，对于频繁更新的列建立的所有，频繁的更新可能导致所有失效，这个时候一般是删除索引，频繁更新的列不适合建立索引</li><li>在索引类的条件查询，条件使用了函数或者对所有列进行计算</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=o>-</span><span class=mi>1</span><span class=o>=</span><span class=mi>9</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=5><li>隐式转换</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#telphone列数据类型是char(11)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>telphone</span><span class=o>=</span><span class=mi>12345678910</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=6><li>对于辅助索引，&lt;>、in、not in不走索引，这种情况可以把in改写成union all</li><li>like “%xx”like语句%在最前面不走索引</li></ol><h2 id=存储引擎>存储引擎<a hidden class=anchor aria-hidden=true href=#存储引擎>#</a></h2><p>可以通过</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>default_storage_engine</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>查看数据库引擎</p><h3 id=功能>功能<a hidden class=anchor aria-hidden=true href=#功能>#</a></h3><ol><li>数据读写</li><li>数据安全和一致性</li><li>提高性能</li><li>热备份</li><li>自动故障恢复</li><li>高可用</li></ol><p>在Mysql5.5版本以后，数据库默认引擎为InnoDB，提供高可靠性和高性能。</p><h3 id=innodb引擎>InnoDB引擎<a hidden class=anchor aria-hidden=true href=#innodb引擎>#</a></h3><h4 id=特点>特点：<a hidden class=anchor aria-hidden=true href=#特点>#</a></h4><ol><li>支持事务</li><li>InnoDB锁粒度为行级锁</li><li>聚集索引组织表</li><li>支持外键，保证多表数据一致性</li><li>支持CSR（故障自动恢复）</li><li>支持数据热备份</li></ol><h4 id=事务的acid特性>事务的ACID特性<a hidden class=anchor aria-hidden=true href=#事务的acid特性>#</a></h4><ul><li>Atomic（原子性）：所有语句作为一个单元，全部成功或全部失败</li><li>Consistent（一致性）：如果数据库事务开始处于一致状态，则在执行事务期间保留一致状态</li><li>Isolated（隔离性）：事务之间不相互影响</li><li>Durable（持久性）：事务成功后，所有的更改将记录到数据库中。</li></ul><h4 id=四种隔离级别>四种隔离级别<a hidden class=anchor aria-hidden=true href=#四种隔离级别>#</a></h4><ol><li>Read Uncommited：在该隔离级别下，所有事务都可以看到其他未提交事务的执行结果，称之为脏读。</li><li>Read Commited：该隔离级别为大多数数据库默认的隔离级别(mysql中不是)，该隔离级别下一个事务能够读取到其他事务已经提交了的数据。但是这种隔离级别会造成不可重复读现象，
即：在个事务中先查询了某一部分记录，然后其他的事务修改了这一部分数据，并且提交了，那么这些修改对当前事务都是可见的，当再次查询这部分记录是，和之前的查询不一样了，即在同一个事务内
两次相同的查询得到不一样的数据。</li><li>Repeatable Read:该隔离级别是mysql默认的隔离级别，即在同一个事务内读取数据并不会受到其他事务的影响，都会读取到一致的记录。但是该隔离级别会导致幻读：事务A根据条件修改了数据，此时事务B刚好插入了该范围内的数据，当事务A再次查询修改的数据时，发现同样的条件任然有一部分数据没有被修改。</li><li>Serializable：通过强制事务排序，使之不可能相互冲突，从而解决幻读问题。简言之，它是在每个读的数据行上加上共享锁。在这个级别，可能导致大量的超时现象和锁竞争。</li></ol><p>Mysql默认采用<code>REPEATABLE_READ</code>隔离级别</p><h4 id=事务的开启结束>事务的开启结束<a hidden class=anchor aria-hidden=true href=#事务的开启结束>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>begin</span><span class=w> </span><span class=o>--</span><span class=err>开启事务，</span><span class=n>Mysql5</span><span class=p>.</span><span class=mi>5</span><span class=err>以后默认自动开启事务，可以不写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>commit</span><span class=w> </span><span class=o>--</span><span class=err>提交事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>rollback</span><span class=w> </span><span class=o>--</span><span class=err>回滚事务，把执行了的操作都撤销，恢复到开始事务状态</span><span class=w>
</span></span></span></code></pre></div><h4 id=自动提交策略>自动提交策略<a hidden class=anchor aria-hidden=true href=#自动提交策略>#</a></h4><p>Mysql中默认开启了自动提交策略</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#可以通过以下语句查看Mysql是否开启了事务自动提交，0表示关闭自动提交，1表示开启了自动提交
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>@@</span><span class=n>autocommit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#可以通过以下语句设置当前连接不开启事务自动提交
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>set</span><span class=w> </span><span class=n>autocommit</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#可以通过以下语句设置数据库全局关闭事务自动提交
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>set</span><span class=w> </span><span class=n>global</span><span class=w> </span><span class=n>autocommit</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=事务的实现原理>事务的实现原理<a hidden class=anchor aria-hidden=true href=#事务的实现原理>#</a></h4><blockquote><p>事务是基于重做日志(redo log)和回滚日志(undo log)来实现的，每提交一个事务前必须将所有的操作记录到重做日志中再进行持久话，当发生故障时可以基于重做日志来进行回复保证事务的原子性和持久性
当修改事务是会产生回滚日志，如果需要回滚则根据回滚日志的反向语句进行逻辑操作，重做日志主要是保证数据的一致性</p></blockquote><h5 id=redolog>redolog<a hidden class=anchor aria-hidden=true href=#redolog>#</a></h5><p>regolog不是随事务的提交才写入的，而是在事务的执行过程中，便开始写入redolog，具体的落盘策略可以进行配置，用来防止在发生故障的时候任然有脏页未写入磁盘，在重启mysql的时候会根据redolog进行重做，从而达到恢复未落盘数据的特性，保证数据的持久性</p><h4 id=undolog>undolog<a hidden class=anchor aria-hidden=true href=#undolog>#</a></h4><p>undolog用来回滚事务到记录的某个版本，在事务未提交之前，undolog保存了未提交之前的版本的数据，undolog中的数据可以作为旧版本数据的快照供其他并发事务进行快照读，undolog是为了实现事务的原子性的产物，在innodb存储引擎中用来实现多版本并发控制。</p><h4 id=binlog>binlog<a hidden class=anchor aria-hidden=true href=#binlog>#</a></h4><blockquote><p>Mysql的binlog是用来记录数据库表结构变更和表数据修改的二进制日志。binlog不会记录show、select这类操作，因为这类操作对表结构和表数据本身没有修改，但是可以通过查询通用日志来查看Mysql执行的所有语句。</p></blockquote><p>Mysql的binlog以事件形式记录，包含语句执行的时间，Mysql的binlog是事务安全型的，binlog的主要目的是为了用于复制和恢复。</p><p>binlog有三种形式：</p><ol><li>statement:基于sql语句的模式，某些语句如包含函数UUID的语句在复制和恢复的过程中会导致数据的不一致</li><li>row:基于行的模式，记录的是行的变化，很安全。在大表中清除大量数据时会在binlog中产生大量语句，导致在复制时从库的延迟变大</li><li>mixed:混合模式，根据语句来选择statement模式还是row模式</li></ol><h4 id=可以在事务中混用存储引擎吗>可以在事务中混用存储引擎吗？<a hidden class=anchor aria-hidden=true href=#可以在事务中混用存储引擎吗>#</a></h4><p>尽量不要在事务中使用多种存储引擎，Mysql的服务器层不管理事务，事务是由底层的存储引擎管理的，如果在一个事务中混用了存储引擎，如一个事务中包含堆事务型表的操作(innodb)和非事务型表的操作(myisam)，在正常的提交下没有问题，但是如果事务需要回滚，非事务型的表的变更无法撤销，会导致数据库处于不一致的状态</p><h4 id=mysql中是如何实现事务隔离的>Mysql中是如何实现事务隔离的<a hidden class=anchor aria-hidden=true href=#mysql中是如何实现事务隔离的>#</a></h4><p>Read Uncommited 和 Serialable 是基本不考虑的隔离级别，前者不加任何锁的限制，后者相当于单线程执行效率差，Mysql在 Read Commited 隔离级别通过行锁和间歇锁的组合(Next-Key)解决了幻读问题，</p><p>间歇锁：使用间隙锁锁住的是一个区间，而不仅仅是这个区间中的每一条数据。
举例来说，假如emp表中只有101条记录，其empid的值分别是1,2,&mldr;,100,101，下面的SQL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>emp</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>empid</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=w>
</span></span></span></code></pre></div><p>当我们用条件检索数据，并请求共享或排他锁时，InnoDB不仅会对符合条件的empid值为101的记录加锁，也会对empid大于101（这些记录并不存在）的“间隙”加锁。</p><p>这个时候如果你插入empid等于102的数据的，如果那边事物还没有提交，那你就会处于等待状态，无法插入数据。</p><h4 id=mvcc>MVCC<a hidden class=anchor aria-hidden=true href=#mvcc>#</a></h4><blockquote><p>MVCC即多版本并发控制，MVCC的实现是通过保存数据在某一个时间点的快照来实现的，根据事务开始的时间点不同，每个事务对同一表看到的数据可能是不相同的</p></blockquote><p>对于Innodb存储引擎聚簇索引记录包含三个隐藏的列：</p><ol><li>ROW ID:隐藏的自增ID，如果表没有主键，Innodb会按照ROW ID产生一个聚集索引树。</li><li>事务ID，记录最后一次修改该记录的事务ID</li><li>回滚指针：指向这条记录的上一个版本</li></ol><p><img loading=lazy src=./images/Snipaste_2022-04-20_22-26-34.jpg alt></p><p>如图：首先 insert 语句向表 t1 中插入了一条数据，a 字段为 1，b 字段为 1， ROW ID 也为 1 ，事务 ID 假设为 1，回滚指针假设为 null。当执行 update t1 set b=666 where a=1 时，大致步骤如下：</p><ol><li>数据库会先对满足<code>a=1</code>的行加排他锁</li><li>复制原记录到undolog中</li><li>修改匹配到的行记录b的值为666，修改事务ID为当前事务的ID</li><li>修改隐藏回滚指针使其指向undolog中的上一条记录</li><li>提交事务，释放之前对满足<code>a=1</code>的行加的排他锁</li></ol><p>Innodb的每一行都有一个隐藏的列回滚指针用于指向该行修改前的一个版本的数据，这个数据存储在undolog中，如果要执行更新操作哪个会把该行的记录复制到undolog中，修改完该行的数据之后会把回滚指针指向undolog中保存的该行的上一个版本记录，当其他事务需要查询时，通过回滚指针查询undolog中保存的上个版本的数据</p><p>MVCC的最大好处是读不加锁，读写不冲突，极大地增加了Mysql的并发性，通过MVCC保证了事务ACID中的I隔离性</p><h3 id=myisam引擎>MyISAM引擎<a hidden class=anchor aria-hidden=true href=#myisam引擎>#</a></h3><h4 id=特点-1>特点：<a hidden class=anchor aria-hidden=true href=#特点-1>#</a></h4><ol><li>不支持事务</li><li>只能支持表锁</li><li>不支持外键</li><li>每个表用三个文件存储，.frm文件存储表定义，.MYD文件存储数据，.MYI文件存储索引</li></ol><h3 id=查询数据库的表的引擎>查询数据库的表的引擎<a hidden class=anchor aria-hidden=true href=#查询数据库的表的引擎>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>table_schema</span><span class=p>,</span><span class=n>table_name</span><span class=p>,</span><span class=kp>ENGINE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=kp>TABLES</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>table_schema</span><span class=o>=</span><span class=s1>&#39;xxx&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=修改表的存储引擎>修改表的存储引擎<a hidden class=anchor aria-hidden=true href=#修改表的存储引擎>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>xxx</span><span class=w> </span><span class=kp>engine</span><span class=w> </span><span class=n>innodb</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=缓冲区池>缓冲区池<a hidden class=anchor aria-hidden=true href=#缓冲区池>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查看缓冲区池大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>innodb_buffer_pool_size</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=日志>日志<a hidden class=anchor aria-hidden=true href=#日志>#</a></h2><h3 id=错误日志>错误日志<a hidden class=anchor aria-hidden=true href=#错误日志>#</a></h3><p>记录一些error和warn信息</p><p>默认是开启的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查看错误日志目录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>@@</span><span class=n>log_error</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#这个参数不可以使用 set global log_error=xxx这样的方式修改，只能修改配置文件然后重启mysql
</span></span></span><span class=line><span class=cl><span class=c1>#配置文件在basedir对应的路径下，可以使用select @@basedir查看
</span></span></span><span class=line><span class=cl><span class=c1>#windows下的配置文件是my.ini文件，linux下配置文件是my.cnf
</span></span></span><span class=line><span class=cl><span class=c1>#添加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>log_error</span><span class=o>=</span><span class=n>xxx</span><span class=err>\</span><span class=n>mysql</span><span class=p>.</span><span class=n>log</span><span class=w>
</span></span></span></code></pre></div><h3 id=二进制日志>二进制日志<a hidden class=anchor aria-hidden=true href=#二进制日志>#</a></h3><ul><li>备份恢复需要依赖二进制日志</li><li>主从环境依赖二进制日志</li></ul><p>默认没有开启</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#标志,0表示没开启，1表示开启
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>log_bin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#日志路径及名字
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>log_bin_basename</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#服务id号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>server_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#二进制格式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>binlog_format</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#这几个参数也是必须要在配置文件中配置，不能再命令行修改
</span></span></span></code></pre></div><p>binlog记录的是什么？记录的是变更的sql语句，不记录查询日志。会记录DDL、DCL、DML，对于DDL和DCL是全部记录，但是对于DML只记录提交了的事务。</p><p><strong>binlog_format</strong>指定二进制日志的格式，有<strong>row</strong>、<strong>statement</strong>、<strong>mixed</strong>三种，row是记录数据行的变化、statement原封不动的记录所有DML，这种模式不够严谨，可能出现数据不一致，因为他是记录sql，在恢复时相当于重新执行一遍sql，如果sql中有与时间相关的就可能出现数据不一致、mixed是row和statement的混合</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查看所有二进制日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=k>binary</span><span class=w> </span><span class=n>logs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>logs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#刷新日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>flush</span><span class=w> </span><span class=n>logs</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看正在使用的日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看日志事件
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>binlog</span><span class=w> </span><span class=n>events</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=s1>&#39;mysql-bin.000003&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=从日志中恢复数据>从日志中恢复数据<a hidden class=anchor aria-hidden=true href=#从日志中恢复数据>#</a></h4><p>在测试之前，应该确认二进制日志文件是否开启</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#0为关闭，1为开启
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>log_bin</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>如果没有开启要在mysql的配置文件中配置，windows下为my.ini，linux下为/etc/my.cnf，</p><p>需要添加 log_bin=/xxxx 配置二进制文件放置的位置,这个目录必须是datadir下的，不然会报错</p><h5 id=mysqlbinlog参数>mysqlbinlog参数<a hidden class=anchor aria-hidden=true href=#mysqlbinlog参数>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=o>--</span><span class=n>start</span><span class=o>-</span><span class=n>position</span><span class=w>	</span><span class=err>截取的起始</span><span class=n>position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>--</span><span class=n>stop</span><span class=o>-</span><span class=n>position</span><span class=w>	</span><span class=err>截取的终止</span><span class=n>position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>d</span><span class=w>	</span><span class=err>指定数据库的日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysqlbinlog</span><span class=w> </span><span class=o>--</span><span class=n>start</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>316</span><span class=w> </span><span class=o>--</span><span class=n>stop</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>1018</span><span class=w> </span><span class=o>/</span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>0000</span><span class=n>xx</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>ttt</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span></code></pre></div><h5 id=恢复>恢复<a hidden class=anchor aria-hidden=true href=#恢复>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#创建表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=o>`</span><span class=n>ttt</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>sno</span><span class=o>`</span><span class=w> </span><span class=kt>int</span><span class=p>(</span><span class=mi>11</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=no>NULL</span><span class=w> </span><span class=kp>AUTO_INCREMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>`</span><span class=n>sname</span><span class=o>`</span><span class=w> </span><span class=kt>varchar</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=no>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>sno</span><span class=o>`</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=err>；</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#在新建的表中插入数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>ttt</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=s1>&#39;aaa&#39;</span><span class=p>),(</span><span class=s1>&#39;bbb&#39;</span><span class=p>),(</span><span class=s1>&#39;ccc&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#删除数据库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>drop</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>ttt</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看正在使用的二进制日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看日志判断误操作的位置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>binlog</span><span class=w> </span><span class=n>events</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=s1>&#39;mysql-bin.0000xx&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#使用mysqlbinlog来生成sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqlbinlog</span><span class=w> </span><span class=o>--</span><span class=n>start</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>316</span><span class=w> </span><span class=o>--</span><span class=n>stop</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>1018</span><span class=w> </span><span class=o>/</span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>0000</span><span class=n>xx</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>ttt</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#登录mysql使用source命令执行sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>use</span><span class=w> </span><span class=n>xxx</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=o>--</span><span class=err>关闭记录日志，恢复操作不需要记录日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>source</span><span class=w> </span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>ttt</span><span class=p>.</span><span class=k>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#这样就把数据恢复了，从二进制日志中导出的sql是某一状态下操作的sql，所以要恢复必须要把数据恢复到某一时刻，然后执行二进制日志导出的sql，相当于在某一状态下，又把这些语句执行了一遍
</span></span></span><span class=line><span class=cl><span class=c1>#所以二进制文件通常配合备份一起使用
</span></span></span></code></pre></div><h4 id=gtid>GTID<a hidden class=anchor aria-hidden=true href=#gtid>#</a></h4><p>gtid是在5.6添加的，主要是解决二进制日志文件中截取片段查找起点和终点position不方便的问题。</p><p>在mysql5.7版本中gtid即使不开启也会自动生成</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查看gtid
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>@@</span><span class=n>gtid_next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ANONYMOUS</span><span class=w>
</span></span></span></code></pre></div><p>gtid由两部分组成source_id ：transaction_id source_id 为一个机器的唯一id，transaction_id是一个自增事务id
7E11FA47-31CA-19E1-9E56-C43AA21293967:29</p><p>可以在mysql的配置文件,windows下为my.ini，linux下为my.cnf中显式添加配置</p><p>gtid-mode=on 开启gtid
enforce-gtid-consistency=true 强制gtid的一致性</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>Master</span><span class=w> </span><span class=p>[(</span><span class=n>none</span><span class=p>)]</span><span class=o>&gt;</span><span class=k>create</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>gtid</span><span class=w> </span><span class=kp>charset</span><span class=w> </span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=nf>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[(</span><span class=n>none</span><span class=p>)]</span><span class=o>&gt;</span><span class=k>show</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+----------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>File</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>Position</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Binlog_Do_DB</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Binlog_Ignore_DB</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Executed_Gtid_Set</span><span class=w>                      </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+----------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000004</span><span class=w> </span><span class=o>|</span><span class=w>      </span><span class=mi>326</span><span class=w> </span><span class=o>|</span><span class=w>              </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w> </span><span class=n>dff98809</span><span class=o>-</span><span class=mi>55</span><span class=n>c3</span><span class=o>-</span><span class=mi>11</span><span class=n>e9</span><span class=o>-</span><span class=n>a58b</span><span class=o>-</span><span class=mi>000</span><span class=n>c2928f5dd</span><span class=p>:</span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+----------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=kt>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[(</span><span class=n>none</span><span class=p>)]</span><span class=o>&gt;</span><span class=k>use</span><span class=w> </span><span class=n>gtid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Database</span><span class=w> </span><span class=n>changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[</span><span class=n>gtid</span><span class=p>]</span><span class=o>&gt;</span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=nf>t1</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=kt>int</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=nf>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[</span><span class=n>gtid</span><span class=p>]</span><span class=o>&gt;</span><span class=k>show</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+------------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>File</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>Position</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Binlog_Do_DB</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Binlog_Ignore_DB</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Executed_Gtid_Set</span><span class=w>                        </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+------------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000004</span><span class=w> </span><span class=o>|</span><span class=w>      </span><span class=mi>489</span><span class=w> </span><span class=o>|</span><span class=w>              </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w> </span><span class=n>dff98809</span><span class=o>-</span><span class=mi>55</span><span class=n>c3</span><span class=o>-</span><span class=mi>11</span><span class=n>e9</span><span class=o>-</span><span class=n>a58b</span><span class=o>-</span><span class=mi>000</span><span class=n>c2928f5dd</span><span class=p>:</span><span class=mi>1</span><span class=o>-</span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+------------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=kt>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[</span><span class=n>gtid</span><span class=p>]</span><span class=o>&gt;</span><span class=n>begin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=nf>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[</span><span class=n>gtid</span><span class=p>]</span><span class=o>&gt;</span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>t1</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=nf>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[</span><span class=n>gtid</span><span class=p>]</span><span class=o>&gt;</span><span class=n>commit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=nf>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Master</span><span class=w> </span><span class=p>[</span><span class=n>gtid</span><span class=p>]</span><span class=o>&gt;</span><span class=k>show</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+------------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>File</span><span class=w>             </span><span class=o>|</span><span class=w> </span><span class=n>Position</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Binlog_Do_DB</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Binlog_Ignore_DB</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Executed_Gtid_Set</span><span class=w>                        </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+------------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000004</span><span class=w> </span><span class=o>|</span><span class=w>     </span><span class=mi>1068</span><span class=w> </span><span class=o>|</span><span class=w>              </span><span class=o>|</span><span class=w>                  </span><span class=o>|</span><span class=w> </span><span class=n>dff98809</span><span class=o>-</span><span class=mi>55</span><span class=n>c3</span><span class=o>-</span><span class=mi>11</span><span class=n>e9</span><span class=o>-</span><span class=n>a58b</span><span class=o>-</span><span class=mi>000</span><span class=n>c2928f5dd</span><span class=p>:</span><span class=mi>1</span><span class=o>-</span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+------------------+----------+--------------+------------------+------------------------------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>1</span><span class=w> </span><span class=n>row</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=kt>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>可以看到每执行一条DDL、DCL就是一个事务，而执行DML时，只有事务提交了，那么事务号才增加</p><p>gtid模式下是由mysqlbinlog来截取日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#--include-gtids是指定要截取的事务号范围，包括前界和后界，这里是截取1-6号事务日志
</span></span></span><span class=line><span class=cl><span class=c1>#--exclude-gtids是指定截取的事务号返回内需要跳过的事务号，多个需要跳过的使用，分割
</span></span></span><span class=line><span class=cl><span class=c1>#--skip-gtids是指定截取日志是跳过gtid，因为开启gtid后，如果是相同的gtid那么就不会再执行，如果不跳过，那么在恢复的时候会跳过这些事务
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqlbinlog</span><span class=w> </span><span class=o>--</span><span class=n>skip</span><span class=o>-</span><span class=n>gtids</span><span class=w> </span><span class=o>--</span><span class=n>include</span><span class=o>-</span><span class=n>gtids</span><span class=o>=</span><span class=s1>&#39;dff98809-55c3-11e9-a58b-000c2928f5dd:1-6&#39;</span><span class=w> </span><span class=o>--</span><span class=n>exclude</span><span class=o>-</span><span class=n>gtids</span><span class=o>=</span><span class=s1>&#39;dff98809-55c3-11e9-a58b-000c2928f5dd:4&#39;</span><span class=w>  </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>binlog</span><span class=o>/</span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000004</span><span class=w>
</span></span></span></code></pre></div><p>使用截取的日志sql来恢复</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>source</span><span class=w> </span><span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>binlog</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=slowlog>slowlog<a hidden class=anchor aria-hidden=true href=#slowlog>#</a></h3><p>作用：记录慢SQL，定位低效SQL语句</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#查询slowlog是否开启，默认没开启
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>slow_query_log</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查询慢语句日志目录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>slow_query_log_file</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看慢查询语句时间阈值，超过这个阈值就是慢sql,默认为10秒
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>long_query_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查询是否开启不走索引语句记录慢日志，0为关闭，1为开启
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>@@</span><span class=n>log_queries_not_using_indexes</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>需要在配置文件中添加相关配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>slow_query_log</span><span class=o>=</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>slow_query_log_file</span><span class=o>=</span><span class=n>C</span><span class=p>:</span><span class=err>\</span><span class=n>Program</span><span class=w> </span><span class=nf>Files</span><span class=w> </span><span class=p>(</span><span class=n>x86</span><span class=p>)</span><span class=err>\</span><span class=n>MySQL</span><span class=err>\</span><span class=n>MySQL</span><span class=w> </span><span class=n>Server</span><span class=w> </span><span class=mi>5</span><span class=p>.</span><span class=mi>5</span><span class=err>\</span><span class=n>slow</span><span class=p>.</span><span class=n>log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>long_query_time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>log_queries_not_using_indexes</span><span class=o>=</span><span class=mi>1</span><span class=w>
</span></span></span></code></pre></div><p>重启数据库</p><p>执行一些耗时的sql后查看慢日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tex data-lang=tex><span class=line><span class=cl>C:<span class=k>\Program</span> Files (x86)<span class=k>\MySQL\MySQL</span> Server 5.5<span class=k>\bin\mysqld</span>, Version: 5.5.28-log (MySQL Community Server (GPL)). started with:
</span></span><span class=line><span class=cl>TCP Port: 3306, Named Pipe: (null)
</span></span><span class=line><span class=cl>Time                 Id Command    Argument
</span></span><span class=line><span class=cl>C:<span class=k>\Program</span> Files (x86)<span class=k>\MySQL\MySQL</span> Server 5.5<span class=k>\bin\mysqld</span>, Version: 5.5.28-log (MySQL Community Server (GPL)). started with:
</span></span><span class=line><span class=cl>TCP Port: 3306, Named Pipe: (null)
</span></span><span class=line><span class=cl>Time                 Id Command    Argument
</span></span><span class=line><span class=cl># Time: 200529 21:37:48
</span></span><span class=line><span class=cl># User@Host: root[root] @ localhost [127.0.0.1]
</span></span><span class=line><span class=cl># Query<span class=nb>_</span>time: 1.233220  Lock<span class=nb>_</span>time: 0.013930 Rows<span class=nb>_</span>sent: 636438  Rows<span class=nb>_</span>examined: 636438
</span></span><span class=line><span class=cl>use oldboy;
</span></span><span class=line><span class=cl>SET timestamp=1590759468;
</span></span><span class=line><span class=cl>select * from t<span class=nb>_</span>100w;
</span></span><span class=line><span class=cl># Time: 200529 21:39:39
</span></span><span class=line><span class=cl># User@Host: root[root] @ localhost [127.0.0.1]
</span></span><span class=line><span class=cl># Query<span class=nb>_</span>time: 0.338753  Lock<span class=nb>_</span>time: 0.000000 Rows<span class=nb>_</span>sent: 1  Rows<span class=nb>_</span>examined: 636438
</span></span><span class=line><span class=cl>SET timestamp=1590759579;
</span></span><span class=line><span class=cl>select count(*) from t<span class=nb>_</span>100w;
</span></span><span class=line><span class=cl># Time: 200529 21:40:18
</span></span><span class=line><span class=cl># User@Host: root[root] @ localhost [127.0.0.1]
</span></span><span class=line><span class=cl># Query<span class=nb>_</span>time: 0.449270  Lock<span class=nb>_</span>time: 0.000000 Rows<span class=nb>_</span>sent: 1  Rows<span class=nb>_</span>examined: 636438
</span></span><span class=line><span class=cl>SET timestamp=1590759618;
</span></span><span class=line><span class=cl>select * from t<span class=nb>_</span>100w where id=10000;
</span></span><span class=line><span class=cl># Time: 200529 21:41:34
</span></span><span class=line><span class=cl># User@Host: root[root] @ localhost [127.0.0.1]
</span></span><span class=line><span class=cl># Query<span class=nb>_</span>time: 0.503289  Lock<span class=nb>_</span>time: 0.000000 Rows<span class=nb>_</span>sent: 10  Rows<span class=nb>_</span>examined: 636448
</span></span><span class=line><span class=cl>SET timestamp=1590759694;
</span></span><span class=line><span class=cl>select * from t<span class=nb>_</span>100w where id&lt;10000 order by k1 limit 10;
</span></span></code></pre></div><p>使用<strong>mysqldumpslow</strong>工具来分析慢日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#-s是指定排序规则	c：按访问次数降序排序	l：按锁定时间降序排序	r：按返回记录降序排序	al：平均锁定时间降序排序	ar：平均访问次数降序排序	at：平均查询时间降序排序</span>
</span></span><span class=line><span class=cl><span class=c1>#-t是指定显示条数</span>
</span></span><span class=line><span class=cl>mysqldumpslow -s c -t <span class=m>3</span> slow.log
</span></span></code></pre></div><h2 id=备份>备份<a hidden class=anchor aria-hidden=true href=#备份>#</a></h2><h3 id=备份类型>备份类型<a hidden class=anchor aria-hidden=true href=#备份类型>#</a></h3><ul><li><p>热备份</p><p>在数据库正常业务时，进行备份，并且能够保证数据一致性</p></li><li><p>温备份</p><p>锁表备份，只能查询不能增删改</p></li><li><p>冷备份</p><p>关闭数据库业务，在数据库没有任何变更的情况下进行备份</p></li></ul><h3 id=备份方式>备份方式<a hidden class=anchor aria-hidden=true href=#备份方式>#</a></h3><h4 id=逻辑备份>逻辑备份<a hidden class=anchor aria-hidden=true href=#逻辑备份>#</a></h4><p>基于sql进行备份</p><ul><li>mysqldump</li><li>mysqlbinlog</li></ul><h4 id=物理备份>物理备份<a hidden class=anchor aria-hidden=true href=#物理备份>#</a></h4><p>基于磁盘数据进行备份</p><ul><li>xtrabackup：percona第三方</li></ul><h4 id=逻辑备份和物理备份比较>逻辑备份和物理备份比较<a hidden class=anchor aria-hidden=true href=#逻辑备份和物理备份比较>#</a></h4><ul><li><p>mysqldump</p><p>优点：</p><p>​ 1不需要下载安装</p><p>​ 2备份出来的是sql，可读性高</p><p>​ 3压缩比高，节省磁盘空间</p><p>缺点：</p><p>​ 1依赖于数据库引擎，需要从磁盘把数据读出，然后转换成sql，耗费资源</p><p>​ 2对于大量数据（100G以上）效率很差</p></li><li><p>xtrabackup</p><p>优点：</p><p>​ 1类似于直接拷贝物理文件，不需要管逻辑结构，效率高</p><p>​ 2由于是直接拷贝的物理文件，可读性差</p><p>​ 3压缩比低，耗费更多的磁盘空间</p></li></ul><h4 id=mysqldump>mysqldump<a hidden class=anchor aria-hidden=true href=#mysqldump>#</a></h4><h5 id=备份方式-1>备份方式<a hidden class=anchor aria-hidden=true href=#备份方式-1>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=o>-</span><span class=n>u</span><span class=w> </span><span class=o>-</span><span class=n>p</span><span class=w> </span><span class=o>-</span><span class=n>S</span><span class=w> </span><span class=o>-</span><span class=n>h</span><span class=w> </span><span class=o>-</span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#本地备份
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqlsump</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>pxxx</span><span class=w> </span><span class=o>-</span><span class=n>S</span><span class=w> </span><span class=o>/</span><span class=n>temp</span><span class=o>/</span><span class=n>mysql</span><span class=p>.</span><span class=n>sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#远程备份	在进行远程备份时，远程数据库版本必须和本地mysqldump命令数据库版本一致
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqldump</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>pxxx</span><span class=w> </span><span class=o>-</span><span class=n>h</span><span class=w> </span><span class=mi>10</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>0</span><span class=p>.</span><span class=mi>51</span><span class=w> </span><span class=o>-</span><span class=n>P3306</span><span class=w>
</span></span></span></code></pre></div><h5 id=全备份全库>全备份（全库）<a hidden class=anchor aria-hidden=true href=#全备份全库>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#	-A参数全部数据库备份
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqldump</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>pxxx</span><span class=w> </span><span class=o>-</span><span class=n>A</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>dir</span><span class=o>/</span><span class=n>full</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span></code></pre></div><h5 id=单多库备份>单（多）库备份<a hidden class=anchor aria-hidden=true href=#单多库备份>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#	-B参数备份多个数据库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqldump</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>pxxx</span><span class=w> </span><span class=o>-</span><span class=n>B</span><span class=w> </span><span class=n>hello</span><span class=w> </span><span class=n>world</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>dir</span><span class=o>/</span><span class=n>hellowordld</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span></code></pre></div><h5 id=单多表备份>单（多）表备份<a hidden class=anchor aria-hidden=true href=#单多表备份>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#	备份数据库下的单个或多个表
</span></span></span><span class=line><span class=cl><span class=c1>#	备份stumanage下的student，course，sc三张表
</span></span></span><span class=line><span class=cl><span class=c1>#这种方式进行恢复的时候，数据库必须存在，且必须use才能source
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqldump</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>pxxx</span><span class=w> </span><span class=n>stumanage</span><span class=w> </span><span class=n>student</span><span class=w> </span><span class=n>course</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>dir</span><span class=o>/</span><span class=n>tb</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span></code></pre></div><h5 id=按各个库的每张表生产一个备份语句>按各个库的每张表生产一个备份语句<a hidden class=anchor aria-hidden=true href=#按各个库的每张表生产一个备份语句>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=nf>CONCAT</span><span class=p>(</span><span class=s1>&#39;mysqldump -uroot -pxxx &#39;</span><span class=p>,</span><span class=n>table_schema</span><span class=p>,</span><span class=s1>&#39; &#39;</span><span class=p>,</span><span class=n>table_name</span><span class=p>,</span><span class=s1>&#39;&gt;/backup/&#39;</span><span class=p>,</span><span class=n>table_schema</span><span class=p>,</span><span class=s1>&#39;_&#39;</span><span class=p>,</span><span class=n>table_name</span><span class=p>,</span><span class=s1>&#39;.sql&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>information_schema</span><span class=p>.</span><span class=kp>tables</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>table_schema</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;sys&#39;</span><span class=p>,</span><span class=s1>&#39;information_schema&#39;</span><span class=p>,</span><span class=s1>&#39;performance_schema&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INTO</span><span class=w> </span><span class=k>OUTFILE</span><span class=w> </span><span class=s1>&#39;/backup/tb_back.sh&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h5 id=mysqldump高级参数>mysqldump高级参数<a hidden class=anchor aria-hidden=true href=#mysqldump高级参数>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=o>-</span><span class=n>R</span><span class=w>	</span><span class=err>备份存储过程及函数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>--</span><span class=n>triggers</span><span class=w>	</span><span class=err>备份触发器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>E</span><span class=w>	</span><span class=err>备份事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=n>F</span><span class=w>	</span><span class=err>在备份的时候，刷新一个新的</span><span class=n>binlog</span><span class=err>日志</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>--</span><span class=n>master</span><span class=o>-</span><span class=kt>date</span><span class=o>=</span><span class=mi>2</span><span class=w>	</span><span class=err>以注释的形式保存备份开启事件的</span><span class=n>binlog</span><span class=err>的</span><span class=n>position</span><span class=err>，方便恢复</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>--</span><span class=n>single</span><span class=o>-</span><span class=n>transaction</span><span class=w>	</span><span class=n>innodb</span><span class=err>存储引擎开启热备</span><span class=w>
</span></span></span></code></pre></div><h3 id=mysqldumpbinlog恢复数据库>mysqldump+binlog恢复数据库<a hidden class=anchor aria-hidden=true href=#mysqldumpbinlog恢复数据库>#</a></h3><p><strong>先全备数据库stumanage</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>mysqldump</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>pxxx</span><span class=w> </span><span class=o>-</span><span class=n>B</span><span class=w> </span><span class=n>stumanage</span><span class=w> </span><span class=o>--</span><span class=k>trigger</span><span class=w> </span><span class=o>-</span><span class=n>R</span><span class=w> </span><span class=o>-</span><span class=n>E</span><span class=w> </span><span class=o>--</span><span class=n>master</span><span class=o>-</span><span class=n>data</span><span class=o>=</span><span class=mi>2</span><span class=w> </span><span class=o>--</span><span class=n>single</span><span class=o>-</span><span class=n>transaction</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>D</span><span class=p>:</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>bak</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span></code></pre></div><p><strong>然后向表中插入一些数据</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>stumanage</span><span class=p>.</span><span class=n>student</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>11</span><span class=p>,</span><span class=s1>&#39;test11&#39;</span><span class=p>,</span><span class=s1>&#39;男&#39;</span><span class=p>,</span><span class=mi>11</span><span class=p>,</span><span class=s1>&#39;挖掘机工程&#39;</span><span class=p>)</span><span class=err>，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>22</span><span class=p>,</span><span class=s1>&#39;test22&#39;</span><span class=p>,</span><span class=s1>&#39;男&#39;</span><span class=p>,</span><span class=mi>22</span><span class=p>,</span><span class=s1>&#39;水利工程&#39;</span><span class=p>)</span><span class=err>；</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#向另一些数据库的表中插入数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=n>t1</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>1</span><span class=p>),(</span><span class=mi>2</span><span class=p>),(</span><span class=mi>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#删除另一个数据库的表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>drop</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=n>t2</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><strong>模拟误操作删除数据库stumanage</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>drop</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>stumanage</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><strong>分析日志</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mysql -uroot -pxxx -e <span class=s2>&#34;show binlog events in &#39;mysql-bin.000010&#39;&#34;</span> <span class=p>|</span>tail -100 <span class=p>|</span>grep -i <span class=s1>&#39;drop&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>找到drop语句的开始position
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#在全备中找到备份时开始的position</span>
</span></span><span class=line><span class=cl>-- CHANGE MASTER TO <span class=nv>MASTER_LOG_FILE</span><span class=o>=</span><span class=s1>&#39;mysql-bin.000010&#39;</span>, <span class=nv>MASTER_LOG_POS</span><span class=o>=</span>18166<span class=p>;</span>
</span></span></code></pre></div><p><strong>截取日志</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#	-d stumanage指定只截取stumanage数据库的日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysqlbinlog</span><span class=w> </span><span class=o>-</span><span class=n>d</span><span class=w> </span><span class=n>stumanage</span><span class=w> </span><span class=o>--</span><span class=n>start</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>13732</span><span class=w> </span><span class=o>--</span><span class=n>stop</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>19215</span><span class=w> </span><span class=p>..</span><span class=o>/</span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000010</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>D</span><span class=p>:</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>logbin</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span></code></pre></div><p><strong>恢复日志</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#登录mysql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>pxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#关闭记录日志，恢复操作不需要记录日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#恢复全备
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>source</span><span class=w> </span><span class=n>D</span><span class=p>:</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>bak</span><span class=p>.</span><span class=k>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#恢复日志备份
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>source</span><span class=w> </span><span class=n>D</span><span class=p>:</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>logbin</span><span class=p>.</span><span class=k>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#开启日志记录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h4 id=xbk备份>XBK备份<a hidden class=anchor aria-hidden=true href=#xbk备份>#</a></h4><h5 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h5><p>安装依赖包</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</span></span><span class=line><span class=cl>yum -y install perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL libev
</span></span></code></pre></div><p>下载rpm包</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.12/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.12-1.el7.x86_64.rpm
</span></span></code></pre></div><p>安装xbk</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum -y install percona-xtrabackup-24-2.4.4-1.el7.x86_64.rpm
</span></span></code></pre></div><p>检查是否安装好</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --version
</span></span></code></pre></div><h5 id=全备>全备<a hidden class=anchor aria-hidden=true href=#全备>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#默认在备份目录下生成一个按时间戳命名的文件夹</span>
</span></span><span class=line><span class=cl>innobackupex --user<span class=o>=</span>root --password<span class=o>=</span>xxx /data/backup
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost etc<span class=o>]</span><span class=c1># cd /data/backup/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost backup<span class=o>]</span><span class=c1># ll</span>
</span></span><span class=line><span class=cl>总用量 <span class=m>0</span>
</span></span><span class=line><span class=cl>drwxr-x---. <span class=m>6</span> root root <span class=m>210</span> 6月   <span class=m>4</span> 17:16 2020-06-04_17-16-31
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#不使用时间戳命名备份文件夹，自定义备份文件</span>
</span></span><span class=line><span class=cl>innobackupex --user<span class=o>=</span>root --password<span class=o>=</span>lpt316 --no-timestamp /data/backup/full
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost backup<span class=o>]</span><span class=c1># cd /data/backup/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost backup<span class=o>]</span><span class=c1># ll</span>
</span></span><span class=line><span class=cl>总用量 <span class=m>0</span>
</span></span><span class=line><span class=cl>drwxr-x---. <span class=m>6</span> root root <span class=m>210</span> 6月   <span class=m>4</span> 17:16 2020-06-04_17-16-31
</span></span><span class=line><span class=cl>drwxr-x---. <span class=m>6</span> root root <span class=m>210</span> 6月   <span class=m>4</span> 17:20 full
</span></span></code></pre></div><h5 id=使用全备恢复>使用全备恢复<a hidden class=anchor aria-hidden=true href=#使用全备恢复>#</a></h5><p>模拟误操作删除数据库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>rm -rf /usr/local/mysql/mysql57/data/stumanage
</span></span></code></pre></div><p>将redo进行重做，已提交的写到数据文件，未提交的使用undo回滚掉</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --apply-log /data/backup/full/
</span></span></code></pre></div><p>准备一个目录，因为进行恢复的时候要求目录必须是空的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir /data/mysql
</span></span></code></pre></div><p>把恢复的数据拷贝到该目录下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cp -a /data/backup/full/ /data/mysql1/
</span></span></code></pre></div><p>授权(<strong>必须在拷贝之后授权</strong>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>chown -R mysql.mysql /data/mysql1
</span></span></code></pre></div><p>修改mysql的配置文件数据目录</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /etc/my.cnf
</span></span><span class=line><span class=cl>修改
</span></span><span class=line><span class=cl><span class=nv>datadir</span><span class=o>=</span>/data/mysql
</span></span></code></pre></div><p>重启mysql</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>service mysqld start
</span></span></code></pre></div><h5 id=增量备份>增量备份<a hidden class=anchor aria-hidden=true href=#增量备份>#</a></h5><p>首先进行全备</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --user<span class=o>=</span>root --password<span class=o>=</span>lpt316 --socket<span class=o>=</span>/tmp/mysql.sock --no-timestamp /data/backup/full
</span></span></code></pre></div><p>模拟第一天数据改变</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=nf>t1</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=kt>INT</span><span class=p>)</span><span class=kp>ENGINE</span><span class=o>=</span><span class=n>INNODB</span><span class=w> </span><span class=kp>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=n>t1</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>1</span><span class=p>),(</span><span class=mi>2</span><span class=p>),(</span><span class=mi>3</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>进行第一天的增量备份</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --user<span class=o>=</span>root --password<span class=o>=</span>lpt316 --socket<span class=o>=</span>/tmp/mysql.sock --no-timestamp --incremental --incremental-basedir<span class=o>=</span>/data/backup/full/ /data/backup/inc1
</span></span></code></pre></div><p>模拟第二天数据变化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=nf>t2</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=kt>INT</span><span class=p>)</span><span class=kp>ENGINE</span><span class=o>=</span><span class=n>INNODB</span><span class=w> </span><span class=kp>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=n>t2</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>1</span><span class=p>),(</span><span class=mi>2</span><span class=p>),(</span><span class=mi>3</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>进行第二天的全备</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --user<span class=o>=</span>root --password<span class=o>=</span>lpt316 --socket<span class=o>=</span>/tmp/mysql.sock --no-timestamp --incremental --incremental-basedir<span class=o>=</span>/data/backup/inc1/ /data/backup/inc2
</span></span></code></pre></div><p>模拟第三天数据变化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=nf>t3</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=kt>INT</span><span class=p>)</span><span class=kp>ENGINE</span><span class=o>=</span><span class=n>INNODB</span><span class=w> </span><span class=kp>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=n>t3</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>1</span><span class=p>),(</span><span class=mi>2</span><span class=p>),(</span><span class=mi>3</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>进行第三天的增量备份</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --user<span class=o>=</span>root --password<span class=o>=</span>lpt316 --socket<span class=o>=</span>/tmp/mysql.sock --no-timestamp --incremental --incremental-basedir<span class=o>=</span>/data/backup/inc2/ /data/backup/inc3
</span></span></code></pre></div><p>模拟故障之前一些操作</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>test</span><span class=p>.</span><span class=n>t3</span><span class=w> </span><span class=k>VALUES</span><span class=p>(</span><span class=mi>5</span><span class=p>),(</span><span class=mi>6</span><span class=p>),(</span><span class=mi>7</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>模拟误错误删除了库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>rm -rf /data/mysql/test/
</span></span></code></pre></div><p>恢复</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#整理全备</span>
</span></span><span class=line><span class=cl>innobackupex --apply-log --redo-only /data/backup/full/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#把inc1合并到full</span>
</span></span><span class=line><span class=cl>innobackupex --apply-log --redo-only --incremental-dir<span class=o>=</span>/data/backup/inc1 /data/backup/full/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#把inc2合并到full</span>
</span></span><span class=line><span class=cl>innobackupex --apply-log --redo-only --incremental-dir<span class=o>=</span>/data/backup/inc2 /data/backup/full/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#把inc3合并到full</span>
</span></span><span class=line><span class=cl>innobackupex --apply-log  --incremental-dir<span class=o>=</span>/data/backup/inc3 /data/backup/full/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#最后进行一次全备整理</span>
</span></span><span class=line><span class=cl>innobackupex --apply-log  /data/backup/full
</span></span></code></pre></div><p>新建目录，把恢复的文件拷贝过去，并授权</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@localhost backup<span class=o>]</span><span class=c1># mkdir /data/mysql2</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost backup<span class=o>]</span><span class=c1># cp -a full/* /data/mysql2/</span>
</span></span><span class=line><span class=cl><span class=o>[</span>root@localhost backup<span class=o>]</span><span class=c1># chown -R mysql.mysql /data/mysql2</span>
</span></span></code></pre></div><p>截取故障当天的二进制日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#判断起点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>cat</span><span class=w> </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>inc3</span><span class=o>/</span><span class=n>xtrabackup_binlog_info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#找到终点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>plpt316</span><span class=w> </span><span class=o>-</span><span class=n>e</span><span class=w> </span><span class=s2>&#34;show binlog events in &#39;mysql-bin.000002&#39;&#34;</span><span class=w> </span><span class=o>|</span><span class=n>grep</span><span class=w> </span><span class=k>drop</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#导出二进制日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>.</span><span class=o>/</span><span class=n>mysqlbinlog</span><span class=w> </span><span class=o>--</span><span class=n>start</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>2681</span><span class=w> </span><span class=o>--</span><span class=n>stop</span><span class=o>-</span><span class=n>position</span><span class=o>=</span><span class=mi>3006</span><span class=w> </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>mysql</span><span class=o>/</span><span class=n>mysql</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000002</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>binlog</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span></code></pre></div><p>关闭数据库</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>service mysqld stop
</span></span></code></pre></div><p>修改mysql的配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vim /etc/my.cnf
</span></span><span class=line><span class=cl><span class=nv>datadir</span><span class=o>=</span>/data/mysql2
</span></span></code></pre></div><p>启动mysql</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>service mysqld start
</span></span></code></pre></div><p>此时已恢复到故障前一天的状态</p><p>恢复二进制日志</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>source</span><span class=w> </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=n>binlog</span><span class=p>.</span><span class=k>sql</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>成功恢复到误删除前</p><h5 id=单表恢复>单表恢复<a hidden class=anchor aria-hidden=true href=#单表恢复>#</a></h5><p>进行全备</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --user<span class=o>=</span>root --password<span class=o>=</span>lpt316 --socket<span class=o>=</span>/tmp/mysql.sock --no-timestamp /data/backup/all
</span></span></code></pre></div><p>只删除一个表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=n>ttt</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>恢复</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>innobackupex --apply-log /data/backup/all
</span></span></code></pre></div><p>创建一个和删除表相同结构的表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=nf>ttt</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=kt>INT</span><span class=p>)</span><span class=kp>ENGINE</span><span class=o>=</span><span class=n>INNODB</span><span class=w> </span><span class=kp>CHARSET</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>卸载表空间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#卸载表空间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=n>ttt</span><span class=w> </span><span class=n>DISCARD</span><span class=w> </span><span class=n>TABLESPACE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>把恢复的全备里的相关表文件拷贝到数据库数据文件下，并授权</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cp /data/backup/all/test2/ttt.ibd /data/mysql2/test2/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chown -R mysql.mysql /data/mysql2/test2/ttt.ibd
</span></span></code></pre></div><p>添加表空间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>test2</span><span class=p>.</span><span class=n>ttt</span><span class=w> </span><span class=n>IMPORT</span><span class=w> </span><span class=n>TABLESPACE</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>至此，数据就恢复回来了</p><h2 id=主从复制>主从复制<a hidden class=anchor aria-hidden=true href=#主从复制>#</a></h2><p>主从复制前提：</p><ul><li>两个数据库实例，并配置server_id</li><li>主库需要开启二进制日志</li><li>主库需要建立专用的赋值用户（replication slave）</li><li>主库全备，从库使用备份恢复，保证主库从库一致</li><li>change master to 主库ip 端口 用户名 密码 二进制文件 日志position</li><li>start slave</li></ul><h3 id=主从备份实施>主从备份实施<a hidden class=anchor aria-hidden=true href=#主从备份实施>#</a></h3><ol><li>确保两数据库配置了server_id，并开启了二进制日志</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>主库：
</span></span><span class=line><span class=cl><span class=nv>server_id</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nv>log_bin</span><span class=o>=</span>mysql-bin
</span></span><span class=line><span class=cl><span class=nv>binlog_format</span><span class=o>=</span>row
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>从库：
</span></span><span class=line><span class=cl><span class=nv>server_id</span><span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=nv>log_bin</span><span class=o>=</span>mysql-bin
</span></span><span class=line><span class=cl><span class=nv>binlog_format</span><span class=o>=</span>row
</span></span></code></pre></div><ol start=2><li>主机全备发送到从机执行，确保主从复制前主从库数据一致</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=err>主库：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=o>/</span><span class=n>mysqldump</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>plpt316</span><span class=w> </span><span class=o>-</span><span class=n>A</span><span class=w> </span><span class=o>--</span><span class=n>triggers</span><span class=w> </span><span class=o>-</span><span class=n>R</span><span class=w> </span><span class=o>-</span><span class=n>E</span><span class=w> </span><span class=o>-</span><span class=n>F</span><span class=w> </span><span class=o>--</span><span class=n>master</span><span class=o>-</span><span class=n>data</span><span class=o>=</span><span class=mi>2</span><span class=w> </span><span class=o>--</span><span class=n>single</span><span class=o>-</span><span class=n>transaction</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=mi>20200609</span><span class=n>full</span><span class=p>.</span><span class=k>sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>发送全备到从库：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>scp</span><span class=w> </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=mi>20200609</span><span class=n>full</span><span class=p>.</span><span class=k>sql</span><span class=w> </span><span class=n>root</span><span class=o>@</span><span class=mi>192</span><span class=p>.</span><span class=mi>168</span><span class=p>.</span><span class=mi>37</span><span class=p>.</span><span class=mi>131</span><span class=p>:</span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>backup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>从库：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#登录
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=w> </span><span class=o>-</span><span class=n>uroot</span><span class=w> </span><span class=o>-</span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#设置恢复全备不记录日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#同步主库数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>source</span><span class=w> </span><span class=o>/</span><span class=n>data</span><span class=o>/</span><span class=n>backup</span><span class=o>/</span><span class=mi>20200609</span><span class=n>full</span><span class=p>.</span><span class=k>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#恢复记录sql二进制日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>set</span><span class=w> </span><span class=n>sql_log_bin</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>主库建立一个主从复制专用用户</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>grant</span><span class=w> </span><span class=n>replication</span><span class=w> </span><span class=n>slave</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>rep</span><span class=o>@</span><span class=s1>&#39;192.168.37.*&#39;</span><span class=w> </span><span class=k>identified</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=s1>&#39;lpt316&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>flush</span><span class=w> </span><span class=k>privileges</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=4><li>change master to</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#首先查看全备里的position位置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CHANGE</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>MASTER_LOG_FILE</span><span class=o>=</span><span class=s1>&#39;mysql-bin.000007&#39;</span><span class=p>,</span><span class=w> </span><span class=n>MASTER_LOG_POS</span><span class=o>=</span><span class=mi>154</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CHANGE</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=k>TO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_HOST</span><span class=o>=</span><span class=s1>&#39;192.168.37.130&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_USER</span><span class=o>=</span><span class=s1>&#39;rep&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_PASSWORD</span><span class=o>=</span><span class=s1>&#39;lpt316&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_PORT</span><span class=o>=</span><span class=mi>3306</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_LOG_FILE</span><span class=o>=</span><span class=s1>&#39;mysql-bin.000008&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_LOG_POS</span><span class=o>=</span><span class=mi>154</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_CONNECT_RETRY</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>MASTER_RETRY_COUNT</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><ol start=5><li><code>start slave;</code></li><li>在主库中添加数据看看从库同步了没有</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=err>从库：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test3</span><span class=p>.</span><span class=n>t1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Empty</span><span class=w> </span><span class=kt>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>主库：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>test3</span><span class=p>.</span><span class=n>t1</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>1</span><span class=p>),(</span><span class=mi>2</span><span class=p>),(</span><span class=mi>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Query</span><span class=w> </span><span class=n>OK</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=nf>affected</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Records</span><span class=p>:</span><span class=w> </span><span class=mi>3</span><span class=w>  </span><span class=n>Duplicates</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>  </span><span class=n>Warnings</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>从库查看是否同步：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>test3</span><span class=p>.</span><span class=n>t1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=主从复制原理>主从复制原理<a hidden class=anchor aria-hidden=true href=#主从复制原理>#</a></h3><h4 id=涉及的文件>涉及的文件<a hidden class=anchor aria-hidden=true href=#涉及的文件>#</a></h4><p>主库：</p><ul><li>mysql-bin.00000x：二进制文件</li></ul><p>从库：</p><ul><li>localhost-relay-bin.00000x：中继日志文件</li><li>master.info：主库信息</li><li>relay-log.info：中继日志信息</li></ul><h4 id=涉及的线程>涉及的线程<a hidden class=anchor aria-hidden=true href=#涉及的线程>#</a></h4><p>主库：</p><ul><li>Binlog_Dump_Thread:监控主库，如果有新操作，和Slave_IO_Thread交互，通知从库</li></ul><p>从库：</p><ul><li>Slave_IO_Thread：负责和主库建立TCP/IP连接，和Binlog_Thread交互，当主库通知该线程时，拷贝二进制文件回来</li><li>Slave_SQL_Thread：负责把拷贝回来的二进制文件转换成SQL语句，并在从库中执行，保证主从一致</li></ul><h3 id=主从异常>主从异常<a hidden class=anchor aria-hidden=true href=#主从异常>#</a></h3><h4 id=主从故障>主从故障<a hidden class=anchor aria-hidden=true href=#主从故障>#</a></h4><p>连接问题：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Slave_IO_Running: Connecting
</span></span><span class=line><span class=cl>可能的错误有：
</span></span><span class=line><span class=cl>ip错误
</span></span><span class=line><span class=cl>端口错误
</span></span><span class=line><span class=cl>user，password错误或不允许在该ip登录
</span></span><span class=line><span class=cl>主库未启动
</span></span><span class=line><span class=cl>防火墙未开放端口
</span></span><span class=line><span class=cl>连接已达到上限
</span></span></code></pre></div><p>解决：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>首先ping从库ip看是否网络有问题
</span></span><span class=line><span class=cl>ping xxx.xxx.xxx.xxx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>如何能ping通，可能是端口，用户名，密码等其他问题,在从库使用主从账号远程连接
</span></span><span class=line><span class=cl>mysql -u repl -p xxx -h 192.168.37.111
</span></span></code></pre></div><p>二进制文件问题：</p><p>如：</p><ul><li>二进制文件删除</li><li>二进制文件不全</li><li>主库reset master</li></ul><p>解决：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>停止主从
</span></span><span class=line><span class=cl>stop slave<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>重置从库信息
</span></span><span class=line><span class=cl>reset slave all<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>主库重启导出一个全备，在从库中恢复，重启搭建主从
</span></span></code></pre></div><p>SQL线程故障：</p><ul><li>relay-log.info文件不存在，或不全</li><li>SQL无法执行</li></ul><p>原因：</p><ol><li>版本差异，参数设定不一样</li><li>主从环境不一致，要创建的数据库已经存在，要删除的对象不存在</li></ol><p>解决：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>可以在配置文件中设置
</span></span><span class=line><span class=cl><span class=nv>read_only</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>但是这种方式只能针对普通账户，管理员任然能够修改数据
</span></span></code></pre></div><h4 id=主从延迟>主从延迟<a hidden class=anchor aria-hidden=true href=#主从延迟>#</a></h4><p>主库做的操作，从库很久才能追加上</p><h5 id=外在原因>外在原因<a hidden class=anchor aria-hidden=true href=#外在原因>#</a></h5><ul><li>网络</li><li>主从硬件差异</li><li>版本差异</li><li>参数差异</li></ul><h5 id=主库原因>主库原因<a hidden class=anchor aria-hidden=true href=#主库原因>#</a></h5><ul><li>二进制日志写入不及时：sync_binlog；在mysql5.7默认为1，即立即写入二进制日志</li><li>主库发生了大事务，由于是串行传递，会阻塞后续事务</li></ul><p>解决：</p><p>5.6开始，开启GTID实现Group Commit，可以并行传输日志给从库IO线程</p><p>5.7开始，不开启GTID，会自动维护匿名GTID，也能实现Group Commit</p><h5 id=从库原因>从库原因<a hidden class=anchor aria-hidden=true href=#从库原因>#</a></h5><ul><li>主库并发了大量事务，从库只能串行回放</li><li>主库发生了大事务，会阻塞后续的所有事务</li></ul><p>解决：</p><p>5.6版本开启GTID之后，加入了SQL多线程特性，但是只能针对不同的数据库下的事务进行并行回放</p><p>5.7版本开启GTID之后，在SQL方面，提供了基于逻辑时钟seq_no机制，真正实现了事务级别的并发回放MTS技术</p><h2 id=延时从库>延时从库<a hidden class=anchor aria-hidden=true href=#延时从库>#</a></h2><p>使用原因：预防人为原因导致数据库误删除</p><p>思想：延时从库和普通从库一样，只是延时从库拿到数据写入relaylog中，SQL线程必须延时指定的时间才去运行</p><h3 id=配置>配置<a hidden class=anchor aria-hidden=true href=#配置>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=n>stop</span><span class=w> </span><span class=n>slave</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CHANGE</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>MASTER_DELAY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>300</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>start</span><span class=w> </span><span class=n>slave</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>show</span><span class=w> </span><span class=n>slave</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=err>\</span><span class=n>G</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#从库延时时间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>SQL_Delay</span><span class=p>:</span><span class=w> </span><span class=mi>300</span><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#从库将要执行语句的最近时间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>SQL_Remaining_Delay</span><span class=p>:</span><span class=w> </span><span class=no>NULL</span><span class=w>
</span></span></span></code></pre></div><h3 id=恢复-1>恢复<a hidden class=anchor aria-hidden=true href=#恢复-1>#</a></h3><ol><li>发现错误，及时停止延时从库的SQL线程</li><li>截取relaylog日志，起点为stop sql线程时的relaylog位置，终点为drop之间的位置</li><li>把截取的日志恢复到从库</li><li>从库代替主库工作</li></ol><h3 id=恢复案例>恢复案例<a hidden class=anchor aria-hidden=true href=#恢复案例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#配置延时从库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>stop</span><span class=w> </span><span class=n>slave</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CHANGE</span><span class=w> </span><span class=n>MASTER</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>MASTER_DELAY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>300</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>start</span><span class=w> </span><span class=n>slave</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#在主库中创建一个delay库，并创建一个测试表，插入几条测试数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>create</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>delay</span><span class=w> </span><span class=kp>charset</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>delay</span><span class=p>.</span><span class=nf>test</span><span class=p>(</span><span class=n>num</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=kp>engine</span><span class=o>=</span><span class=n>innodb</span><span class=w> </span><span class=kp>charset</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>delay</span><span class=p>.</span><span class=n>test</span><span class=w> </span><span class=k>values</span><span class=p>(</span><span class=mi>1</span><span class=p>),(</span><span class=mi>2</span><span class=p>),(</span><span class=mi>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#删除主库delay数据库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>drop</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>delay</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#发现错误，立即停止从库SQL线程
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>stop</span><span class=w> </span><span class=n>slave</span><span class=w> </span><span class=n>sql_thread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看relaylog日志的起点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>Relay_Log_File</span><span class=p>:</span><span class=w> </span><span class=n>localhost</span><span class=o>-</span><span class=n>relay</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Relay_Log_Pos</span><span class=p>:</span><span class=w> </span><span class=mi>320</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#查看relaylog找到drop误操作前的位置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>show</span><span class=w> </span><span class=n>relaylog</span><span class=w> </span><span class=n>events</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=s2>&#34;localhost-relay-bin.000002&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>localhost</span><span class=o>-</span><span class=n>relay</span><span class=o>-</span><span class=n>bin</span><span class=p>.</span><span class=mi>000002</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>1016</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Query</span><span class=w>          </span><span class=o>|</span><span class=w>         </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w>         </span><span class=mi>945</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>drop</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>delay</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#截取日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>root</span><span class=o>@</span><span class=n>localhost</span><span class=w> </span><span class=n>bin</span><span class=p>]</span><span class=c1># ./mysqlbinlog --start-position=320 --stop-position=1016 /usr/local/mysql/mysql57/data/localhost-relay-bin.000002 &gt; /tmp/relay.sql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#恢复日志数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>source</span><span class=w> </span><span class=o>/</span><span class=n>tmp</span><span class=o>/</span><span class=n>relay</span><span class=p>.</span><span class=k>sql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#把主库设置为从库或延时从库恢复好的数据导出在主库中恢复
</span></span></span></code></pre></div><h2 id=过滤复制>过滤复制<a hidden class=anchor aria-hidden=true href=#过滤复制>#</a></h2><h3 id=相关参数>相关参数<a hidden class=anchor aria-hidden=true href=#相关参数>#</a></h3><p>主库：</p><p>Binlog_Do_DB：</p><p>Binlog_Ignore_DB：</p><p>这两个是主库空配置要进行复制的白名单和黑名单，不过一般不在主库配置，因为主库配置这两个参数，涉及的库并不会记录二进制日志，不利于使用二进制进行备份</p><p>从库：
Replicate_Do_DB: 复制库白名单
Replicate_Ignore_DB: 复制库黑名单</p><p>Replicate_Do_Table: 复制表白名单
Replicate_Ignore_Table: 复制表黑名单</p><p>Replicate_Wild_Do_Table: 复制表模糊白名单
Replicate_Wild_Ignore_Table:复制表模糊黑名单</p><h3 id=案例>案例<a hidden class=anchor aria-hidden=true href=#案例>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=c1>#修改从库配置文件，设置从库只不复制filter1和filter2数据库数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vim</span><span class=w> </span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>my</span><span class=p>.</span><span class=n>cnf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>添加</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>replicate_ignore_db</span><span class=o>=</span><span class=n>filter1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>replicate_ignore_db</span><span class=o>=</span><span class=n>filter2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>注意配置文件里不能大写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#重启mysql
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>service</span><span class=w> </span><span class=n>mysqld</span><span class=w> </span><span class=n>start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#在主库中创建一个filter1数据库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>create</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=n>filter1</span><span class=w> </span><span class=kp>charset</span><span class=o>=</span><span class=n>utf8</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>#在从库中查询
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>mysql</span><span class=o>&gt;</span><span class=w> </span><span class=k>show</span><span class=w> </span><span class=k>databases</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+--------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=k>Database</span><span class=w>           </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+--------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>information_schema</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>mysql</span><span class=w>              </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>performance_schema</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>sys</span><span class=w>                </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>test2</span><span class=w>              </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>|</span><span class=w> </span><span class=n>test3</span><span class=w>              </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>+--------------------+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=mi>6</span><span class=w> </span><span class=n>rows</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=kt>set</span><span class=w> </span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=n>sec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>并没有</span><span class=n>filter1</span><span class=err>数据库</span><span class=w>
</span></span></span></code></pre></div><h2 id=gtid主从复制>GTID主从复制<a hidden class=anchor aria-hidden=true href=#gtid主从复制>#</a></h2><p>GTID(Global Transaction ID)是对于一个已提交事务的唯一编号，并且是一个全局(主从复制)唯一的编号。
它的官方定义如下：
GTID = source_id ：transaction_id
7E11FA47-31CA-19E1-9E56-C43AA21293967:29</p><h3 id=配置文件核心参数>配置文件核心参数<a hidden class=anchor aria-hidden=true href=#配置文件核心参数>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gtid-mode<span class=o>=</span>on                        --启用gtid类型，否则就是普通的复制架构
</span></span><span class=line><span class=cl>enforce-gtid-consistency<span class=o>=</span><span class=nb>true</span>               --强制GTID的一致性
</span></span><span class=line><span class=cl>log-slave-updates<span class=o>=</span><span class=m>1</span>                 --slave更新是否记入日志
</span></span></code></pre></div><h3 id=从库操作>从库操作<a hidden class=anchor aria-hidden=true href=#从库操作>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=k>change</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=k>to</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>master_host</span><span class=o>=</span><span class=s1>&#39;10.0.0.51&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>master_user</span><span class=o>=</span><span class=s1>&#39;repl&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>master_password</span><span class=o>=</span><span class=s1>&#39;123&#39;</span><span class=w> </span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>MASTER_AUTO_POSITION</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>和传统主从的复制的区别：在启动复制时，不需要指定binlog文件名和position号，直接auto即可自动读取最后一个relay，获取到上次已经复制GTID号，从此号码开始向后复制即可，在MHA高可用环境下，主库无法SSH时，从库进行数据补偿，更加便捷。</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://moyuduo.github.io/>Moyuduo's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>