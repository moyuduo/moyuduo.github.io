<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kustomize | Moyuduo's Blog</title><meta name=keywords content><meta name=description content="是什么 kustomize 使用 k8s 原生概念帮助创建并复用资源配置(YAML)，允许用户以一个应用描述文件 （YAML 文件）为基础（Base YAML），然后通过 Overlay 的方式生成最终部署应用所需的描述文件。
可以把kustomize理解为轻量级的helm。
解决什么问题 一般应用都会存在多套部署环境：开发环境、测试环境、生产环境，多套环境意味着存在多套 K8S 应用资源 YAML。而这么多套 YAML 之间只存在微小配置差异，比如镜像版本不同、Label 不同等，而这些不同环境下的YAML 经常会因为人为疏忽导致配置错误。再者，多套环境的 YAML 维护通常是通过把一个环境下的 YAML 拷贝出来然后对差异的地方进行修改。
概念 kustomization：指的是 kustomization.yaml 文件，或者指的是包含kustomization.yaml 文件的目录以及它里面引用的所有相关文件路径 base：base 指的是一个 kustomization , 任何的 kustomization 包括 overlay，都可以作为另一个 kustomization 的 base (简单理解为基础目录)。base中描述了共享的内容，如资源和常见的资源配置。base 是需要通过 overlay 修订的基础配置 overlay：overlay 是一个 kustomization, 它修改(并因此依赖于)另外一个 kustomization variant：variant 是在集群中将 overlay 应用于 base 的结果。例如开发和生产环境都修改了一些共同 base以创建不同的 variant。这些 variant 使用相同的总体资源，并与简单的方式变化，例如 deployment的副本数、ConfigMap使用的数据源等。简而言之，variant 是含有同一组 base 的不同 resource：resource 是描述 k8s API 对象的 YAML 或 JSON文件的相对路径。即是指向一个声明了 kubernetes API 对象的 YAML 文件 patch：修改文件的一般说明。文件路径，指向一个声明了 kubernetes API patch 的 YAML 文件 安装 go get github."><meta name=author content="Me"><link rel=canonical href=https://moyuduo.github.io/posts/kustomize/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="kustomize"><meta property="og:description" content="是什么 kustomize 使用 k8s 原生概念帮助创建并复用资源配置(YAML)，允许用户以一个应用描述文件 （YAML 文件）为基础（Base YAML），然后通过 Overlay 的方式生成最终部署应用所需的描述文件。
可以把kustomize理解为轻量级的helm。
解决什么问题 一般应用都会存在多套部署环境：开发环境、测试环境、生产环境，多套环境意味着存在多套 K8S 应用资源 YAML。而这么多套 YAML 之间只存在微小配置差异，比如镜像版本不同、Label 不同等，而这些不同环境下的YAML 经常会因为人为疏忽导致配置错误。再者，多套环境的 YAML 维护通常是通过把一个环境下的 YAML 拷贝出来然后对差异的地方进行修改。
概念 kustomization：指的是 kustomization.yaml 文件，或者指的是包含kustomization.yaml 文件的目录以及它里面引用的所有相关文件路径 base：base 指的是一个 kustomization , 任何的 kustomization 包括 overlay，都可以作为另一个 kustomization 的 base (简单理解为基础目录)。base中描述了共享的内容，如资源和常见的资源配置。base 是需要通过 overlay 修订的基础配置 overlay：overlay 是一个 kustomization, 它修改(并因此依赖于)另外一个 kustomization variant：variant 是在集群中将 overlay 应用于 base 的结果。例如开发和生产环境都修改了一些共同 base以创建不同的 variant。这些 variant 使用相同的总体资源，并与简单的方式变化，例如 deployment的副本数、ConfigMap使用的数据源等。简而言之，variant 是含有同一组 base 的不同 resource：resource 是描述 k8s API 对象的 YAML 或 JSON文件的相对路径。即是指向一个声明了 kubernetes API 对象的 YAML 文件 patch：修改文件的一般说明。文件路径，指向一个声明了 kubernetes API patch 的 YAML 文件 安装 go get github."><meta property="og:type" content="article"><meta property="og:url" content="https://moyuduo.github.io/posts/kustomize/"><meta property="og:image" content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-27T16:16:14+08:00"><meta property="article:modified_time" content="2022-11-27T16:16:14+08:00"><meta property="og:site_name" content="Moyuduo's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="kustomize"><meta name=twitter:description content="是什么 kustomize 使用 k8s 原生概念帮助创建并复用资源配置(YAML)，允许用户以一个应用描述文件 （YAML 文件）为基础（Base YAML），然后通过 Overlay 的方式生成最终部署应用所需的描述文件。
可以把kustomize理解为轻量级的helm。
解决什么问题 一般应用都会存在多套部署环境：开发环境、测试环境、生产环境，多套环境意味着存在多套 K8S 应用资源 YAML。而这么多套 YAML 之间只存在微小配置差异，比如镜像版本不同、Label 不同等，而这些不同环境下的YAML 经常会因为人为疏忽导致配置错误。再者，多套环境的 YAML 维护通常是通过把一个环境下的 YAML 拷贝出来然后对差异的地方进行修改。
概念 kustomization：指的是 kustomization.yaml 文件，或者指的是包含kustomization.yaml 文件的目录以及它里面引用的所有相关文件路径 base：base 指的是一个 kustomization , 任何的 kustomization 包括 overlay，都可以作为另一个 kustomization 的 base (简单理解为基础目录)。base中描述了共享的内容，如资源和常见的资源配置。base 是需要通过 overlay 修订的基础配置 overlay：overlay 是一个 kustomization, 它修改(并因此依赖于)另外一个 kustomization variant：variant 是在集群中将 overlay 应用于 base 的结果。例如开发和生产环境都修改了一些共同 base以创建不同的 variant。这些 variant 使用相同的总体资源，并与简单的方式变化，例如 deployment的副本数、ConfigMap使用的数据源等。简而言之，variant 是含有同一组 base 的不同 resource：resource 是描述 k8s API 对象的 YAML 或 JSON文件的相对路径。即是指向一个声明了 kubernetes API 对象的 YAML 文件 patch：修改文件的一般说明。文件路径，指向一个声明了 kubernetes API patch 的 YAML 文件 安装 go get github."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://moyuduo.github.io/posts/"},{"@type":"ListItem","position":2,"name":"kustomize","item":"https://moyuduo.github.io/posts/kustomize/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kustomize","name":"kustomize","description":"是什么 kustomize 使用 k8s 原生概念帮助创建并复用资源配置(YAML)，允许用户以一个应用描述文件 （YAML 文件）为基础（Base YAML），然后通过 Overlay 的方式生成最终部署应用所需的描述文件。\n可以把kustomize理解为轻量级的helm。\n解决什么问题 一般应用都会存在多套部署环境：开发环境、测试环境、生产环境，多套环境意味着存在多套 K8S 应用资源 YAML。而这么多套 YAML 之间只存在微小配置差异，比如镜像版本不同、Label 不同等，而这些不同环境下的YAML 经常会因为人为疏忽导致配置错误。再者，多套环境的 YAML 维护通常是通过把一个环境下的 YAML 拷贝出来然后对差异的地方进行修改。\n概念 kustomization：指的是 kustomization.yaml 文件，或者指的是包含kustomization.yaml 文件的目录以及它里面引用的所有相关文件路径 base：base 指的是一个 kustomization , 任何的 kustomization 包括 overlay，都可以作为另一个 kustomization 的 base (简单理解为基础目录)。base中描述了共享的内容，如资源和常见的资源配置。base 是需要通过 overlay 修订的基础配置 overlay：overlay 是一个 kustomization, 它修改(并因此依赖于)另外一个 kustomization variant：variant 是在集群中将 overlay 应用于 base 的结果。例如开发和生产环境都修改了一些共同 base以创建不同的 variant。这些 variant 使用相同的总体资源，并与简单的方式变化，例如 deployment的副本数、ConfigMap使用的数据源等。简而言之，variant 是含有同一组 base 的不同 resource：resource 是描述 k8s API 对象的 YAML 或 JSON文件的相对路径。即是指向一个声明了 kubernetes API 对象的 YAML 文件 patch：修改文件的一般说明。文件路径，指向一个声明了 kubernetes API patch 的 YAML 文件 安装 go get github.","keywords":[],"articleBody":"是什么 kustomize 使用 k8s 原生概念帮助创建并复用资源配置(YAML)，允许用户以一个应用描述文件 （YAML 文件）为基础（Base YAML），然后通过 Overlay 的方式生成最终部署应用所需的描述文件。\n可以把kustomize理解为轻量级的helm。\n解决什么问题 一般应用都会存在多套部署环境：开发环境、测试环境、生产环境，多套环境意味着存在多套 K8S 应用资源 YAML。而这么多套 YAML 之间只存在微小配置差异，比如镜像版本不同、Label 不同等，而这些不同环境下的YAML 经常会因为人为疏忽导致配置错误。再者，多套环境的 YAML 维护通常是通过把一个环境下的 YAML 拷贝出来然后对差异的地方进行修改。\n概念 kustomization：指的是 kustomization.yaml 文件，或者指的是包含kustomization.yaml 文件的目录以及它里面引用的所有相关文件路径 base：base 指的是一个 kustomization , 任何的 kustomization 包括 overlay，都可以作为另一个 kustomization 的 base (简单理解为基础目录)。base中描述了共享的内容，如资源和常见的资源配置。base 是需要通过 overlay 修订的基础配置 overlay：overlay 是一个 kustomization, 它修改(并因此依赖于)另外一个 kustomization variant：variant 是在集群中将 overlay 应用于 base 的结果。例如开发和生产环境都修改了一些共同 base以创建不同的 variant。这些 variant 使用相同的总体资源，并与简单的方式变化，例如 deployment的副本数、ConfigMap使用的数据源等。简而言之，variant 是含有同一组 base 的不同 resource：resource 是描述 k8s API 对象的 YAML 或 JSON文件的相对路径。即是指向一个声明了 kubernetes API 对象的 YAML 文件 patch：修改文件的一般说明。文件路径，指向一个声明了 kubernetes API patch 的 YAML 文件 安装 go get github.com/kubernetes-sigs/kustomize 使用 创建一个目录 mkdir kustomize_test 在这个目录下创建base文件夹，并在该文件夹下创建资源 cd kustomize_test mkdir base cd base cat \u003c\u003c EOF \u003e configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: the-map data: altGreeting: \"Good Morning!\" enableRisky: \"false\" EOF cat \u003c\u003c EOF \u003e service.yaml kind: Service apiVersion: v1 metadata: name: the-service spec: selector: deployment: hello type: LoadBalancer ports: - protocol: TCP port: 8666 targetPort: 8080 EOF cat \u003c\u003c EOF \u003e deploy.yaml apiVersion: apps/v1 kind: Deployment metadata: name: the-deployment spec: replicas: 3 selector: matchLabels: deployment: hello template: metadata: labels: deployment: hello spec: containers: - name: the-container image: monopole/hello:1 command: [\"/hello\", \"--port=8080\", \"--enableRiskyFeature=$(ENABLE_RISKY)\"] ports: - containerPort: 8080 env: - name: ALT_GREETING valueFrom: configMapKeyRef: name: the-map key: altGreeting - name: ENABLE_RISKY valueFrom: configMapKeyRef: name: the-map key: enableRisky EOF 在base文件夹下创建kustomization文件 cat \u003c\u003c EOF \u003e kustomization.yaml apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization metadata: name: arbitrary # Example configuration for the webserver # at https://github.com/monopole/hello commonLabels: app: hello resources: - configmap.yaml - service.yaml - deploy.yaml EOF 在base文件夹下执行kustomize build .,输出的所有资源都被加上了label kustomize build . apiVersion: v1 data: altGreeting: Good Morning! enableRisky: \"false\" kind: ConfigMap metadata: labels: app: hello name: the-map --- apiVersion: v1 kind: Service metadata: labels: app: hello name: the-service spec: ports: - port: 8666 protocol: TCP targetPort: 8080 selector: app: hello deployment: hello type: LoadBalancer --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: hello name: the-deployment spec: replicas: 3 selector: matchLabels: app: hello deployment: hello template: metadata: labels: app: hello deployment: hello spec: containers: - command: - /hello - --port=8080 - --enableRiskyFeature=$(ENABLE_RISKY) env: - name: ALT_GREETING valueFrom: configMapKeyRef: key: altGreeting name: the-map - name: ENABLE_RISKY valueFrom: configMapKeyRef: key: enableRisky name: the-map image: monopole/hello:1 name: the-container ports: - containerPort: 8080 在kustomize_test目录下创建overlay目录 mkdir overlay cd overlay 在overlay目录下创建staging目录，并在目录下创建kustomization文件 mkdir staging cd staging cat \u003c\u003c EOF \u003e kustomization.yaml namePrefix: staging- commonLabels: variant: staging org: acmeCorporation commonAnnotations: note: Hello, I am staging! resources: - ../../base patchesStrategicMerge: - map.yaml EOF 在staging目录下创建map.yaml文件 cat \u003c\u003c EOF \u003e map.yaml apiVersion: v1 kind: ConfigMap metadata: name: the-map data: altGreeting: \"Have a pineapple!\" enableRisky: \"true\" EOF 在staging环境下执行kustomize build .,输出的配置文件中configmap已经在base目录下执行kustomize build .的基础上加上了staging环境的label、annotation和更新data kustomize build . apiVersion: v1 data: altGreeting: Have a pineapple! enableRisky: \"true\" kind: ConfigMap metadata: annotations: note: Hello, I am staging! labels: app: hello org: acmeCorporation variant: staging name: staging-the-map --- apiVersion: v1 kind: Service metadata: annotations: note: Hello, I am staging! labels: app: hello org: acmeCorporation variant: staging name: staging-the-service spec: ports: - port: 8666 protocol: TCP targetPort: 8080 selector: app: hello deployment: hello org: acmeCorporation variant: staging type: LoadBalancer --- apiVersion: apps/v1 kind: Deployment metadata: annotations: note: Hello, I am staging! labels: app: hello org: acmeCorporation variant: staging name: staging-the-deployment spec: replicas: 3 selector: matchLabels: app: hello deployment: hello org: acmeCorporation variant: staging template: metadata: annotations: note: Hello, I am staging! labels: app: hello deployment: hello org: acmeCorporation variant: staging spec: containers: - command: - /hello - --port=8080 - --enableRiskyFeature=$(ENABLE_RISKY) env: - name: ALT_GREETING valueFrom: configMapKeyRef: key: altGreeting name: staging-the-map - name: ENABLE_RISKY valueFrom: configMapKeyRef: key: enableRisky name: staging-the-map image: monopole/hello:1 name: the-container ports: - containerPort: 8080 在staging目录下新建prod目录，并在目录下创建kustomization文件 mkdir prod cd prod cat \u003c\u003c EOF \u003e kustomization.yaml namePrefix: production- commonLabels: variant: production org: acmeCorporation commonAnnotations: note: Hello, I am production! resources: - ../../base patchesStrategicMerge: - deploy.yaml EOF 在prod目录下创建deploy文件 cat \u003c\u003c EOF \u003e deploy.yaml apiVersion: apps/v1 kind: Deployment metadata: name: the-deployment spec: replicas: 10 EOF 在prod目录下执行kustomize build .,输入的配置文件中相较于在base文件夹下执行kustomize build .加上了label、annotation、replicas也改为了10 kustomize build . apiVersion: v1 data: altGreeting: Good Morning! enableRisky: \"false\" kind: ConfigMap metadata: annotations: note: Hello, I am production! labels: app: hello org: acmeCorporation variant: production name: production-the-map --- apiVersion: v1 kind: Service metadata: annotations: note: Hello, I am production! labels: app: hello org: acmeCorporation variant: production name: production-the-service spec: ports: - port: 8666 protocol: TCP targetPort: 8080 selector: app: hello deployment: hello org: acmeCorporation variant: production type: LoadBalancer --- apiVersion: apps/v1 kind: Deployment metadata: annotations: note: Hello, I am production! labels: app: hello org: acmeCorporation variant: production name: production-the-deployment spec: replicas: 10 selector: matchLabels: app: hello deployment: hello org: acmeCorporation variant: production template: metadata: annotations: note: Hello, I am production! labels: app: hello deployment: hello org: acmeCorporation variant: production spec: containers: - command: - /hello - --port=8080 - --enableRiskyFeature=$(ENABLE_RISKY) env: - name: ALT_GREETING valueFrom: configMapKeyRef: key: altGreeting name: production-the-map - name: ENABLE_RISKY valueFrom: configMapKeyRef: key: enableRisky name: production-the-map image: monopole/hello:1 name: the-container ports: - containerPort: 8080 generatorOptions Kustomize 提供了修改 ConfigMapGenerator 和 SecretGenerator 行为的选项\n这些选项的功能包括：\n不再将基于内容生成的哈希后缀添加到资源名称后 为生成的资源添加 labels 为生成的资源添加 annotations kustomization配置文件：\nnamePrefix: production- nameSuffix: -v1 commonLabels: variant: production org: acmeCorporation commonAnnotations: note: Hello, I am production! generatorOptions: disableNameSuffixHash: true #关闭哈希后缀 labels: kustomize.generated.resource: somevalue annotations: annotations.only.for.generated: othervalue configMapGenerator: - name: my-configmap literals:\t- foo=bar - baz=qux 变量 变量的查找和替换并不适用于任意字段，默认仅适用于容器的 env， args和 command\n修改base目录下的deploy.yaml文件 command: [\"/hello\", \"--port=8080\", \"--enableRiskyFeature=$(ENABLE_RISKY)\"] =\u003e command: [\"/hello\", \"--port=$(HELLO_PORT)\", \"--enableRiskyFeature=$(ENABLE_RISKY)\"] 修改staging目录下的kustomization.yaml cat \u003c\u003c EOF \u003e\u003e kustomization.yaml vars: - name: HELLO_PORT objref: apiVersion: v1 kind: Service name: the-service fieldref: fieldpath: spec.ports[0].port EOF 在staging目录下执行kustomize build .,HELLO_PORT变量已经被替换 kustomize build . ... - command: - /hello - --port=8666 - --enableRiskyFeature=$(ENABLE_RISKY) ... 替换镜像 进入prod目录执行kustomize edit set image monopole/hello:1=alpine:3.6 #kustomization.yaml文件追加了一下内容 apiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization images: - name: monopole/hello:1 newName: alpine newTag: \"3.6\" 在该目录下执行kustomize build .,会发现该镜像都被替换成了指定的镜像 image: alpine:3.6 name: the-container patches 格式：\npatches: - path: target: group: version: kind: name: namespace: labelSelector: annotationSelector: 示例:\napiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization patches: - path: patch.yaml target: group: apps version: v1 kind: Deployment name: deploy.* labelSelector: \"env=dev\" annotationSelector: \"zone=west\" - patch: |- - op: replace path: /some/existing/path value: new value target: kind: MyKind labelSelector: \"env=dev\" 修改staging目录下的kustomiztion.yaml文件 cat \u003c\u003c EOF \u003e patch.yaml apiVersion: apps/v1 kind: Deployment metadata: name: the-deployment spec: template: spec: containers: - name: the-container image: prod/hello:1 EOF cat \u003c\u003c EOF \u003e\u003e kustomization.yaml patches: - path: patch.yaml target: group: apps version: v1 kind: Deployment name: the-deployment - patch: |- - op: replace path: /spec/template/spec/containers/0/ports/0/containerPort value: 9090 target: kind: Deployment name: the-deployment EOF 在staging目录下执行kustomize build .,可以看到image和containerPort都已经被替换了 ... spec: containers: - command: - /hello - --port=8666 - --enableRiskyFeature=$(ENABLE_RISKY) env: - name: ALT_GREETING valueFrom: configMapKeyRef: key: altGreeting name: staging-the-map - name: ENABLE_RISKY valueFrom: configMapKeyRef: key: enableRisky name: staging-the-map image: prod/hello:1 name: the-container ports: - containerPort: 9090 ... namespace 为所有资源添加namespace\n修改staging目录下的kustomization.yaml cat \u003c\u003c EOF \u003e\u003e kustomization.yaml namesapce: staging EOF 在staging目录下执行kustomize build .,可以看到所有资源的namespace都被改为了staging kustomize build . ... name: staging-the-service namespace: staging ... 修改prod目录下的kustomization.yaml cat \u003c\u003c EOF \u003e\u003e kustomization.yaml namespace: prod EOF 在prod目录下执行kustomize build .,可以发现所有资源的namespace都被改为了prod kustomize build . ... name: production-the-service-v1 namespace: prod ... replicas 修改所有资源的副本\n在prod目录下修改kustomization.yaml文件 cat \u003c\u003c EOF \u003e\u003e kustomization.yaml replicas: - name: the-deployment count: 50 EOF 在prod目录下执行kustomize build .,可以看到deployment的replicas已经被改为50 kustomize build . ... spec: replicas: 50 selector: matchLabels: ... ","wordCount":"1135","inLanguage":"en","datePublished":"2022-11-27T16:16:14+08:00","dateModified":"2022-11-27T16:16:14+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moyuduo.github.io/posts/kustomize/"},"publisher":{"@type":"Organization","name":"Moyuduo's Blog","logo":{"@type":"ImageObject","url":"https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://moyuduo.github.io/ accesskey=h title="Moyuduo's Blog (Alt + H)"><img src=https://moyuduo.github.io/apple-touch-icon.png alt aria-label=logo height=35>Moyuduo's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://moyuduo.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://moyuduo.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://moyuduo.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://moyuduo.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>kustomize</h1></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#generatoroptions>generatorOptions</a></li><li><a href=#变量>变量</a></li><li><a href=#替换镜像>替换镜像</a></li><li><a href=#patches>patches</a></li><li><a href=#namespace>namespace</a></li><li><a href=#replicas>replicas</a></li></ul></nav></div></details></div><div class=post-content><h1 id=是什么>是什么<a hidden class=anchor aria-hidden=true href=#是什么>#</a></h1><p>kustomize 使用 k8s 原生概念帮助创建并复用资源配置(YAML)，允许用户以一个应用描述文件 （YAML 文件）为基础（Base YAML），然后通过 Overlay 的方式生成最终部署应用所需的描述文件。</p><p>可以把kustomize理解为轻量级的helm。</p><h1 id=解决什么问题>解决什么问题<a hidden class=anchor aria-hidden=true href=#解决什么问题>#</a></h1><p>一般应用都会存在多套部署环境：开发环境、测试环境、生产环境，多套环境意味着存在多套 K8S 应用资源 YAML。而这么多套 YAML 之间只存在微小配置差异，比如镜像版本不同、Label 不同等，而这些不同环境下的YAML 经常会因为人为疏忽导致配置错误。再者，多套环境的 YAML 维护通常是通过把一个环境下的 YAML 拷贝出来然后对差异的地方进行修改。</p><h1 id=概念>概念<a hidden class=anchor aria-hidden=true href=#概念>#</a></h1><ol><li>kustomization：指的是 kustomization.yaml 文件，或者指的是包含kustomization.yaml 文件的目录以及它里面引用的所有相关文件路径</li><li>base：base 指的是一个 kustomization , 任何的 kustomization 包括 overlay，都可以作为另一个 kustomization 的 base (简单理解为基础目录)。base中描述了共享的内容，如资源和常见的资源配置。base 是需要通过 overlay 修订的基础配置</li><li>overlay：overlay 是一个 kustomization, 它修改(并因此依赖于)另外一个 kustomization</li><li>variant：variant 是在集群中将 overlay 应用于 base 的结果。例如开发和生产环境都修改了一些共同 base以创建不同的 variant。这些 variant 使用相同的总体资源，并与简单的方式变化，例如 deployment的副本数、ConfigMap使用的数据源等。简而言之，variant 是含有同一组 base 的不同</li><li>resource：resource 是描述 k8s API 对象的 YAML 或 JSON文件的相对路径。即是指向一个声明了 kubernetes API 对象的 YAML 文件</li><li>patch：修改文件的一般说明。文件路径，指向一个声明了 kubernetes API patch 的 YAML 文件</li></ol><h1 id=安装>安装<a hidden class=anchor aria-hidden=true href=#安装>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go get github.com/kubernetes-sigs/kustomize
</span></span></code></pre></div><h1 id=使用>使用<a hidden class=anchor aria-hidden=true href=#使用>#</a></h1><ol><li>创建一个目录</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir kustomize_test
</span></span></code></pre></div><ol start=2><li>在这个目录下创建base文件夹，并在该文件夹下创建资源</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> kustomize_test
</span></span><span class=line><span class=cl>mkdir base
</span></span><span class=line><span class=cl><span class=nb>cd</span> base
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; configmap.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ConfigMap
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: the-map
</span></span></span><span class=line><span class=cl><span class=s>data:
</span></span></span><span class=line><span class=cl><span class=s>  altGreeting: &#34;Good Morning!&#34;
</span></span></span><span class=line><span class=cl><span class=s>  enableRisky: &#34;false&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; service.yaml
</span></span></span><span class=line><span class=cl><span class=s>kind: Service
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: the-service
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    deployment: hello
</span></span></span><span class=line><span class=cl><span class=s>  type: LoadBalancer
</span></span></span><span class=line><span class=cl><span class=s>  ports:
</span></span></span><span class=line><span class=cl><span class=s>  - protocol: TCP
</span></span></span><span class=line><span class=cl><span class=s>    port: 8666
</span></span></span><span class=line><span class=cl><span class=s>    targetPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; deploy.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: the-deployment
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 3
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      deployment: hello
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        deployment: hello
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: the-container
</span></span></span><span class=line><span class=cl><span class=s>        image: monopole/hello:1
</span></span></span><span class=line><span class=cl><span class=s>        command: [&#34;/hello&#34;,
</span></span></span><span class=line><span class=cl><span class=s>                  &#34;--port=8080&#34;,
</span></span></span><span class=line><span class=cl><span class=s>                  &#34;--enableRiskyFeature=$(ENABLE_RISKY)&#34;]
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>        env:
</span></span></span><span class=line><span class=cl><span class=s>        - name: ALT_GREETING
</span></span></span><span class=line><span class=cl><span class=s>          valueFrom:
</span></span></span><span class=line><span class=cl><span class=s>            configMapKeyRef:
</span></span></span><span class=line><span class=cl><span class=s>              name: the-map
</span></span></span><span class=line><span class=cl><span class=s>              key: altGreeting
</span></span></span><span class=line><span class=cl><span class=s>        - name: ENABLE_RISKY
</span></span></span><span class=line><span class=cl><span class=s>          valueFrom:
</span></span></span><span class=line><span class=cl><span class=s>            configMapKeyRef:
</span></span></span><span class=line><span class=cl><span class=s>              name: the-map
</span></span></span><span class=line><span class=cl><span class=s>              key: enableRisky
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=3><li>在base文件夹下创建kustomization文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: kustomize.config.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: Kustomization
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: arbitrary
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Example configuration for the webserver
</span></span></span><span class=line><span class=cl><span class=s># at https://github.com/monopole/hello
</span></span></span><span class=line><span class=cl><span class=s>commonLabels:
</span></span></span><span class=line><span class=cl><span class=s>  app: hello
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- configmap.yaml
</span></span></span><span class=line><span class=cl><span class=s>- service.yaml
</span></span></span><span class=line><span class=cl><span class=s>- deploy.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=4><li>在base文件夹下执行<code>kustomize build .</code>,输出的所有资源都被加上了label</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kustomize build .
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  altGreeting: Good Morning!
</span></span><span class=line><span class=cl>  enableRisky: <span class=s2>&#34;false&#34;</span>
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>  name: the-map
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: Service
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>  name: the-service
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  ports:
</span></span><span class=line><span class=cl>  - port: <span class=m>8666</span>
</span></span><span class=line><span class=cl>    protocol: TCP
</span></span><span class=line><span class=cl>    targetPort: <span class=m>8080</span>
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    deployment: hello
</span></span><span class=line><span class=cl>  type: LoadBalancer
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: apps/v1
</span></span><span class=line><span class=cl>kind: Deployment
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>  name: the-deployment
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  replicas: <span class=m>3</span>
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    matchLabels:
</span></span><span class=line><span class=cl>      app: hello
</span></span><span class=line><span class=cl>      deployment: hello
</span></span><span class=line><span class=cl>  template:
</span></span><span class=line><span class=cl>    metadata:
</span></span><span class=line><span class=cl>      labels:
</span></span><span class=line><span class=cl>        app: hello
</span></span><span class=line><span class=cl>        deployment: hello
</span></span><span class=line><span class=cl>    spec:
</span></span><span class=line><span class=cl>      containers:
</span></span><span class=line><span class=cl>      - command:
</span></span><span class=line><span class=cl>        - /hello
</span></span><span class=line><span class=cl>        - --port<span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl>        - --enableRiskyFeature<span class=o>=</span><span class=k>$(</span>ENABLE_RISKY<span class=k>)</span>
</span></span><span class=line><span class=cl>        env:
</span></span><span class=line><span class=cl>        - name: ALT_GREETING
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: altGreeting
</span></span><span class=line><span class=cl>              name: the-map
</span></span><span class=line><span class=cl>        - name: ENABLE_RISKY
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: enableRisky
</span></span><span class=line><span class=cl>              name: the-map
</span></span><span class=line><span class=cl>        image: monopole/hello:1
</span></span><span class=line><span class=cl>        name: the-container
</span></span><span class=line><span class=cl>        ports:
</span></span><span class=line><span class=cl>        - containerPort: <span class=m>8080</span>
</span></span></code></pre></div><ol start=5><li>在kustomize_test目录下创建overlay目录</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir overlay
</span></span><span class=line><span class=cl><span class=nb>cd</span> overlay
</span></span></code></pre></div><ol start=6><li>在overlay目录下创建staging目录，并在目录下创建kustomization文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir staging
</span></span><span class=line><span class=cl><span class=nb>cd</span> staging
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>namePrefix: staging-
</span></span></span><span class=line><span class=cl><span class=s>commonLabels:
</span></span></span><span class=line><span class=cl><span class=s>  variant: staging
</span></span></span><span class=line><span class=cl><span class=s>  org: acmeCorporation
</span></span></span><span class=line><span class=cl><span class=s>commonAnnotations:
</span></span></span><span class=line><span class=cl><span class=s>  note: Hello, I am staging!
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- ../../base
</span></span></span><span class=line><span class=cl><span class=s>patchesStrategicMerge:
</span></span></span><span class=line><span class=cl><span class=s>- map.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=7><li>在staging目录下创建map.yaml文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; map.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: ConfigMap
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: the-map
</span></span></span><span class=line><span class=cl><span class=s>data:
</span></span></span><span class=line><span class=cl><span class=s>  altGreeting: &#34;Have a pineapple!&#34;
</span></span></span><span class=line><span class=cl><span class=s>  enableRisky: &#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=8><li>在staging环境下执行<code>kustomize build .</code>,输出的配置文件中configmap已经在base目录下执行<code>kustomize build .</code>的基础上加上了staging环境的label、annotation和更新data</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kustomize build .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  altGreeting: Have a pineapple!
</span></span><span class=line><span class=cl>  enableRisky: <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    note: Hello, I am staging!
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: staging
</span></span><span class=line><span class=cl>  name: staging-the-map
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: Service
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    note: Hello, I am staging!
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: staging
</span></span><span class=line><span class=cl>  name: staging-the-service
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  ports:
</span></span><span class=line><span class=cl>  - port: <span class=m>8666</span>
</span></span><span class=line><span class=cl>    protocol: TCP
</span></span><span class=line><span class=cl>    targetPort: <span class=m>8080</span>
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    deployment: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: staging
</span></span><span class=line><span class=cl>  type: LoadBalancer
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: apps/v1
</span></span><span class=line><span class=cl>kind: Deployment
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    note: Hello, I am staging!
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: staging
</span></span><span class=line><span class=cl>  name: staging-the-deployment
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  replicas: <span class=m>3</span>
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    matchLabels:
</span></span><span class=line><span class=cl>      app: hello
</span></span><span class=line><span class=cl>      deployment: hello
</span></span><span class=line><span class=cl>      org: acmeCorporation
</span></span><span class=line><span class=cl>      variant: staging
</span></span><span class=line><span class=cl>  template:
</span></span><span class=line><span class=cl>    metadata:
</span></span><span class=line><span class=cl>      annotations:
</span></span><span class=line><span class=cl>        note: Hello, I am staging!
</span></span><span class=line><span class=cl>      labels:
</span></span><span class=line><span class=cl>        app: hello
</span></span><span class=line><span class=cl>        deployment: hello
</span></span><span class=line><span class=cl>        org: acmeCorporation
</span></span><span class=line><span class=cl>        variant: staging
</span></span><span class=line><span class=cl>    spec:
</span></span><span class=line><span class=cl>      containers:
</span></span><span class=line><span class=cl>      - command:
</span></span><span class=line><span class=cl>        - /hello
</span></span><span class=line><span class=cl>        - --port<span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl>        - --enableRiskyFeature<span class=o>=</span><span class=k>$(</span>ENABLE_RISKY<span class=k>)</span>
</span></span><span class=line><span class=cl>        env:
</span></span><span class=line><span class=cl>        - name: ALT_GREETING
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: altGreeting
</span></span><span class=line><span class=cl>              name: staging-the-map
</span></span><span class=line><span class=cl>        - name: ENABLE_RISKY
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: enableRisky
</span></span><span class=line><span class=cl>              name: staging-the-map
</span></span><span class=line><span class=cl>        image: monopole/hello:1
</span></span><span class=line><span class=cl>        name: the-container
</span></span><span class=line><span class=cl>        ports:
</span></span><span class=line><span class=cl>        - containerPort: <span class=m>8080</span>
</span></span></code></pre></div><ol start=9><li>在staging目录下新建prod目录，并在目录下创建kustomization文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir prod
</span></span><span class=line><span class=cl><span class=nb>cd</span> prod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>namePrefix: production-
</span></span></span><span class=line><span class=cl><span class=s>commonLabels:
</span></span></span><span class=line><span class=cl><span class=s>  variant: production
</span></span></span><span class=line><span class=cl><span class=s>  org: acmeCorporation
</span></span></span><span class=line><span class=cl><span class=s>commonAnnotations:
</span></span></span><span class=line><span class=cl><span class=s>  note: Hello, I am production!
</span></span></span><span class=line><span class=cl><span class=s>resources:
</span></span></span><span class=line><span class=cl><span class=s>- ../../base
</span></span></span><span class=line><span class=cl><span class=s>patchesStrategicMerge:
</span></span></span><span class=line><span class=cl><span class=s>- deploy.yaml
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=10><li>在prod目录下创建deploy文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; deploy.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: the-deployment
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 10
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=11><li>在prod目录下执行<code>kustomize build .</code>,输入的配置文件中相较于在base文件夹下执行<code>kustomize build .</code>加上了label、annotation、replicas也改为了10</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kustomize build .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  altGreeting: Good Morning!
</span></span><span class=line><span class=cl>  enableRisky: <span class=s2>&#34;false&#34;</span>
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    note: Hello, I am production!
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: production
</span></span><span class=line><span class=cl>  name: production-the-map
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: Service
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    note: Hello, I am production!
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: production
</span></span><span class=line><span class=cl>  name: production-the-service
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  ports:
</span></span><span class=line><span class=cl>  - port: <span class=m>8666</span>
</span></span><span class=line><span class=cl>    protocol: TCP
</span></span><span class=line><span class=cl>    targetPort: <span class=m>8080</span>
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    deployment: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: production
</span></span><span class=line><span class=cl>  type: LoadBalancer
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>apiVersion: apps/v1
</span></span><span class=line><span class=cl>kind: Deployment
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    note: Hello, I am production!
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: hello
</span></span><span class=line><span class=cl>    org: acmeCorporation
</span></span><span class=line><span class=cl>    variant: production
</span></span><span class=line><span class=cl>  name: production-the-deployment
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  replicas: <span class=m>10</span>
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    matchLabels:
</span></span><span class=line><span class=cl>      app: hello
</span></span><span class=line><span class=cl>      deployment: hello
</span></span><span class=line><span class=cl>      org: acmeCorporation
</span></span><span class=line><span class=cl>      variant: production
</span></span><span class=line><span class=cl>  template:
</span></span><span class=line><span class=cl>    metadata:
</span></span><span class=line><span class=cl>      annotations:
</span></span><span class=line><span class=cl>        note: Hello, I am production!
</span></span><span class=line><span class=cl>      labels:
</span></span><span class=line><span class=cl>        app: hello
</span></span><span class=line><span class=cl>        deployment: hello
</span></span><span class=line><span class=cl>        org: acmeCorporation
</span></span><span class=line><span class=cl>        variant: production
</span></span><span class=line><span class=cl>    spec:
</span></span><span class=line><span class=cl>      containers:
</span></span><span class=line><span class=cl>      - command:
</span></span><span class=line><span class=cl>        - /hello
</span></span><span class=line><span class=cl>        - --port<span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl>        - --enableRiskyFeature<span class=o>=</span><span class=k>$(</span>ENABLE_RISKY<span class=k>)</span>
</span></span><span class=line><span class=cl>        env:
</span></span><span class=line><span class=cl>        - name: ALT_GREETING
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: altGreeting
</span></span><span class=line><span class=cl>              name: production-the-map
</span></span><span class=line><span class=cl>        - name: ENABLE_RISKY
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: enableRisky
</span></span><span class=line><span class=cl>              name: production-the-map
</span></span><span class=line><span class=cl>        image: monopole/hello:1
</span></span><span class=line><span class=cl>        name: the-container
</span></span><span class=line><span class=cl>        ports:
</span></span><span class=line><span class=cl>        - containerPort: <span class=m>8080</span>
</span></span></code></pre></div><h2 id=generatoroptions>generatorOptions<a hidden class=anchor aria-hidden=true href=#generatoroptions>#</a></h2><p>Kustomize 提供了修改 ConfigMapGenerator 和 SecretGenerator 行为的选项</p><p>这些选项的功能包括：</p><ol><li>不再将基于内容生成的哈希后缀添加到资源名称后</li><li>为生成的资源添加 labels</li><li>为生成的资源添加 annotations</li></ol><p>kustomization配置文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>namePrefix: production-
</span></span><span class=line><span class=cl>nameSuffix: -v1
</span></span><span class=line><span class=cl>commonLabels:
</span></span><span class=line><span class=cl>  variant: production
</span></span><span class=line><span class=cl>  org: acmeCorporation
</span></span><span class=line><span class=cl>commonAnnotations:
</span></span><span class=line><span class=cl>  note: Hello, I am production!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>generatorOptions:
</span></span><span class=line><span class=cl> disableNameSuffixHash: <span class=nb>true</span>  <span class=c1>#关闭哈希后缀</span>
</span></span><span class=line><span class=cl> labels:
</span></span><span class=line><span class=cl>   kustomize.generated.resource: somevalue
</span></span><span class=line><span class=cl> annotations:
</span></span><span class=line><span class=cl>   annotations.only.for.generated: othervalue
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>configMapGenerator:
</span></span><span class=line><span class=cl>- name: my-configmap
</span></span><span class=line><span class=cl>  literals:	
</span></span><span class=line><span class=cl>  - <span class=nv>foo</span><span class=o>=</span>bar
</span></span><span class=line><span class=cl>  - <span class=nv>baz</span><span class=o>=</span>qux
</span></span></code></pre></div><h2 id=变量>变量<a hidden class=anchor aria-hidden=true href=#变量>#</a></h2><p>变量的查找和替换并不适用于任意字段，默认仅适用于容器的 env， args和 command</p><ol><li>修改base目录下的deploy.yaml文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>command: <span class=o>[</span><span class=s2>&#34;/hello&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;--port=8080&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;--enableRiskyFeature=</span><span class=k>$(</span>ENABLE_RISKY<span class=k>)</span><span class=s2>&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>=</span>&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>command: <span class=o>[</span><span class=s2>&#34;/hello&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;--port=</span><span class=k>$(</span>HELLO_PORT<span class=k>)</span><span class=s2>&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;--enableRiskyFeature=</span><span class=k>$(</span>ENABLE_RISKY<span class=k>)</span><span class=s2>&#34;</span><span class=o>]</span>
</span></span></code></pre></div><ol start=2><li>修改staging目录下的kustomization.yaml</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt;&gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>vars:
</span></span></span><span class=line><span class=cl><span class=s>- name: HELLO_PORT
</span></span></span><span class=line><span class=cl><span class=s>  objref:
</span></span></span><span class=line><span class=cl><span class=s>    apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>    kind: Service
</span></span></span><span class=line><span class=cl><span class=s>    name: the-service
</span></span></span><span class=line><span class=cl><span class=s>  fieldref:
</span></span></span><span class=line><span class=cl><span class=s>    fieldpath: spec.ports[0].port
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=3><li>在staging目录下执行<code>kustomize build .</code>,HELLO_PORT变量已经被替换</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kustomize build .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>- command:
</span></span><span class=line><span class=cl>    - /hello
</span></span><span class=line><span class=cl>    - --port<span class=o>=</span><span class=m>8666</span>
</span></span><span class=line><span class=cl>    - --enableRiskyFeature<span class=o>=</span><span class=k>$(</span>ENABLE_RISKY<span class=k>)</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h2 id=替换镜像>替换镜像<a hidden class=anchor aria-hidden=true href=#替换镜像>#</a></h2><ol><li>进入prod目录执行<code>kustomize edit set image monopole/hello:1=alpine:3.6</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>#kustomization.yaml文件追加了一下内容</span>
</span></span><span class=line><span class=cl>apiVersion: kustomize.config.k8s.io/v1beta1
</span></span><span class=line><span class=cl>kind: Kustomization
</span></span><span class=line><span class=cl>images:
</span></span><span class=line><span class=cl>- name: monopole/hello:1
</span></span><span class=line><span class=cl>  newName: alpine
</span></span><span class=line><span class=cl>  newTag: <span class=s2>&#34;3.6&#34;</span>
</span></span></code></pre></div><ol start=2><li>在该目录下执行<code>kustomize build .</code>,会发现该镜像都被替换成了指定的镜像</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl> image: alpine:3.6
</span></span><span class=line><span class=cl>        name: the-container
</span></span></code></pre></div><h2 id=patches>patches<a hidden class=anchor aria-hidden=true href=#patches>#</a></h2><p>格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>patches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>&lt;PatchFile&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Group&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Version&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Kind&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Name&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>&lt;Namespace&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=l>&lt;LabelSelector&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotationSelector</span><span class=p>:</span><span class=w> </span><span class=l>&lt;AnnotationSelector&gt;</span><span class=w>
</span></span></span></code></pre></div><p>示例:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>patches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>patch.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>apps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>deploy.*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;env=dev&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>annotationSelector</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;zone=west&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>patch</span><span class=p>:</span><span class=w> </span><span class=p>|-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    - op: replace
</span></span></span><span class=line><span class=cl><span class=sd>      path: /some/existing/path
</span></span></span><span class=line><span class=cl><span class=sd>      value: new value</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>MyKind</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;env=dev&#34;</span><span class=w>
</span></span></span></code></pre></div><ol><li>修改staging目录下的kustomiztion.yaml文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt; patch.yaml
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: the-deployment
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>        - name: the-container
</span></span></span><span class=line><span class=cl><span class=s>          image: prod/hello:1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt;&gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>patches:
</span></span></span><span class=line><span class=cl><span class=s>- path: patch.yaml
</span></span></span><span class=line><span class=cl><span class=s>  target:
</span></span></span><span class=line><span class=cl><span class=s>    group: apps
</span></span></span><span class=line><span class=cl><span class=s>    version: v1
</span></span></span><span class=line><span class=cl><span class=s>    kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>    name: the-deployment
</span></span></span><span class=line><span class=cl><span class=s>- patch: |-
</span></span></span><span class=line><span class=cl><span class=s>    - op: replace
</span></span></span><span class=line><span class=cl><span class=s>      path: /spec/template/spec/containers/0/ports/0/containerPort
</span></span></span><span class=line><span class=cl><span class=s>      value: 9090
</span></span></span><span class=line><span class=cl><span class=s>  target:
</span></span></span><span class=line><span class=cl><span class=s>    kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>    name: the-deployment
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=2><li>在staging目录下执行<code>kustomize build .</code>,可以看到image和containerPort都已经被替换了</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>      containers:
</span></span><span class=line><span class=cl>      - command:
</span></span><span class=line><span class=cl>        - /hello
</span></span><span class=line><span class=cl>        - --port<span class=o>=</span><span class=m>8666</span>
</span></span><span class=line><span class=cl>        - --enableRiskyFeature<span class=o>=</span><span class=k>$(</span>ENABLE_RISKY<span class=k>)</span>
</span></span><span class=line><span class=cl>        env:
</span></span><span class=line><span class=cl>        - name: ALT_GREETING
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: altGreeting
</span></span><span class=line><span class=cl>              name: staging-the-map
</span></span><span class=line><span class=cl>        - name: ENABLE_RISKY
</span></span><span class=line><span class=cl>          valueFrom:
</span></span><span class=line><span class=cl>            configMapKeyRef:
</span></span><span class=line><span class=cl>              key: enableRisky
</span></span><span class=line><span class=cl>              name: staging-the-map
</span></span><span class=line><span class=cl>        image: prod/hello:1
</span></span><span class=line><span class=cl>        name: the-container
</span></span><span class=line><span class=cl>        ports:
</span></span><span class=line><span class=cl>        - containerPort: <span class=m>9090</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h2 id=namespace>namespace<a hidden class=anchor aria-hidden=true href=#namespace>#</a></h2><p>为所有资源添加namespace</p><ol><li>修改staging目录下的kustomization.yaml</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt;&gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>namesapce: staging
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=2><li>在staging目录下执行<code>kustomize build .</code>,可以看到所有资源的namespace都被改为了staging</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kustomize build .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>  name: staging-the-service
</span></span><span class=line><span class=cl>  namespace: staging
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><ol start=3><li>修改prod目录下的kustomization.yaml</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt;&gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>namespace: prod
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=4><li>在prod目录下执行<code>kustomize build .</code>,可以发现所有资源的namespace都被改为了prod</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kustomize build .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>  name: production-the-service-v1
</span></span><span class=line><span class=cl>  namespace: prod
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h2 id=replicas>replicas<a hidden class=anchor aria-hidden=true href=#replicas>#</a></h2><p>修改所有资源的副本</p><ol><li>在prod目录下修改kustomization.yaml文件</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF &gt;&gt; kustomization.yaml
</span></span></span><span class=line><span class=cl><span class=s>replicas: 
</span></span></span><span class=line><span class=cl><span class=s>- name: the-deployment
</span></span></span><span class=line><span class=cl><span class=s>  count: 50
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><ol start=2><li>在prod目录下执行<code>kustomize build .</code>,可以看到deployment的replicas已经被改为50</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kustomize build .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  replicas: <span class=m>50</span>
</span></span><span class=line><span class=cl>  selector:
</span></span><span class=line><span class=cl>    matchLabels:
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://moyuduo.github.io/>Moyuduo's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>