<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>helm | Moyuduo's Blog</title><meta name=keywords content><meta name=description content="概念 chart: 包含创建 kubernetes 应用实例的必要信息 config: 包含应用发布配置信息 release: 是 chart 及其配置的一个运行实例 command repo chart 对应的是一个应用实例的信息，而要安装一个 chart 可以从多个仓库进行安装，repo 提供对仓库的增删
# 在 https://artifacthub.io/ 上查询要安装的应用有哪些提供安装的 repo helm repo add bitnami https://charts.bitnami.com/bitnami &#34;bitnami&#34; has been added to your repositories helm repo list NAME URL bitnami	https://charts.bitnami.com/bitnami # 确定我们可以拿到最新的charts列表 helm repo update # TODO helm repo remove search 从仓库中查找 chart,提供从两种来源查找 chart: 1.https://artifacthub.io/ 使用 helm search hub 命令来进行查找，2.使用 helm repo add 添加的仓库，使用 helm search repo {repo_name}"><meta name=author content="Me"><link rel=canonical href=https://moyuduo.github.io/posts/helm/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="helm"><meta property="og:description" content="概念 chart: 包含创建 kubernetes 应用实例的必要信息 config: 包含应用发布配置信息 release: 是 chart 及其配置的一个运行实例 command repo chart 对应的是一个应用实例的信息，而要安装一个 chart 可以从多个仓库进行安装，repo 提供对仓库的增删
# 在 https://artifacthub.io/ 上查询要安装的应用有哪些提供安装的 repo helm repo add bitnami https://charts.bitnami.com/bitnami &#34;bitnami&#34; has been added to your repositories helm repo list NAME URL bitnami	https://charts.bitnami.com/bitnami # 确定我们可以拿到最新的charts列表 helm repo update # TODO helm repo remove search 从仓库中查找 chart,提供从两种来源查找 chart: 1.https://artifacthub.io/ 使用 helm search hub 命令来进行查找，2.使用 helm repo add 添加的仓库，使用 helm search repo {repo_name}"><meta property="og:type" content="article"><meta property="og:url" content="https://moyuduo.github.io/posts/helm/"><meta property="og:image" content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-27T16:16:14+08:00"><meta property="article:modified_time" content="2022-11-27T16:16:14+08:00"><meta property="og:site_name" content="Moyuduo's Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://moyuduo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="helm"><meta name=twitter:description content="概念 chart: 包含创建 kubernetes 应用实例的必要信息 config: 包含应用发布配置信息 release: 是 chart 及其配置的一个运行实例 command repo chart 对应的是一个应用实例的信息，而要安装一个 chart 可以从多个仓库进行安装，repo 提供对仓库的增删
# 在 https://artifacthub.io/ 上查询要安装的应用有哪些提供安装的 repo helm repo add bitnami https://charts.bitnami.com/bitnami &#34;bitnami&#34; has been added to your repositories helm repo list NAME URL bitnami	https://charts.bitnami.com/bitnami # 确定我们可以拿到最新的charts列表 helm repo update # TODO helm repo remove search 从仓库中查找 chart,提供从两种来源查找 chart: 1.https://artifacthub.io/ 使用 helm search hub 命令来进行查找，2.使用 helm repo add 添加的仓库，使用 helm search repo {repo_name}"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://moyuduo.github.io/posts/"},{"@type":"ListItem","position":2,"name":"helm","item":"https://moyuduo.github.io/posts/helm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"helm","name":"helm","description":"概念 chart: 包含创建 kubernetes 应用实例的必要信息 config: 包含应用发布配置信息 release: 是 chart 及其配置的一个运行实例 command repo chart 对应的是一个应用实例的信息，而要安装一个 chart 可以从多个仓库进行安装，repo 提供对仓库的增删\n# 在 https://artifacthub.io/ 上查询要安装的应用有哪些提供安装的 repo helm repo add bitnami https://charts.bitnami.com/bitnami \u0026#34;bitnami\u0026#34; has been added to your repositories helm repo list NAME URL bitnami\thttps://charts.bitnami.com/bitnami # 确定我们可以拿到最新的charts列表 helm repo update # TODO helm repo remove search 从仓库中查找 chart,提供从两种来源查找 chart: 1.https://artifacthub.io/ 使用 helm search hub 命令来进行查找，2.使用 helm repo add 添加的仓库，使用 helm search repo {repo_name}","keywords":[],"articleBody":"概念 chart: 包含创建 kubernetes 应用实例的必要信息 config: 包含应用发布配置信息 release: 是 chart 及其配置的一个运行实例 command repo chart 对应的是一个应用实例的信息，而要安装一个 chart 可以从多个仓库进行安装，repo 提供对仓库的增删\n# 在 https://artifacthub.io/ 上查询要安装的应用有哪些提供安装的 repo helm repo add bitnami https://charts.bitnami.com/bitnami \"bitnami\" has been added to your repositories helm repo list NAME URL bitnami\thttps://charts.bitnami.com/bitnami # 确定我们可以拿到最新的charts列表 helm repo update # TODO helm repo remove search 从仓库中查找 chart,提供从两种来源查找 chart: 1.https://artifacthub.io/ 使用 helm search hub 命令来进行查找，2.使用 helm repo add 添加的仓库，使用 helm search repo {repo_name}\n# 从 Artifact Hub 中查找 helm search hub etcd # 从添加的仓库中查找 helm search repo bitnami install 安装 chart 包,会把应用安装到本地使用 kubectl 连接到的那个集群中\nhelm install bitnami/mysql --generate-name NAME: mysql-1646288553 LAST DEPLOYED: Thu Mar 3 14:22:43 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: CHART NAME: mysql CHART VERSION: 8.8.26 APP VERSION: 8.0.28 ** Please be patient while the chart is being deployed ** Tip: Watch the deployment status using the command: kubectl get pods -w --namespace default Services: echo Primary: mysql-1646288553.default.svc.cluster.local:3306 Execute the following to get the administrator credentials: echo Username: root MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default mysql-1646288553 -o jsonpath=\"{.data.mysql-root-password}\" | base64 --decode) To connect to your database: 1. Run a pod that you can use as a client: kubectl run mysql-1646288553-client --rm --tty -i --restart='Never' --image docker.io/bitnami/mysql:8.0.28-debian-10-r23 --namespace default --command -- bash 2. To connect to primary service (read/write): mysql -h mysql-1646288553.default.svc.cluster.local -uroot -p\"$MYSQL_ROOT_PASSWORD\" To upgrade this helm chart: 1. Obtain the password as described on the 'Administrator credentials' section and set the 'root.password' parameter as shown below: ROOT_PASSWORD=$(kubectl get secret --namespace default mysql-1646288553 -o jsonpath=\"{.data.mysql-root-password}\" | base64 --decode) helm upgrade --namespace default mysql-1646288553 bitnami/mysql --set auth.rootPassword=$ROOT_PASSWORD # 使用自定义配置覆盖默认 chart 参数(可配置参数通过 helm show values 查看) -f 参数/ --set helm install -f values.yaml bitnami/mysql helm install bitnami/mysql --set # --dry-run --debug 参数并不会实际把 chart 安装到集群中，常用于调试 show/inspect 显示一个 chart 的信息\nhelm show chart bitnami/mysql annotations: category: Database apiVersion: v2 appVersion: 8.0.28 dependencies: - name: common repository: https://charts.bitnami.com/bitnami tags: - bitnami-common version: 1.x.x description: MySQL is a fast, reliable, scalable, and easy to use open source relational database system. Designed to handle mission-critical, heavy-load production applications. home: https://github.com/bitnami/charts/tree/master/bitnami/mysql icon: https://bitnami.com/assets/stacks/mysql/img/mysql-stack-220x234.png keywords: - mysql - database - sql - cluster - high availability maintainers: - email: containers@bitnami.com name: Bitnami name: mysql sources: - https://github.com/bitnami/bitnami-docker-mysql - https://mysql.com version: 8.8.26 # 显示 chart 的可配置选项,在定制化 chart 安装时非常有用 helm show values bitnami/mysql ## @section Global parameters ## Global Docker image parameters ## Please, note that this will override the image parameters, including dependencies, configured to use the global value ## Current available global Docker image parameters: imageRegistry, imagePullSecrets and storageClass ## @param global.imageRegistry Global Docker image registry ## @param global.imagePullSecrets [array] Global Docker registry secret names as an array ## @param global.storageClass Global StorageClass for Persistent Volume(s) ## global: imageRegistry: \"\" ## E.g. ## imagePullSecrets: ## - myRegistryKeySecretName ## imagePullSecrets: [] storageClass: \"\" ... list 显示 release 列表\nhelm list --all -A NAME NAMESPACE\tREVISION\tUPDATED STATUS CHART APP VERSION mysql-1646288553\tdefault 1 2022-03-03 14:22:43.477160293 +0800 CST\tdeployed\tmysql-8.8.26\t8.0.28 status 显示一个 release 的状态，由于在 helm install 的时候 helm 只负责把资源安装到 kubernetes 集群中，并不会等到所有的资源都运行起来了再退出，所以 status 用来追踪 release\nhelm status {release_name} -n {namespace} uninstall 卸载一个 release\n# --keep-history 会使 helm 跟踪该 release 的版本(即使被删除了),使用 helm status 可以查看，可以使用 helm rollback 来回滚版本 helm uninstall mysql-1646288553 release \"mysql-1646288553\" uninstalled upgrade 修改 release 配置或升级 chart 版本\nhelm upgrade -f panda.yaml happy-panda bitnami/wordpress helm upgrade happy-panda bitnami/wordpress --set a=1,b=2 get 获取一个 release 的信息\nhelm get values {release_name} helm get values myd-mysql -n nicktming template 用于渲染 chart 生成待部署的 yaml 文件,单并不会部署到 kubenetes 集群中\nhelm template {release_name} {chart_name} create 创建本地 chart\nhelm create mychart1 cd mychart1 tree . ├── charts ├── Chart.yaml #保存了 chart 的一些信息，如 chart 的 name/version 等 ├── templates │ ├── deployment.yaml │ ├── _helpers.tpl #放置模板助手的地方，可以在整个 chart 中重复使用 │ ├── hpa.yaml │ ├── ingress.yaml │ ├── NOTES.txt #chart 的 “帮助文本”。这会在用户运行 helm install 时显示给用户 │ ├── serviceaccount.yaml │ ├── service.yaml │ └── tests │ └── test-connection.yaml └── values.yaml #用于保存用户模板值，供在 yaml 使用 {{ .Values.xxx }} 进行替换 3 directories, 10 files 模板 在 templates 目录下编写的 yaml 文件会被渲染并最终在 helm install 的时候部署到集群中\n在 yaml 文件中可以使用 {{ 和 }} 来插入对象，如 {{ .Release.Name }} 最终就会替换成 release 的名字， .Release 是内置对象\n内置对象 Release: 这个对象描述了 release 本身 Release.Name：release 名称 Release.Time：release 的时间 Release.Namespace：release 的 namespace Release.Service：release 服务的名称 Release.Revision：此 release 的修订版本号，从1开始累加 Release.IsUpgrade：如果当前操作是升级或回滚，则将其设置为 true Release.IsInstall：如果当前操作是安装，则设置为 true Values: 从values.yaml文件和用户提供的文件传入模板的值。默认情况下，Values 是空的 Chart: Chart.yaml文件的内容 Values 内置对象中有一个对象就是 Values，该对象提供对传入 chart 的值的访问，Values 对象的值有4个来源：\nchart 包中的 values.yaml 文件 父 chart 包的 values.yaml 文件 通过 helm install 或者 helm upgrade 的-f或者--values参数传入的自定义的 yaml 文件 通过--set参数传入的值 chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，同样可以被–set提供的参数所覆盖,优先级: –set \u003e -f \u003e values.yaml\n模板函数 比如我们需要从.Values中读取的值变成字符串的时候就可以通过调用quote模板函数\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: myvalue: \"Hello World\" k8s: {{ quote .Values.course.k8s }} python: {{ .Values.course.python }} 更多模板函数参考：\ngo模板函数\nSprig模板函数\n管道 模板语言除了提供了丰富的内置函数之外，其另一个强大的功能就是管道的概念。和UNIX中一样，管道我们通常称为Pipeline，是一个链在一起的一系列模板命令的工具，以紧凑地表达一系列转换。简单来说，管道是可以按顺序完成一系列事情的一种方法\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: myvalue: \"Hello World\" k8s: {{ .Values.course.k8s | quote }} python: {{ .Values.course.python }} default 函数 default 函数允许我们在模板内部指定默认值，以防止该值被忽略掉了\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: myvalue: {{ .Values.hello | default \"Hello World\" | quote }} k8s: {{ .Values.course.k8s | upper | quote }} python: {{ .Values.course.python | repeat 5 | quote }} 流程控制 控制流程为我们提供了控制模板生成流程的一种能力，Helm 的模板语言提供了以下几种流程控制：\nif/else 条件块 with 指定范围 range 循环块 除此之外，还提供了一些声明和使用命名模板段的操作:\ndefine在模板中声明一个新的命名模板 template导入一个命名模板 block声明了一种特殊的可填写的模板区域 if/else 基本结构如下:\n{{ if PIPELINE }} # Do something {{ else if OTHER PIPELINE }} # Do something else {{ else }} # Default case {{ end }} 使用条件块就得判断条件是否为真，如果值为下面的几种情况，则管道的结果为 false:\n一个布尔类型的假 一个数字零 一个空的字符串 一个nil（空或null) 一个空的集合（map、slice、tuple、dict、array） 除了上面的这些情况外，其他所有条件都为真\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: {{ if eq .Values.course.python \"django\" }}web: true{{ end }} 空格控制 上面我们的条件判断语句是在一整行中的，如果平时经常写代码的同学可能非常不习惯了，我们一般会将其格式化为更容易阅读的形式\n{{ if eq .Values.course.python \"django\" }} web: true {{ end }} 但是渲染出来会有多余的空行，这是因为当模板引擎运行时，它将一些值渲染过后，之前的指令被删除，但它之前所占的位置完全按原样保留剩余的空白了，所以就出现了多余的空行\n可以通过使用在模板标识{{后面添加破折号和空格{{-来表示将空白左移，而在}}前面添加一个空格和破折号-}}表示应该删除右边的空格，另外需要注意的是换行符也是空格！\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: {{- if eq .Values.course.python \"django\" }} web: true {{- end }} with控制变量作用域 {{ .Release.xxx }}中的.就是表示对当前范围的引用\n{{ with PIPELINE }} # restricted scope {{ end }} 可以使用with来将.范围指向.Values.course\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: {{- with .Values.course }} {{- if eq .python \"django\" }} web: true {{- end }} {{- end }} range范围 在 Helm 模板语言中，是使用range关键字来进行循环操作\n在values.yaml文件中添加上一个课程列表:\ncourselist: - k8s - python - search - golang person: name: moyuduo age: 21 gender: man human: - man - woman - unknow 修改 ConfigMap 模板文件来循环打印出该列表：\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: courselist: {{- range .Values.courselist }} - {{ . | title | quote }} {{- end }} {{- range $idx,$val := .Values.human }} human{{ $idx }}: {{ $val }} {{- end}} {{- range $key, $value := .Values.person }} {{ $key }}: {{ $value | quote }} {{- end }} 除了 list 或者 tuple，range 还可以用于遍历具有键和值的集合（如map 或 dict）\n变量 {{- with .Values.course }} k8s: {{ .k8s | upper | quote }} python: {{ .python | repeat 3 | quote }} release: {{ .var1 }} {{- end }} 在with语句块内添加了一个.var1对象，但这个模板是错误的，编译的时候会失败，这是因为.var1不在该with语句块限制的作用范围之内，我们可以将该对象赋值给一个变量可以来解决这个问题\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap data: {{- $var1 := .Release.Name -}} {{- with .Values.course }} k8s: {{ .k8s | upper | quote }} python: {{ .python | repeat 3 | quote }} release: {{ $var1 }} {{- end }} 命名模板 命名模板我们也可以称为子模板，是限定在一个文件内部的模板，然后给一个名称。在使用命名模板的时候有一个需要特别注意的是：模板名称是全局的，如果我们声明了两个相同名称的模板，最后加载的一个模板会覆盖掉另外的模板，由于子 chart 中的模板也是和顶层的模板一起编译的，所以在命名的时候一定要注意，不要重名了。\n为了避免重名，有个通用的约定就是为每个定义的模板添加上 chart 名称：{{define \"mychart.labels\"}}，define关键字就是用来声明命名模板的，加上 chart 名称就可以避免不同 chart 间的模板出现冲突的情况。\n结构:\n{{ define \"ChartName.TplName\" }} # 模板内容区域 {{ end }} 可以将该模板嵌入到现有的 ConfigMap 中，然后使用template关键字在需要的地方包含进来即可:\n{{- define \"mychart.labels\" }} labels: from: helm date: {{ now | htmlDate }} {{- end }} apiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap {{- template \"mychart.labels\" }} data: {{- range $key, $value := .Values.course }} {{ $key }}: {{ $value | quote }} {{- end }} 在创建 chart 包的时候，templates 目录下面默认会生成一个_helpers.tpl文件吗？我们前面也提到过 templates 目录下面除了NOTES.txt文件和以下划线_开头命令的文件之外，都会被当做 kubernetes 的资源清单文件，而这个下划线开头的文件不会被当做资源清单外，还可以被其他 chart 模板中调用，这个就是 Helm 中的 partials 文件，所以其实我们完全就可以将命名模板定义在这些 partials 文件中，默认就是_helpers.tpl文件了\n将上面定义的命名模板移动到 templates/_helpers.tpl 文件中去:\n{{/* 生成基本的 labels 标签 */}} {{- define \"mychart.labels\" }} labels: from: helm date: {{ now | htmlDate }} {{- end }} 模板范围 我们在里面来使用 chart 对象相关信息：\n{{/* 生成基本的 labels 标签 */}} {{- define \"mychart.labels\" }} labels: from: helm date: {{ now | htmlDate }} chart: {{ .Chart.Name }} version: {{ .Chart.Version }} {{- end }} 如果这样的直接进行渲染测试的话，是不会得到我们的预期结果的\nchart 的名称和版本都没有正确被渲染，这是因为他们不在我们定义的模板范围内，当命名模板被渲染时，它会接收由 template 调用时传入的作用域，由于我们这里并没有传入对应的作用域，因此模板中我们无法调用到 .Chart 对象，要解决也非常简单，我们只需要在 template 后面加上作用域范围即可:\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap {{- template \"mychart.labels\" . }} data: {{- range $key, $value := .Values.course }} {{ $key }}: {{ $value | quote }} {{- end }} 我们在 template 末尾传递了.，表示当前的最顶层的作用范围，如果我们想要在命名模板中使用.Values范围内的数据，当然也是可以的\ninclude函数 将上面的定义的 labels 单独提取出来放置到 _helpers.tpl 文件中:\n{{/* 生成基本的 labels 标签 */}} {{- define \"mychart.labels\" }} from: helm date: {{ now | htmlDate }} chart: {{ .Chart.Name }} version: {{ .Chart.Version }} {{- end }} 将该命名模板插入到 configmap 模板文件的 labels 部分和 data 部分:\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap labels: {{- template \"mychart.labels\" . }} data: {{- range $key, $value := .Values.course }} {{ $key }}: {{ $value | quote }} {{- end }} {{- template \"mychart.labels\" . }} 渲染后：\n# Source: mychart/templates/configmap.yaml apiVersion: v1 kind: ConfigMap metadata: name: altered-wombat-configmap labels: from: helm date: 2018-09-22 chart: mychart version: 0.1.0 data: k8s: \"devops\" python: \"django\" from: helm date: 2018-09-22 chart: mychart version: 0.1.0 可以看到渲染结果是有问题的，不是一个正常的 YAML 文件格式，这是因为template只是表示一个嵌入动作而已，不是一个函数，所以原本命名模板中是怎样的格式就是怎样的格式被嵌入进来了\n为了解决这个问题，Helm 提供了另外一个方案来代替template，那就是使用include函数，在需要控制空格的地方使用indent管道函数来自己控制\napiVersion: v1 kind: ConfigMap metadata: name: {{ .Release.Name }}-configmap labels: {{- include \"mychart.labels\" . | indent 4 }} data: {{- range $key, $value := .Values.course }} {{ $key }}: {{ $value | quote }} {{- end }} {{- include \"mychart.labels\" . | indent 2 }} 可以看到不管是 template 或 include 都不会因为在引用模板文件时隔了几个空格就导致引入的内容隔几个空格，还是需要使用 include 引入，并使用 indent 控制空格\nNOTES.txt文件 我们前面在使用 helm install 命令的时候，Helm 都会为我们打印出一大堆介绍信息，这样当别的用户在使用我们的 chart 包的时候就可以根据这些注释信息快速了解我们的 chart 包的使用方法，这些信息就是编写在 NOTES.txt 文件之中的，这个文件是纯文本的，但是它和其他模板一样，具有所有可用的普通模板函数和对象\nThank you for installing {{ .Chart.Name }}. Your release is named {{ .Release.Name }}. To learn more about the release, try: $ helm status {{ .Release.Name }} $ helm get {{ .Release.Name }} 子chart包 在创建 mychart 包的时候，在根目录下面有一个空文件夹 charts 目录吗？这就是我们的子 chart 所在的目录，在该目录下面添加一个新的 chart\ncd chart helm create subchart 值覆盖 删除子 chart template 下的所有文件，并创建一个 ConfigMap 文件\napiVersion: v1 metadat: name: {{ .Release.Name }}-cm data: in: {{ .Values.in }} 修改子chart的values.yaml文件：\nin: subchart 现在 subchart 这个子 chart 就属于 mychart 这个父 chart 了，由于 mychart 是父级，所以我们可以在 mychart 的 values.yaml 文件中直接配置子 chart 中的值，比如我们可以在 mychart/values.yaml 文件中添加上子 chart 的值\nsubchart: in: parent 子 chart 中的值已经被顶层的值给覆盖了。但是在某些场景下面我们还是希望某些值在所有模板中都可以使用，这就需要用到全局 chart 值了\n!!!注意这里父 chart 要覆盖子 chart 中的值，在父 chart 的 values.yaml 中定义值时必须指定子 chart 的名字,如这里的 subchart.in的值仅能替换名为subchart的 chart 中定义的 in的值\n全局值 全局值可以从任何 chart 或者子 chart中进行访问使用，values 对象中有一个保留的属性是Values.global，就可以被用来设置全局值,比如我们在父 chart 的 values.yaml 文件中添加一个全局值:\nglobal: allin: helm 在 values.yaml 文件中添加了一个 global 的属性，这样的话无论在父 chart 中还是在子 chart 中我们都可以通过{{ .Values.global.allin }}来访问这个全局值了\n如果 global中同名的值既在父 chart 中设置了也在子 chart 中设置了，那么会以父 chart 中的为准，如果只在子 chart 中设置了，那么子 chart 中可以引用，父 chart 中不可引用\npackage 打包本地 chart 为 .tgz 文件\nhelm package mychart1 Hooks Helm 也提供了 Hook 的机制，允许 chart 开发人员在 release 的生命周期中的某些节点来进行干预\nTODO\n","wordCount":"1680","inLanguage":"en","datePublished":"2022-11-27T16:16:14+08:00","dateModified":"2022-11-27T16:16:14+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moyuduo.github.io/posts/helm/"},"publisher":{"@type":"Organization","name":"Moyuduo's Blog","logo":{"@type":"ImageObject","url":"https://moyuduo.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://moyuduo.github.io/ accesskey=h title="Moyuduo's Blog (Alt + H)"><img src=https://moyuduo.github.io/apple-touch-icon.png alt aria-label=logo height=35>Moyuduo's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://moyuduo.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://moyuduo.github.io/archives title=Archive><span>Archive</span></a></li><li><a href=https://moyuduo.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://moyuduo.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>helm</h1></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#repo>repo</a></li><li><a href=#search>search</a></li><li><a href=#install>install</a></li><li><a href=#showinspect>show/inspect</a></li><li><a href=#list>list</a></li><li><a href=#status>status</a></li><li><a href=#uninstall>uninstall</a></li><li><a href=#upgrade>upgrade</a></li><li><a href=#get>get</a></li><li><a href=#template>template</a></li><li><a href=#create>create</a><ul><li><a href=#模板>模板</a></li><li><a href=#内置对象>内置对象</a></li><li><a href=#values>Values</a></li><li><a href=#模板函数>模板函数</a></li><li><a href=#管道>管道</a></li><li><a href=#default-函数>default 函数</a></li><li><a href=#流程控制>流程控制</a></li></ul></li><li><a href=#package>package</a></li><li><a href=#hooks>Hooks</a></li></ul></nav></div></details></div><div class=post-content><h1 id=概念>概念<a hidden class=anchor aria-hidden=true href=#概念>#</a></h1><ul><li>chart: 包含创建 kubernetes 应用实例的必要信息</li><li>config: 包含应用发布配置信息</li><li>release: 是 chart 及其配置的一个运行实例</li></ul><h1 id=command>command<a hidden class=anchor aria-hidden=true href=#command>#</a></h1><h2 id=repo>repo<a hidden class=anchor aria-hidden=true href=#repo>#</a></h2><blockquote><p>chart 对应的是一个应用实例的信息，而要安装一个 chart 可以从多个仓库进行安装，repo 提供对仓库的增删</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 在 https://artifacthub.io/ 上查询要安装的应用有哪些提供安装的 repo</span>
</span></span><span class=line><span class=cl>helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span class=line><span class=cl><span class=s2>&#34;bitnami&#34;</span> has been added to your repositories
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>helm repo list
</span></span><span class=line><span class=cl>NAME   	URL                               
</span></span><span class=line><span class=cl>bitnami	https://charts.bitnami.com/bitnami
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 确定我们可以拿到最新的charts列表</span>
</span></span><span class=line><span class=cl>helm repo update 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TODO helm repo remove</span>
</span></span></code></pre></div><h2 id=search>search<a hidden class=anchor aria-hidden=true href=#search>#</a></h2><blockquote><p>从仓库中查找 chart,提供从两种来源查找 chart: 1.https://artifacthub.io/ 使用 helm search hub 命令来进行查找，2.使用 helm repo add 添加的仓库，使用 helm search repo {repo_name}</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 从 Artifact Hub 中查找</span>
</span></span><span class=line><span class=cl>helm search hub etcd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从添加的仓库中查找</span>
</span></span><span class=line><span class=cl>helm search repo bitnami
</span></span></code></pre></div><h2 id=install>install<a hidden class=anchor aria-hidden=true href=#install>#</a></h2><blockquote><p>安装 chart 包,会把应用安装到本地使用 kubectl 连接到的那个集群中</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm install bitnami/mysql --generate-name
</span></span><span class=line><span class=cl>NAME: mysql-1646288553
</span></span><span class=line><span class=cl>LAST DEPLOYED: Thu Mar  <span class=m>3</span> 14:22:43 <span class=m>2022</span>
</span></span><span class=line><span class=cl>NAMESPACE: default
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>1</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>CHART NAME: mysql
</span></span><span class=line><span class=cl>CHART VERSION: 8.8.26
</span></span><span class=line><span class=cl>APP VERSION: 8.0.28
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>** Please be patient <span class=k>while</span> the chart is being deployed **
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Tip:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  Watch the deployment status using the command: kubectl get pods -w --namespace default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Services:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> Primary: mysql-1646288553.default.svc.cluster.local:3306
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Execute the following to get the administrator credentials:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> Username: root
</span></span><span class=line><span class=cl>  <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default mysql-1646288553 -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.mysql-root-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To connect to your database:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  1. Run a pod that you can use as a client:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      kubectl run mysql-1646288553-client --rm --tty -i --restart<span class=o>=</span><span class=s1>&#39;Never&#39;</span> --image  docker.io/bitnami/mysql:8.0.28-debian-10-r23 --namespace default --command -- bash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  2. To connect to primary service <span class=o>(</span>read/write<span class=o>)</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      mysql -h mysql-1646288553.default.svc.cluster.local -uroot -p<span class=s2>&#34;</span><span class=nv>$MYSQL_ROOT_PASSWORD</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To upgrade this helm chart:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  1. Obtain the password as described on the <span class=s1>&#39;Administrator credentials&#39;</span> section and <span class=nb>set</span> the <span class=s1>&#39;root.password&#39;</span> parameter as shown below:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nv>ROOT_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret --namespace default mysql-1646288553 -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.mysql-root-password}&#34;</span> <span class=p>|</span> base64 --decode<span class=k>)</span>
</span></span><span class=line><span class=cl>      helm upgrade --namespace default mysql-1646288553 bitnami/mysql --set auth.rootPassword<span class=o>=</span><span class=nv>$ROOT_PASSWORD</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用自定义配置覆盖默认 chart 参数(可配置参数通过 helm show values 查看) -f 参数/ --set </span>
</span></span><span class=line><span class=cl>helm install -f values.yaml bitnami/mysql
</span></span><span class=line><span class=cl>helm install bitnami/mysql --set 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># --dry-run --debug 参数并不会实际把 chart 安装到集群中，常用于调试</span>
</span></span></code></pre></div><h2 id=showinspect>show/inspect<a hidden class=anchor aria-hidden=true href=#showinspect>#</a></h2><blockquote><p>显示一个 chart 的信息</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm show chart bitnami/mysql
</span></span><span class=line><span class=cl>annotations:
</span></span><span class=line><span class=cl>  category: Database
</span></span><span class=line><span class=cl>apiVersion: v2
</span></span><span class=line><span class=cl>appVersion: 8.0.28
</span></span><span class=line><span class=cl>dependencies:
</span></span><span class=line><span class=cl>- name: common
</span></span><span class=line><span class=cl>  repository: https://charts.bitnami.com/bitnami
</span></span><span class=line><span class=cl>  tags:
</span></span><span class=line><span class=cl>  - bitnami-common
</span></span><span class=line><span class=cl>  version: 1.x.x
</span></span><span class=line><span class=cl>description: MySQL is a fast, reliable, scalable, and easy to use open <span class=nb>source</span> relational
</span></span><span class=line><span class=cl>  database system. Designed to handle mission-critical, heavy-load production applications.
</span></span><span class=line><span class=cl>home: https://github.com/bitnami/charts/tree/master/bitnami/mysql
</span></span><span class=line><span class=cl>icon: https://bitnami.com/assets/stacks/mysql/img/mysql-stack-220x234.png
</span></span><span class=line><span class=cl>keywords:
</span></span><span class=line><span class=cl>- mysql
</span></span><span class=line><span class=cl>- database
</span></span><span class=line><span class=cl>- sql
</span></span><span class=line><span class=cl>- cluster
</span></span><span class=line><span class=cl>- high availability
</span></span><span class=line><span class=cl>maintainers:
</span></span><span class=line><span class=cl>- email: containers@bitnami.com
</span></span><span class=line><span class=cl>  name: Bitnami
</span></span><span class=line><span class=cl>name: mysql
</span></span><span class=line><span class=cl>sources:
</span></span><span class=line><span class=cl>- https://github.com/bitnami/bitnami-docker-mysql
</span></span><span class=line><span class=cl>- https://mysql.com
</span></span><span class=line><span class=cl>version: 8.8.26
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 显示 chart 的可配置选项,在定制化 chart 安装时非常有用</span>
</span></span><span class=line><span class=cl>helm show values bitnami/mysql
</span></span><span class=line><span class=cl><span class=c1>## @section Global parameters</span>
</span></span><span class=line><span class=cl><span class=c1>## Global Docker image parameters</span>
</span></span><span class=line><span class=cl><span class=c1>## Please, note that this will override the image parameters, including dependencies, configured to use the global value</span>
</span></span><span class=line><span class=cl><span class=c1>## Current available global Docker image parameters: imageRegistry, imagePullSecrets and storageClass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## @param global.imageRegistry Global Docker image registry</span>
</span></span><span class=line><span class=cl><span class=c1>## @param global.imagePullSecrets [array] Global Docker registry secret names as an array</span>
</span></span><span class=line><span class=cl><span class=c1>## @param global.storageClass Global StorageClass for Persistent Volume(s)</span>
</span></span><span class=line><span class=cl><span class=c1>##</span>
</span></span><span class=line><span class=cl>global:
</span></span><span class=line><span class=cl>  imageRegistry: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=c1>## E.g.</span>
</span></span><span class=line><span class=cl>  <span class=c1>## imagePullSecrets:</span>
</span></span><span class=line><span class=cl>  <span class=c1>##   - myRegistryKeySecretName</span>
</span></span><span class=line><span class=cl>  <span class=c1>##</span>
</span></span><span class=line><span class=cl>  imagePullSecrets: <span class=o>[]</span>
</span></span><span class=line><span class=cl>  storageClass: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h2 id=list>list<a hidden class=anchor aria-hidden=true href=#list>#</a></h2><blockquote><p>显示 release 列表</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm list --all -A
</span></span><span class=line><span class=cl>NAME            	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART       	APP VERSION
</span></span><span class=line><span class=cl>mysql-1646288553	default  	<span class=m>1</span>       	2022-03-03 14:22:43.477160293 +0800 CST	deployed	mysql-8.8.26	8.0.28
</span></span></code></pre></div><h2 id=status>status<a hidden class=anchor aria-hidden=true href=#status>#</a></h2><blockquote><p>显示一个 release 的状态，由于在 helm install 的时候 helm 只负责把资源安装到 kubernetes 集群中，并不会等到所有的资源都运行起来了再退出，所以 status 用来追踪 release</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm status <span class=o>{</span>release_name<span class=o>}</span> -n <span class=o>{</span>namespace<span class=o>}</span>
</span></span></code></pre></div><h2 id=uninstall>uninstall<a hidden class=anchor aria-hidden=true href=#uninstall>#</a></h2><blockquote><p>卸载一个 release</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># --keep-history 会使 helm 跟踪该 release 的版本(即使被删除了),使用 helm status 可以查看，可以使用 helm rollback 来回滚版本</span>
</span></span><span class=line><span class=cl>helm uninstall mysql-1646288553
</span></span><span class=line><span class=cl>release <span class=s2>&#34;mysql-1646288553&#34;</span> uninstalled
</span></span></code></pre></div><h2 id=upgrade>upgrade<a hidden class=anchor aria-hidden=true href=#upgrade>#</a></h2><blockquote><p>修改 release 配置或升级 chart 版本</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm upgrade -f panda.yaml happy-panda bitnami/wordpress
</span></span><span class=line><span class=cl>helm upgrade happy-panda bitnami/wordpress --set <span class=nv>a</span><span class=o>=</span>1,b<span class=o>=</span><span class=m>2</span>
</span></span></code></pre></div><h2 id=get>get<a hidden class=anchor aria-hidden=true href=#get>#</a></h2><blockquote><p>获取一个 release 的信息</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm get values <span class=o>{</span>release_name<span class=o>}</span>
</span></span><span class=line><span class=cl>helm get values myd-mysql -n nicktming
</span></span></code></pre></div><h2 id=template>template<a hidden class=anchor aria-hidden=true href=#template>#</a></h2><blockquote><p>用于渲染 chart 生成待部署的 yaml 文件,单并不会部署到 kubenetes 集群中</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm template <span class=o>{</span>release_name<span class=o>}</span> <span class=o>{</span>chart_name<span class=o>}</span>
</span></span></code></pre></div><h2 id=create>create<a hidden class=anchor aria-hidden=true href=#create>#</a></h2><blockquote><p>创建本地 chart</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm create mychart1
</span></span><span class=line><span class=cl><span class=nb>cd</span> mychart1
</span></span><span class=line><span class=cl>tree
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── charts
</span></span><span class=line><span class=cl>├── Chart.yaml  <span class=c1>#保存了 chart 的一些信息，如 chart 的 name/version 等</span>
</span></span><span class=line><span class=cl>├── templates
</span></span><span class=line><span class=cl>│   ├── deployment.yaml
</span></span><span class=line><span class=cl>│   ├── _helpers.tpl    <span class=c1>#放置模板助手的地方，可以在整个 chart 中重复使用</span>
</span></span><span class=line><span class=cl>│   ├── hpa.yaml
</span></span><span class=line><span class=cl>│   ├── ingress.yaml
</span></span><span class=line><span class=cl>│   ├── NOTES.txt   <span class=c1>#chart 的 “帮助文本”。这会在用户运行 helm install 时显示给用户</span>
</span></span><span class=line><span class=cl>│   ├── serviceaccount.yaml
</span></span><span class=line><span class=cl>│   ├── service.yaml
</span></span><span class=line><span class=cl>│   └── tests
</span></span><span class=line><span class=cl>│       └── test-connection.yaml
</span></span><span class=line><span class=cl>└── values.yaml <span class=c1>#用于保存用户模板值，供在 yaml 使用 {{ .Values.xxx }} 进行替换</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>3</span> directories, <span class=m>10</span> files
</span></span></code></pre></div><h3 id=模板>模板<a hidden class=anchor aria-hidden=true href=#模板>#</a></h3><p>在 templates 目录下编写的 yaml 文件会被渲染并最终在 helm install 的时候部署到集群中</p><p>在 yaml 文件中可以使用 <code>{{</code> 和 <code>}}</code> 来插入对象，如 <code>{{ .Release.Name }}</code> 最终就会替换成 release 的名字， <code>.Release</code> 是内置对象</p><h3 id=内置对象>内置对象<a hidden class=anchor aria-hidden=true href=#内置对象>#</a></h3><ul><li>Release: 这个对象描述了 release 本身<ul><li>Release.Name：release 名称</li><li>Release.Time：release 的时间</li><li>Release.Namespace：release 的 namespace</li><li>Release.Service：release 服务的名称</li><li>Release.Revision：此 release 的修订版本号，从1开始累加</li><li>Release.IsUpgrade：如果当前操作是升级或回滚，则将其设置为 true</li><li>Release.IsInstall：如果当前操作是安装，则设置为 true</li></ul></li><li>Values: 从<code>values.yaml</code>文件和用户提供的文件传入模板的值。默认情况下，Values 是空的</li><li>Chart: <code>Chart.yaml</code>文件的内容</li></ul><h3 id=values>Values<a hidden class=anchor aria-hidden=true href=#values>#</a></h3><p>内置对象中有一个对象就是 Values，该对象提供对传入 chart 的值的访问，Values 对象的值有4个来源：</p><ol><li>chart 包中的 <code>values.yaml</code> 文件</li><li>父 chart 包的 <code>values.yaml</code> 文件</li><li>通过 <code>helm install</code> 或者 <code>helm upgrade</code> 的<code>-f</code>或者<code>--values</code>参数传入的自定义的 yaml 文件</li><li>通过<code>--set</code>参数传入的值</li></ol><p><strong>chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，同样可以被&ndash;set提供的参数所覆盖,优先级: &ndash;set > -f > values.yaml</strong></p><h3 id=模板函数>模板函数<a hidden class=anchor aria-hidden=true href=#模板函数>#</a></h3><p>比如我们需要从<code>.Values</code>中读取的值变成字符串的时候就可以通过调用<code>quote</code>模板函数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  myvalue: <span class=s2>&#34;Hello World&#34;</span>
</span></span><span class=line><span class=cl>  k8s: <span class=o>{{</span> quote .Values.course.k8s <span class=o>}}</span>
</span></span><span class=line><span class=cl>  python: <span class=o>{{</span> .Values.course.python <span class=o>}}</span>
</span></span></code></pre></div><p>更多模板函数参考：</p><p><a href=https://godoc.org/text/template>go模板函数</a></p><p><a href=https://godoc.org/github.com/Masterminds/sprig>Sprig模板函数</a></p><h3 id=管道>管道<a hidden class=anchor aria-hidden=true href=#管道>#</a></h3><p>模板语言除了提供了丰富的内置函数之外，其另一个强大的功能就是管道的概念。和UNIX中一样，管道我们通常称为Pipeline，是一个链在一起的一系列模板命令的工具，以紧凑地表达一系列转换。简单来说，管道是可以按顺序完成一系列事情的一种方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  myvalue: <span class=s2>&#34;Hello World&#34;</span>
</span></span><span class=line><span class=cl>  k8s: <span class=o>{{</span> .Values.course.k8s <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  python: <span class=o>{{</span> .Values.course.python <span class=o>}}</span>
</span></span></code></pre></div><h3 id=default-函数>default 函数<a hidden class=anchor aria-hidden=true href=#default-函数>#</a></h3><p>default 函数允许我们在模板内部指定默认值，以防止该值被忽略掉了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  myvalue: <span class=o>{{</span> .Values.hello <span class=p>|</span> default  <span class=s2>&#34;Hello World&#34;</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  k8s: <span class=o>{{</span> .Values.course.k8s <span class=p>|</span> upper <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  python: <span class=o>{{</span> .Values.course.python <span class=p>|</span> repeat <span class=m>5</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span></code></pre></div><h3 id=流程控制>流程控制<a hidden class=anchor aria-hidden=true href=#流程控制>#</a></h3><p>控制流程为我们提供了控制模板生成流程的一种能力，Helm 的模板语言提供了以下几种流程控制：</p><ol><li><code>if/else</code> 条件块</li><li><code>with</code> 指定范围</li><li><code>range</code> 循环块</li></ol><p>除此之外，还提供了一些声明和使用命名模板段的操作:</p><ol><li><code>define</code>在模板中声明一个新的命名模板</li><li><code>template</code>导入一个命名模板</li><li><code>block</code>声明了一种特殊的可填写的模板区域</li></ol><h4 id=ifelse>if/else<a hidden class=anchor aria-hidden=true href=#ifelse>#</a></h4><p>基本结构如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span> <span class=k>if</span> PIPELINE <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=c1># Do something</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=k>else</span> <span class=k>if</span> OTHER PIPELINE <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=c1># Do something else</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> <span class=k>else</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=c1># Default case</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> end <span class=o>}}</span>
</span></span></code></pre></div><p>使用条件块就得判断条件是否为真，如果值为下面的几种情况，则管道的结果为 false:</p><ol><li>一个布尔类型的假</li><li>一个数字零</li><li>一个空的字符串</li><li>一个nil（空或null)</li><li>一个空的集合（map、slice、tuple、dict、array）</li></ol><p>除了上面的这些情况外，其他所有条件都为真</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span> <span class=k>if</span> eq .Values.course.python <span class=s2>&#34;django&#34;</span> <span class=o>}}</span>web: true<span class=o>{{</span> end <span class=o>}}</span>
</span></span></code></pre></div><h4 id=空格控制>空格控制<a hidden class=anchor aria-hidden=true href=#空格控制>#</a></h4><p>上面我们的条件判断语句是在一整行中的，如果平时经常写代码的同学可能非常不习惯了，我们一般会将其格式化为更容易阅读的形式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span> <span class=k>if</span> eq .Values.course.python <span class=s2>&#34;django&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>web: <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> end <span class=o>}}</span>
</span></span></code></pre></div><p>但是渲染出来会有多余的空行，这是因为当模板引擎运行时，它将一些值渲染过后，之前的指令被删除，但它之前所占的位置完全按原样保留剩余的空白了，所以就出现了多余的空行</p><p>可以通过使用在模板标识<code>{{</code>后面添加破折号和空格<code>{{-</code>来表示将空白左移，而在<code>}}</code>前面添加一个空格和破折号<code>-}}</code>表示应该删除右边的空格，另外需要注意的是换行符也是空格！</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- <span class=k>if</span> eq .Values.course.python <span class=s2>&#34;django&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  web: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><h4 id=with控制变量作用域>with控制变量作用域<a hidden class=anchor aria-hidden=true href=#with控制变量作用域>#</a></h4><p><code>{{ .Release.xxx }}</code>中的<code>.</code>就是表示对当前范围的引用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span> with PIPELINE <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=c1>#  restricted scope</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> end <span class=o>}}</span>
</span></span></code></pre></div><p>可以使用with来将.范围指向.Values.course</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- with .Values.course <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- <span class=k>if</span> eq .python <span class=s2>&#34;django&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  web: <span class=nb>true</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><h4 id=range范围>range范围<a hidden class=anchor aria-hidden=true href=#range范围>#</a></h4><p>在 Helm 模板语言中，是使用<code>range</code>关键字来进行循环操作</p><p>在<code>values.yaml</code>文件中添加上一个课程列表:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>courselist:
</span></span><span class=line><span class=cl>- k8s
</span></span><span class=line><span class=cl>- python
</span></span><span class=line><span class=cl>- search
</span></span><span class=line><span class=cl>- golang
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>person:
</span></span><span class=line><span class=cl>  name: moyuduo
</span></span><span class=line><span class=cl>  age: <span class=m>21</span>
</span></span><span class=line><span class=cl>  gender: man
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>human:
</span></span><span class=line><span class=cl>- man
</span></span><span class=line><span class=cl>- woman
</span></span><span class=line><span class=cl>- unknow
</span></span></code></pre></div><p>修改 ConfigMap 模板文件来循环打印出该列表：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  courselist:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- range .Values.courselist <span class=o>}}</span>
</span></span><span class=line><span class=cl>  - <span class=o>{{</span> . <span class=p>|</span> title <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- range <span class=nv>$idx</span>,<span class=nv>$val</span> :<span class=o>=</span> .Values.human <span class=o>}}</span>
</span></span><span class=line><span class=cl>  human<span class=o>{{</span> <span class=nv>$idx</span> <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$val</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end<span class=o>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- range <span class=nv>$key</span>, <span class=nv>$value</span> :<span class=o>=</span> .Values.person <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span> <span class=nv>$key</span> <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$value</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><p>除了 <code>list</code> 或者 <code>tuple</code>，<code>range</code> 还可以用于遍历具有键和值的集合（如<code>map</code> 或 <code>dict</code>）</p><h4 id=变量>变量<a hidden class=anchor aria-hidden=true href=#变量>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span>- with .Values.course <span class=o>}}</span>
</span></span><span class=line><span class=cl>k8s: <span class=o>{{</span> .k8s <span class=p>|</span> upper <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>python: <span class=o>{{</span> .python <span class=p>|</span> repeat <span class=m>3</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>release: <span class=o>{{</span> .var1 <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><p>在with语句块内添加了一个<code>.var1</code>对象，但这个模板是错误的，编译的时候会失败，这是因为<code>.var1</code>不在该<code>with</code>语句块限制的作用范围之内，我们可以将该对象赋值给一个变量可以来解决这个问题</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- <span class=nv>$var1</span> :<span class=o>=</span> .Release.Name -<span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- with .Values.course <span class=o>}}</span>
</span></span><span class=line><span class=cl>  k8s: <span class=o>{{</span> .k8s <span class=p>|</span> upper <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  python: <span class=o>{{</span> .python <span class=p>|</span> repeat <span class=m>3</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  release: <span class=o>{{</span> <span class=nv>$var1</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><h4 id=命名模板>命名模板<a hidden class=anchor aria-hidden=true href=#命名模板>#</a></h4><p>命名模板我们也可以称为子模板，是限定在一个文件内部的模板，然后给一个名称。在使用命名模板的时候有一个需要特别注意的是：模板名称是全局的，如果我们声明了两个相同名称的模板，最后加载的一个模板会覆盖掉另外的模板，由于子 chart 中的模板也是和顶层的模板一起编译的，所以在命名的时候一定要注意，不要重名了。</p><p>为了避免重名，有个通用的约定就是为每个定义的模板添加上 chart 名称：<code>{{define "mychart.labels"}}</code>，<code>define</code>关键字就是用来声明命名模板的，加上 chart 名称就可以避免不同 chart 间的模板出现冲突的情况。</p><p>结构:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span> define <span class=s2>&#34;ChartName.TplName&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=c1># 模板内容区域</span>
</span></span><span class=line><span class=cl><span class=o>{{</span> end <span class=o>}}</span>
</span></span></code></pre></div><p>可以将该模板嵌入到现有的 ConfigMap 中，然后使用<code>template</code>关键字在需要的地方包含进来即可:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span>- define <span class=s2>&#34;mychart.labels&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    from: helm
</span></span><span class=line><span class=cl>    date: <span class=o>{{</span> now <span class=p>|</span> htmlDate <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- end <span class=o>}}</span>
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- template <span class=s2>&#34;mychart.labels&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- range <span class=nv>$key</span>, <span class=nv>$value</span> :<span class=o>=</span> .Values.course <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span> <span class=nv>$key</span> <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$value</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><p>在创建 chart 包的时候，templates 目录下面默认会生成一个<code>_helpers.tpl</code>文件吗？我们前面也提到过 templates 目录下面除了<code>NOTES.txt</code>文件和以下划线_开头命令的文件之外，都会被当做 kubernetes 的资源清单文件，而这个下划线开头的文件不会被当做资源清单外，还可以被其他 chart 模板中调用，这个就是 Helm 中的 partials 文件，所以其实我们完全就可以将命名模板定义在这些 partials 文件中，默认就是<code>_helpers.tpl</code>文件了</p><p>将上面定义的命名模板移动到 templates/_helpers.tpl 文件中去:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span>/* 生成基本的 labels 标签 */<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- define <span class=s2>&#34;mychart.labels&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    from: helm
</span></span><span class=line><span class=cl>    date: <span class=o>{{</span> now <span class=p>|</span> htmlDate <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><h4 id=模板范围>模板范围<a hidden class=anchor aria-hidden=true href=#模板范围>#</a></h4><p>我们在里面来使用 chart 对象相关信息：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span>/* 生成基本的 labels 标签 */<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- define <span class=s2>&#34;mychart.labels&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    from: helm
</span></span><span class=line><span class=cl>    date: <span class=o>{{</span> now <span class=p>|</span> htmlDate <span class=o>}}</span>
</span></span><span class=line><span class=cl>    chart: <span class=o>{{</span> .Chart.Name <span class=o>}}</span>
</span></span><span class=line><span class=cl>    version: <span class=o>{{</span> .Chart.Version <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><p>如果这样的直接进行渲染测试的话，是不会得到我们的预期结果的</p><p>chart 的名称和版本都没有正确被渲染，这是因为他们不在我们定义的模板范围内，当命名模板被渲染时，它会接收由 template 调用时传入的作用域，由于我们这里并没有传入对应的作用域，因此模板中我们无法调用到 .Chart 对象，要解决也非常简单，我们只需要在 template 后面加上作用域范围即可:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- template <span class=s2>&#34;mychart.labels&#34;</span> . <span class=o>}}</span>
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- range <span class=nv>$key</span>, <span class=nv>$value</span> :<span class=o>=</span> .Values.course <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span> <span class=nv>$key</span> <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$value</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><p>我们在 template 末尾传递了<code>.</code>，表示当前的最顶层的作用范围，如果我们想要在命名模板中使用<code>.Values</code>范围内的数据，当然也是可以的</p><h4 id=include函数>include函数<a hidden class=anchor aria-hidden=true href=#include函数>#</a></h4><p>将上面的定义的 labels 单独提取出来放置到 _helpers.tpl 文件中:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{{</span>/* 生成基本的 labels 标签 */<span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- define <span class=s2>&#34;mychart.labels&#34;</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>from: helm
</span></span><span class=line><span class=cl>date: <span class=o>{{</span> now <span class=p>|</span> htmlDate <span class=o>}}</span>
</span></span><span class=line><span class=cl>chart: <span class=o>{{</span> .Chart.Name <span class=o>}}</span>
</span></span><span class=line><span class=cl>version: <span class=o>{{</span> .Chart.Version <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- end <span class=o>}}</span>
</span></span></code></pre></div><p>将该命名模板插入到 configmap 模板文件的 labels 部分和 data 部分:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    <span class=o>{{</span>- template <span class=s2>&#34;mychart.labels&#34;</span> . <span class=o>}}</span>
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- range <span class=nv>$key</span>, <span class=nv>$value</span> :<span class=o>=</span> .Values.course <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span> <span class=nv>$key</span> <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$value</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- template <span class=s2>&#34;mychart.labels&#34;</span> . <span class=o>}}</span>
</span></span></code></pre></div><p>渲染后：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># Source: mychart/templates/configmap.yaml</span>
</span></span><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: altered-wombat-configmap
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>from: helm
</span></span><span class=line><span class=cl>date: 2018-09-22
</span></span><span class=line><span class=cl>chart: mychart
</span></span><span class=line><span class=cl>version: 0.1.0
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  k8s: <span class=s2>&#34;devops&#34;</span>
</span></span><span class=line><span class=cl>  python: <span class=s2>&#34;django&#34;</span>
</span></span><span class=line><span class=cl>from: helm
</span></span><span class=line><span class=cl>date: 2018-09-22
</span></span><span class=line><span class=cl>chart: mychart
</span></span><span class=line><span class=cl>version: 0.1.0
</span></span></code></pre></div><p>可以看到渲染结果是有问题的，不是一个正常的 YAML 文件格式，这是因为template只是表示一个嵌入动作而已，不是一个函数，所以原本命名模板中是怎样的格式就是怎样的格式被嵌入进来了</p><p>为了解决这个问题，Helm 提供了另外一个方案来代替template，那就是使用include函数，在需要控制空格的地方使用indent管道函数来自己控制</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: ConfigMap
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-configmap
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl><span class=o>{{</span>- include <span class=s2>&#34;mychart.labels&#34;</span> . <span class=p>|</span> indent <span class=m>4</span> <span class=o>}}</span>
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- range <span class=nv>$key</span>, <span class=nv>$value</span> :<span class=o>=</span> .Values.course <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span> <span class=nv>$key</span> <span class=o>}}</span>: <span class=o>{{</span> <span class=nv>$value</span> <span class=p>|</span> quote <span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>{{</span>- end <span class=o>}}</span>
</span></span><span class=line><span class=cl><span class=o>{{</span>- include <span class=s2>&#34;mychart.labels&#34;</span> . <span class=p>|</span> indent <span class=m>2</span> <span class=o>}}</span>
</span></span></code></pre></div><p>可以看到不管是 <code>template</code> 或 <code>include</code> 都不会因为在引用模板文件时隔了几个空格就导致引入的内容隔几个空格，还是需要使用 <code>include</code> 引入，并使用 <code>indent</code> 控制空格</p><h4 id=notestxt文件>NOTES.txt文件<a hidden class=anchor aria-hidden=true href=#notestxt文件>#</a></h4><p>我们前面在使用 <code>helm install</code> 命令的时候，Helm 都会为我们打印出一大堆介绍信息，这样当别的用户在使用我们的 chart 包的时候就可以根据这些注释信息快速了解我们的 chart 包的使用方法，这些信息就是编写在 <code>NOTES.txt</code> 文件之中的，这个文件是纯文本的，但是它和其他模板一样，具有所有可用的普通模板函数和对象</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>Thank you <span class=k>for</span> installing <span class=o>{{</span> .Chart.Name <span class=o>}}</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Your release is named <span class=o>{{</span> .Release.Name <span class=o>}}</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>To learn more about the release, try:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  $ helm status <span class=o>{{</span> .Release.Name <span class=o>}}</span>
</span></span><span class=line><span class=cl>  $ helm get <span class=o>{{</span> .Release.Name <span class=o>}}</span>
</span></span></code></pre></div><h4 id=子chart包>子chart包<a hidden class=anchor aria-hidden=true href=#子chart包>#</a></h4><p>在创建 mychart 包的时候，在根目录下面有一个空文件夹 charts 目录吗？这就是我们的子 chart 所在的目录，在该目录下面添加一个新的 chart</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> chart
</span></span><span class=line><span class=cl>helm create subchart
</span></span></code></pre></div><h5 id=值覆盖>值覆盖<a hidden class=anchor aria-hidden=true href=#值覆盖>#</a></h5><p>删除子 chart template 下的所有文件，并创建一个 ConfigMap 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>metadat:
</span></span><span class=line><span class=cl>  name: <span class=o>{{</span> .Release.Name <span class=o>}}</span>-cm
</span></span><span class=line><span class=cl>data:
</span></span><span class=line><span class=cl>  in: <span class=o>{{</span> .Values.in <span class=o>}}</span>
</span></span></code></pre></div><p>修改子<code>chart</code>的<code>values.yaml</code>文件：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>in: subchart
</span></span></code></pre></div><p>现在 subchart 这个子 chart 就属于 mychart 这个父 chart 了，由于 mychart 是父级，所以我们可以在 mychart 的 values.yaml 文件中直接配置子 chart 中的值，比如我们可以在 mychart/values.yaml 文件中添加上子 chart 的值</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>subchart:
</span></span><span class=line><span class=cl>  in: parent
</span></span></code></pre></div><p>子 chart 中的值已经被顶层的值给覆盖了。但是在某些场景下面我们还是希望某些值在所有模板中都可以使用，这就需要用到全局 chart 值了</p><p><strong>!!!注意这里父 chart 要覆盖子 chart 中的值，在父 chart 的 <code>values.yaml</code> 中定义值时必须指定子 chart 的名字,如这里的 <code>subchart.in</code>的值仅能替换名为<code>subchart</code>的 chart 中定义的 <code>in</code>的值</strong></p><h5 id=全局值>全局值<a hidden class=anchor aria-hidden=true href=#全局值>#</a></h5><p>全局值可以从任何 chart 或者子 chart中进行访问使用，values 对象中有一个保留的属性是<code>Values.global</code>，就可以被用来设置全局值,比如我们在父 chart 的 values.yaml 文件中添加一个全局值:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>global:
</span></span><span class=line><span class=cl>  allin: helm
</span></span></code></pre></div><p>在 <code>values.yaml</code> 文件中添加了一个 <code>global</code> 的属性，这样的话无论在父 chart 中还是在子 chart 中我们都可以通过<code>{{ .Values.global.allin }}</code>来访问这个全局值了</p><p>如果 <code>global</code>中同名的值既在父 chart 中设置了也在子 chart 中设置了，那么会以父 chart 中的为准，如果只在子 chart 中设置了，那么子 chart 中可以引用，父 chart 中不可引用</p><h2 id=package>package<a hidden class=anchor aria-hidden=true href=#package>#</a></h2><blockquote><p>打包本地 chart 为 .tgz 文件</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>helm package mychart1
</span></span></code></pre></div><h2 id=hooks>Hooks<a hidden class=anchor aria-hidden=true href=#hooks>#</a></h2><p>Helm 也提供了 Hook 的机制，允许 chart 开发人员在 release 的生命周期中的某些节点来进行干预</p><p>TODO</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://moyuduo.github.io/>Moyuduo's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>